<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>BRAINBLITZ - TV Trivia</title>
<style>
  @import url('https://fonts.googleapis.com/css2?family=Orbitron:wght@400;700;900&family=Rajdhani:wght@400;500;600;700&display=swap');

  :root {
    --neon-cyan: #00f0ff;
    --neon-pink: #ff2d78;
    --neon-yellow: #ffe600;
    --neon-green: #00ff88;
    --neon-purple: #b44dff;
    --bg-dark: #0a0a1a;
    --bg-card: rgba(15, 15, 40, 0.85);
    --correct: #00ff88;
    --wrong: #ff2d78;
  }

  * { margin: 0; padding: 0; box-sizing: border-box; }

  html, body {
    width: 100%; height: 100%;
    min-width: 100vw; min-height: 100vh;
    overflow: hidden;
    background: var(--bg-dark);
    font-family: 'Rajdhani', sans-serif;
    color: #fff;
    cursor: none;
    margin: 0; padding: 0;
  }

  /* Custom large cursor for TV pointer */
  body.show-cursor { cursor: default; }

  /* ─── BACKGROUND ─── */
  .bg-grid {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    background-image:
      linear-gradient(rgba(0,240,255,0.03) 1px, transparent 1px),
      linear-gradient(90deg, rgba(0,240,255,0.03) 1px, transparent 1px);
    background-size: 60px 60px;
    z-index: 0;
  }
  .bg-glow {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(0,240,255,0.08) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 100%, rgba(255,45,120,0.06) 0%, transparent 50%);
  }

  /* ─── SCREENS ─── */
  .screen {
    position: absolute; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 1;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    padding: 40px;
    opacity: 0;
    pointer-events: none;
    width: 100%; height: 100%;
    transform: translateY(12px) scale(0.99);
    transition: opacity 0.2s ease, transform 0.2s ease;
    will-change: opacity, transform;
  }
  .screen.active {
    opacity: 1;
    pointer-events: all;
    transform: translateY(0) scale(1);
  }
  .screen.screen-leaving {
    opacity: 0;
    transform: translateY(0) scale(0.98);
    transition: opacity 0.15s ease, transform 0.15s ease;
    pointer-events: none;
  }

  /* ─── TITLE SCREEN ─── */
  .title-logo {
    font-family: 'Orbitron', monospace;
    font-size: clamp(60px, 8vw, 120px);
    font-weight: 900;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink), var(--neon-yellow));
    background-size: 200% 200%;
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    animation: gradientShift 4s ease infinite;
    text-shadow: none;
    filter: drop-shadow(0 0 30px rgba(0,240,255,0.3));
    margin-bottom: 10px;
  }
  @keyframes gradientShift {
    0%,100% { background-position: 0% 50%; }
    50% { background-position: 100% 50%; }
  }

  .title-sub {
    font-family: 'Orbitron', monospace;
    font-size: clamp(16px, 2vw, 28px);
    color: rgba(255,255,255,0.4);
    letter-spacing: 0.5em;
    text-transform: uppercase;
    margin-bottom: 60px;
  }

  /* ─── BUTTONS ─── */
  .btn {
    font-family: 'Orbitron', monospace;
    font-size: clamp(18px, 2.2vw, 28px);
    font-weight: 700;
    padding: 20px 60px;
    border: 2px solid var(--neon-cyan);
    background: rgba(0,240,255,0.05);
    color: var(--neon-cyan);
    cursor: pointer;
    text-transform: uppercase;
    letter-spacing: 0.15em;
    transition: all 0.25s ease;
    position: relative;
    overflow: hidden;
    min-width: 280px;
    text-align: center;
  }
  .btn:hover, .btn:focus {
    background: rgba(0,240,255,0.15);
    box-shadow: 0 0 15px rgba(0,240,255,0.3), inset 0 0 15px rgba(0,240,255,0.1);
    transform: scale(1.05);
    outline: none;
  }
  .btn:active {
    transform: scale(0.97);
  }
  .btn.pink {
    border-color: var(--neon-pink);
    color: var(--neon-pink);
    background: rgba(255,45,120,0.05);
  }
  .btn.pink:hover, .btn.pink:focus {
    background: rgba(255,45,120,0.15);
    box-shadow: 0 0 15px rgba(255,45,120,0.3), inset 0 0 15px rgba(255,45,120,0.1);
  }

  .btn-group {
    display: flex; flex-direction: column; gap: 20px;
    align-items: center;
  }

  /* ─── SETTINGS SCREEN ─── */
  .settings-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 40px 80px;
    max-width: 900px;
    width: 100%;
    margin-bottom: 50px;
  }
  .setting-group label {
    display: block;
    font-family: 'Orbitron', monospace;
    font-size: clamp(14px, 1.5vw, 20px);
    color: var(--neon-cyan);
    letter-spacing: 0.1em;
    text-transform: uppercase;
    margin-bottom: 16px;
  }
  .pill-group {
    display: flex; gap: 12px; flex-wrap: wrap;
  }
  .pill {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(16px, 1.8vw, 22px);
    font-weight: 600;
    padding: 12px 28px;
    border: 1.5px solid rgba(255,255,255,0.15);
    background: rgba(255,255,255,0.03);
    color: rgba(255,255,255,0.5);
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .pill:hover {
    border-color: rgba(255,255,255,0.4);
    color: rgba(255,255,255,0.8);
  }
  .pill.selected {
    border-color: var(--neon-cyan);
    color: var(--neon-cyan);
    background: rgba(0,240,255,0.1);
    box-shadow: 0 0 15px rgba(0,240,255,0.15);
    transform: scale(1.05);
  }

  /* ─── GAME SCREEN ─── */
  .game-hud {
    display: flex;
    justify-content: space-between;
    align-items: center;
    width: 100%;
    max-width: 1200px;
    padding: 0 20px;
    margin-bottom: 20px;
  }
  .hud-item {
    text-align: center;
    position: relative;
    padding: 8px 12px;
  }
  .hud-label {
    font-family: 'Orbitron', monospace;
    font-size: clamp(14px, 1.5vw, 20px);
    color: rgba(255,255,255,0.35);
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }
  .hud-value {
    font-family: 'Orbitron', monospace;
    font-size: clamp(28px, 3.5vw, 48px);
    font-weight: 900;
    color: var(--neon-cyan);
  }
  .hud-value.streak { color: var(--neon-yellow); }
  .hud-value.score { color: var(--neon-pink); }
  .hud-value.score-pop {
    animation: scorePop 0.35s ease;
  }
  @keyframes scorePop {
    0% { transform: scale(1); }
    40% { transform: scale(1.3); filter: brightness(1.5); }
    100% { transform: scale(1); }
  }

  /* TTS speaker loading pulse */
  .hud-speaker.loading {
    animation: speakerPulse 0.6s ease infinite;
  }
  @keyframes speakerPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.3; }
  }

  /* Active turn indicator */
  .hud-item.active-turn::after {
    content: '';
    position: absolute;
    top: -4px; left: -4px; right: -4px; bottom: -4px;
    border: 2px solid var(--neon-cyan);
    border-radius: 8px;
    animation: turnPulse 1.5s ease infinite;
    pointer-events: none;
  }
  .hud-item.active-turn.stu-turn::after {
    border-color: var(--neon-pink);
    box-shadow: 0 0 15px rgba(255,45,120,0.3);
  }
  @keyframes turnPulse {
    0%, 100% { opacity: 0.3; box-shadow: 0 0 10px rgba(0,240,255,0.1); }
    50% { opacity: 1; box-shadow: 0 0 25px rgba(0,240,255,0.4); }
  }

  /* Speaker icon */
  .hud-speaker {
    font-size: clamp(14px, 1.5vw, 20px);
    margin-left: 8px;
    vertical-align: middle;
    opacity: 0.5;
  }

  /* Timer bar */
  .timer-track {
    width: 100%;
    max-width: 1200px;
    height: 8px;
    background: rgba(255,255,255,0.08);
    margin-bottom: 40px;
    overflow: hidden;
    position: relative;
  }
  .timer-fill {
    height: 100%;
    width: 100%;
    background: linear-gradient(90deg, var(--neon-cyan), var(--neon-green));
    box-shadow: 0 0 20px rgba(0,240,255,0.4);
    transform-origin: left center;
    will-change: transform;
    /* CSS animation drives the shrink — set dynamically via JS */
  }
  .timer-fill.timer-running {
    animation: timerShrink var(--timer-duration, 15s) linear forwards;
  }
  @keyframes timerShrink {
    from { transform: scaleX(1); }
    to { transform: scaleX(0); }
  }
  .timer-fill.danger {
    background: linear-gradient(90deg, var(--neon-pink), var(--neon-yellow));
    box-shadow: 0 0 20px rgba(255,45,120,0.4);
  }
  .timer-fill.timer-pulse {
    animation: timerShrink var(--timer-duration, 15s) linear forwards, timerPulse 0.5s ease infinite;
  }
  .timer-fill.timer-pulse-tense {
    animation: timerShrink var(--timer-duration, 15s) linear forwards, timerPulse 0.25s ease infinite;
  }
  @keyframes timerPulse {
    0%, 100% { opacity: 1; }
    50% { opacity: 0.6; }
  }

  /* Category badge */
  .category-badge {
    font-family: 'Orbitron', monospace;
    font-size: clamp(16px, 1.8vw, 24px);
    color: rgba(255,255,255,0.3);
    letter-spacing: 0.25em;
    text-transform: uppercase;
    margin-bottom: 16px;
  }

  /* Question */
  .question-text {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(28px, 3.8vw, 56px);
    font-weight: 700;
    text-align: center;
    max-width: 1100px;
    line-height: 1.2;
    margin-bottom: 50px;
    color: #fff;
    text-shadow: 0 0 40px rgba(255,255,255,0.1);
  }

  /* Answer grid */
  .answers-grid {
    display: grid;
    grid-template-columns: 1fr 1fr;
    gap: 20px;
    width: 100%;
    max-width: 1100px;
  }
  .answer-btn {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(20px, 2.5vw, 34px);
    font-weight: 600;
    padding: 24px 30px;
    border: 2px solid rgba(255,255,255,0.12);
    background: var(--bg-card);
    color: rgba(255,255,255,0.85);
    cursor: pointer;
    transition: all 0.2s ease;
    display: flex;
    align-items: center;
    gap: 20px;
    text-align: left;
    position: relative;
    overflow: hidden;
    backdrop-filter: blur(10px);
  }
  .answer-btn .letter {
    font-family: 'Orbitron', monospace;
    font-size: clamp(16px, 1.8vw, 24px);
    font-weight: 900;
    color: var(--neon-cyan);
    min-width: 44px;
    height: 44px;
    display: flex; align-items: center; justify-content: center;
    border: 2px solid var(--neon-cyan);
    flex-shrink: 0;
  }
  .answer-btn:hover, .answer-btn:focus {
    border-color: var(--neon-cyan);
    background: rgba(0,240,255,0.08);
    transform: scale(1.02);
    box-shadow: 0 0 25px rgba(0,240,255,0.15);
    outline: none;
  }
  .answer-btn.correct {
    border-color: var(--correct) !important;
    background: rgba(0,255,136,0.15) !important;
    box-shadow: 0 0 40px rgba(0,255,136,0.3);
  }
  .answer-btn.correct .letter {
    border-color: var(--correct);
    color: var(--correct);
    background: rgba(0,255,136,0.2);
  }
  .answer-btn.wrong {
    border-color: var(--wrong) !important;
    background: rgba(255,45,120,0.15) !important;
    box-shadow: 0 0 40px rgba(255,45,120,0.3);
  }
  .answer-btn.wrong .letter {
    border-color: var(--wrong);
    color: var(--wrong);
    background: rgba(255,45,120,0.2);
  }
  .answer-btn.disabled {
    pointer-events: none;
    opacity: 0.4;
  }

  /* Enhanced answer animations */
  .answer-btn.pulse-correct {
    animation: pulseGlow 0.6s ease;
  }
  @keyframes pulseGlow {
    0% { transform: scale(1); }
    30% { transform: scale(1.05); box-shadow: 0 0 50px rgba(0,255,136,0.6); }
    100% { transform: scale(1); }
  }
  .answer-btn.shake-wrong {
    animation: shake 0.5s ease;
  }
  @keyframes shake {
    0%, 100% { transform: translateX(0); }
    20% { transform: translateX(-10px); }
    40% { transform: translateX(10px); }
    60% { transform: translateX(-6px); }
    80% { transform: translateX(6px); }
  }
  .answer-btn.dimmed {
    opacity: 0.2;
    transform: scale(0.97);
    transition: all 0.4s ease;
    pointer-events: none;
  }

  /* ─── FEEDBACK OVERLAY ─── */
  .feedback-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0; z-index: 10;
    display: flex; align-items: center; justify-content: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .feedback-overlay.show { opacity: 1; }
  .feedback-text {
    font-family: 'Orbitron', monospace;
    font-size: clamp(50px, 8vw, 120px);
    font-weight: 900;
    text-transform: uppercase;
    animation: feedbackPop 0.6s ease forwards;
  }
  .feedback-text.correct-fb {
    color: var(--correct);
    text-shadow: 0 0 60px rgba(0,255,136,0.5);
  }
  .feedback-text.wrong-fb {
    color: var(--wrong);
    text-shadow: 0 0 60px rgba(255,45,120,0.5);
  }
  .feedback-text.timeout-fb {
    color: var(--neon-yellow);
    text-shadow: 0 0 60px rgba(255,230,0,0.5);
  }
  @keyframes feedbackPop {
    0% { transform: scale(0.3); opacity: 0; }
    50% { transform: scale(1.15); opacity: 1; }
    100% { transform: scale(1); opacity: 1; }
  }

  /* Bonus points popup */
  .bonus-popup {
    position: fixed;
    top: 50%; left: 50%;
    transform: translate(-50%, 20px);
    font-family: 'Orbitron', monospace;
    font-size: clamp(20px, 3vw, 36px);
    font-weight: 700;
    color: var(--neon-yellow);
    text-shadow: 0 0 20px rgba(255,230,0,0.5);
    opacity: 0;
    z-index: 11;
    pointer-events: none;
    transition: all 0.8s ease;
  }
  .bonus-popup.show {
    opacity: 1;
    transform: translate(-50%, -20px);
  }

  /* ─── RESULTS SCREEN ─── */
  .results-score {
    font-family: 'Orbitron', monospace;
    font-size: clamp(60px, 10vw, 140px);
    font-weight: 900;
    background: linear-gradient(135deg, var(--neon-cyan), var(--neon-pink));
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
    background-clip: text;
    filter: drop-shadow(0 0 30px rgba(0,240,255,0.3));
    margin-bottom: 10px;
  }
  .results-label {
    font-family: 'Orbitron', monospace;
    font-size: clamp(14px, 1.5vw, 22px);
    color: rgba(255,255,255,0.35);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-bottom: 40px;
  }
  .stats-row {
    display: flex; gap: 60px;
    margin-bottom: 50px;
  }
  .stat-item {
    text-align: center;
  }
  .stat-value {
    font-family: 'Orbitron', monospace;
    font-size: clamp(30px, 4vw, 50px);
    font-weight: 900;
    color: var(--neon-cyan);
  }
  .stat-label {
    font-family: 'Orbitron', monospace;
    font-size: clamp(14px, 1.3vw, 18px);
    color: rgba(255,255,255,0.35);
    letter-spacing: 0.2em;
    text-transform: uppercase;
  }
  .rank-text {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(22px, 2.5vw, 36px);
    font-weight: 700;
    color: var(--neon-yellow);
    margin-bottom: 40px;
  }

  /* Result column winner/loser styles */
  .result-column { transition: all 0.5s ease; }
  .winner-column {
    animation: winnerGlow 1.5s ease infinite;
  }
  .winner-column .results-score {
    background: linear-gradient(135deg, #ffd700, #ffaa00, #ffd700) !important;
    -webkit-background-clip: text !important;
    -webkit-text-fill-color: transparent !important;
    background-clip: text !important;
  }
  @keyframes winnerGlow {
    0%, 100% { filter: drop-shadow(0 0 10px rgba(255,230,0,0.3)); }
    50% { filter: drop-shadow(0 0 30px rgba(255,230,0,0.6)); }
  }
  .loser-column { opacity: 0.55; }

  /* Trophy animation */
  .trophy-icon {
    font-size: clamp(40px, 6vw, 80px);
    animation: trophyBounce 0.8s ease infinite;
    display: none;
  }
  @keyframes trophyBounce {
    0%, 100% { transform: scale(1) rotate(0deg); }
    50% { transform: scale(1.15) rotate(5deg); }
  }

  /* ─── CONFETTI ─── */
  .confetti-container {
    position: fixed;
    top: 0; left: 0; right: 0; bottom: 0;
    pointer-events: none;
    z-index: 15;
    overflow: hidden;
  }
  .confetti-piece {
    position: absolute;
    top: -20px;
    width: 10px;
    height: 10px;
    animation: confettiFall linear forwards;
  }
  @keyframes confettiFall {
    0% { transform: translateY(0) rotate(0deg); opacity: 1; }
    100% { transform: translateY(100vh) rotate(720deg); opacity: 0; }
  }

  /* ─── PARTICLES ─── */
  .particle {
    position: fixed;
    width: 4px; height: 4px;
    background: var(--neon-cyan);
    border-radius: 50%;
    pointer-events: none;
    z-index: 5;
    opacity: 0;
  }

  /* ─── ROUND INDICATOR ─── */
  .round-splash {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 10;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(10,10,26,0.9);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.4s ease;
  }
  .round-splash.show {
    opacity: 1;
  }
  .round-number {
    font-family: 'Orbitron', monospace;
    font-size: clamp(80px, 12vw, 160px);
    font-weight: 900;
    color: var(--neon-cyan);
    text-shadow: 0 0 60px rgba(0,240,255,0.4);
    animation: feedbackPop 0.6s ease forwards;
  }
  .round-label {
    font-family: 'Orbitron', monospace;
    font-size: clamp(16px, 2vw, 28px);
    color: rgba(255,255,255,0.3);
    letter-spacing: 0.4em;
    text-transform: uppercase;
  }

  /* ─── TURN SWITCH OVERLAY ─── */
  .turn-switch {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 10;
    display: flex; flex-direction: column;
    align-items: center; justify-content: center;
    background: rgba(10,10,26,0.92);
    opacity: 0;
    pointer-events: none;
    transition: opacity 0.3s ease;
  }
  .turn-switch.show { opacity: 1; }
  .turn-switch-name {
    font-family: 'Orbitron', monospace;
    font-size: clamp(40px, 6vw, 80px);
    font-weight: 900;
    letter-spacing: 0.1em;
    margin-bottom: 10px;
  }
  .turn-switch-label {
    font-family: 'Orbitron', monospace;
    font-size: clamp(18px, 2.5vw, 32px);
    color: rgba(255,255,255,0.5);
    letter-spacing: 0.3em;
    text-transform: uppercase;
    margin-bottom: 30px;
  }
  .turn-switch-countdown {
    font-family: 'Orbitron', monospace;
    font-size: clamp(60px, 10vw, 120px);
    font-weight: 900;
    color: var(--neon-yellow);
    text-shadow: 0 0 40px rgba(255,230,0,0.4);
  }

  /* ─── ERROR SCREEN ─── */
  .error-icon {
    font-size: clamp(50px, 8vw, 100px);
    margin-bottom: 20px;
  }
  .error-message {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(18px, 2.2vw, 28px);
    color: rgba(255,255,255,0.6);
    text-align: center;
    max-width: 600px;
    margin-bottom: 40px;
    line-height: 1.5;
  }

  /* ─── LEADERBOARD SCREEN ─── */
  .lb-columns {
    display: flex;
    gap: 80px;
    margin-bottom: 40px;
  }
  .lb-column {
    text-align: center;
    min-width: 220px;
  }
  .lb-name {
    font-family: 'Orbitron', monospace;
    font-size: clamp(20px, 2.5vw, 32px);
    font-weight: 700;
    margin-bottom: 24px;
  }
  .lb-stat {
    margin-bottom: 16px;
  }
  .lb-val {
    font-family: 'Orbitron', monospace;
    font-size: clamp(24px, 3vw, 36px);
    font-weight: 900;
    color: var(--neon-cyan);
    display: block;
  }
  .lb-label {
    font-family: 'Orbitron', monospace;
    font-size: clamp(12px, 1.2vw, 16px);
    color: rgba(255,255,255,0.35);
    letter-spacing: 0.15em;
    text-transform: uppercase;
  }
  .lb-no-data {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(16px, 2vw, 24px);
    color: rgba(255,255,255,0.3);
    margin-bottom: 40px;
  }

  /* ─── STREAK CELEBRATION (5+ streak) ─── */
  @keyframes streakBorderGlow {
    0% { box-shadow: inset 0 0 30px rgba(255,215,0,0.4), 0 0 40px rgba(255,215,0,0.2); }
    25% { box-shadow: inset 0 0 30px rgba(255,45,120,0.4), 0 0 40px rgba(255,45,120,0.2); }
    50% { box-shadow: inset 0 0 30px rgba(0,240,255,0.4), 0 0 40px rgba(0,240,255,0.2); }
    75% { box-shadow: inset 0 0 30px rgba(0,255,136,0.4), 0 0 40px rgba(0,255,136,0.2); }
    100% { box-shadow: inset 0 0 30px rgba(255,215,0,0.4), 0 0 40px rgba(255,215,0,0.2); }
  }
  .streak-fire-border {
    animation: streakBorderGlow 2s linear infinite;
    border: 3px solid rgba(255,215,0,0.5);
  }

  /* ON FIRE overlay */
  .on-fire-overlay {
    position: fixed; top: 0; left: 0; right: 0; bottom: 0;
    z-index: 12;
    display: flex; align-items: center; justify-content: center;
    pointer-events: none;
    opacity: 0;
    transition: opacity 0.3s ease;
  }
  .on-fire-overlay.show { opacity: 1; }
  .on-fire-text {
    font-family: 'Orbitron', monospace;
    font-size: clamp(60px, 10vw, 140px);
    font-weight: 900;
    text-transform: uppercase;
    color: #ffd700;
    text-shadow: 0 0 40px rgba(255,215,0,0.6), 0 0 80px rgba(255,100,0,0.4);
    animation: onFirePop 1s ease forwards;
  }
  @keyframes onFirePop {
    0% { transform: scale(0.3) rotate(-5deg); opacity: 0; }
    30% { transform: scale(1.2) rotate(2deg); opacity: 1; }
    60% { transform: scale(0.95) rotate(-1deg); opacity: 1; }
    100% { transform: scale(1) rotate(0deg); opacity: 0; }
  }

  /* Streak bonus emphasis in popup */
  .bonus-popup.streak-fire {
    color: #ffd700;
    text-shadow: 0 0 30px rgba(255,215,0,0.6), 0 0 60px rgba(255,100,0,0.3);
    font-size: clamp(24px, 3.5vw, 44px);
  }

  /* ─── CLOSE GAME TENSION ─── */
  .bg-glow.tense {
    background: radial-gradient(ellipse at 50% 0%, rgba(255,80,0,0.12) 0%, transparent 60%),
                radial-gradient(ellipse at 80% 100%, rgba(255,45,120,0.10) 0%, transparent 50%);
    transition: background 1s ease;
  }
  .hud-value.score.score-tense {
    animation: tensePulse 1s ease infinite;
  }
  @keyframes tensePulse {
    0%, 100% { text-shadow: 0 0 10px rgba(255,100,0,0.3); }
    50% { text-shadow: 0 0 25px rgba(255,100,0,0.7), 0 0 50px rgba(255,45,120,0.3); }
  }

  /* Responsive for smaller screens */
  @media (max-width: 800px) {
    .answers-grid { grid-template-columns: 1fr; }
    .settings-grid { grid-template-columns: 1fr; gap: 30px; }
    .stats-row { gap: 30px; }
    .lb-columns { flex-direction: column; gap: 40px; }
  }

  /* ─── DIFFICULTY INDICATOR ─── */
  .difficulty-badge {
    font-family: 'Orbitron', monospace;
    font-size: clamp(12px, 1.3vw, 18px);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    padding: 4px 14px;
    border-radius: 4px;
    display: inline-block;
  }
  .difficulty-badge.diff-easy {
    color: var(--neon-green);
    border: 1px solid rgba(0,255,136,0.3);
    background: rgba(0,255,136,0.08);
  }
  .difficulty-badge.diff-medium {
    color: var(--neon-yellow);
    border: 1px solid rgba(255,230,0,0.3);
    background: rgba(255,230,0,0.08);
  }
  .difficulty-badge.diff-hard {
    color: var(--neon-pink);
    border: 1px solid rgba(255,45,120,0.3);
    background: rgba(255,45,120,0.08);
  }
  .difficulty-stars {
    font-size: clamp(14px, 1.5vw, 22px);
    margin-left: 6px;
  }

  /* ─── CASCADE ANIMATION HELPERS ─── */
  .answer-btn.cascade-hide {
    opacity: 1;
    transition: none;
  }
  .answer-btn.cascade-dim {
    opacity: 0.2;
    transform: scale(0.97);
    transition: opacity 0.2s ease, transform 0.2s ease;
    pointer-events: none;
  }
  .answer-btn.cascade-correct {
    border-color: var(--correct) !important;
    background: rgba(0,255,136,0.15) !important;
    box-shadow: 0 0 40px rgba(0,255,136,0.3);
    transition: all 0.2s ease;
  }
  .answer-btn.cascade-correct .letter {
    border-color: var(--correct);
    color: var(--correct);
    background: rgba(0,255,136,0.2);
  }

  /* Focus visible for remote/keyboard nav */
  *:focus-visible {
    outline: 3px solid var(--neon-cyan);
    outline-offset: 4px;
  }

  /* Loading spinner */
  .loading-ring {
    width: 60px; height: 60px;
    border: 4px solid rgba(0,240,255,0.1);
    border-top-color: var(--neon-cyan);
    border-radius: 50%;
    animation: spin 0.8s linear infinite;
  }
  @keyframes spin { to { transform: rotate(360deg); } }

  /* ─── MUSIC MUTE TOGGLE ─── */
  .music-toggle {
    position: fixed;
    bottom: 20px;
    right: 20px;
    z-index: 20;
    background: rgba(15, 15, 40, 0.85);
    border: 1px solid rgba(0, 240, 255, 0.3);
    color: var(--neon-cyan);
    font-size: 22px;
    width: 48px;
    height: 48px;
    border-radius: 50%;
    cursor: pointer;
    display: flex;
    align-items: center;
    justify-content: center;
    transition: all 0.2s ease;
    backdrop-filter: blur(5px);
  }
  .music-toggle:hover, .music-toggle:focus {
    border-color: var(--neon-cyan);
    box-shadow: 0 0 15px rgba(0, 240, 255, 0.3);
    outline: none;
  }
  .music-toggle.muted {
    color: rgba(255, 255, 255, 0.25);
    border-color: rgba(255, 255, 255, 0.1);
  }

  .screen-title {
    font-family: 'Orbitron', monospace;
    font-size: clamp(24px, 3vw, 40px);
    font-weight: 700;
    color: var(--neon-cyan);
    letter-spacing: 0.1em;
    margin-bottom: 40px;
  }

  /* ─── ACHIEVEMENT TOAST ─── */
  .achievement-toast-container {
    position: fixed;
    bottom: 30px;
    left: 50%;
    transform: translateX(-50%);
    z-index: 100;
    display: flex;
    flex-direction: column-reverse;
    gap: 12px;
    align-items: center;
    pointer-events: none;
  }
  .achievement-toast {
    background: rgba(15, 15, 40, 0.95);
    border: 2px solid var(--neon-yellow);
    padding: 16px 32px;
    display: flex;
    align-items: center;
    gap: 16px;
    min-width: 340px;
    max-width: 550px;
    box-shadow: 0 0 30px rgba(255,230,0,0.3), inset 0 0 20px rgba(255,230,0,0.05);
    backdrop-filter: blur(10px);
    transform: translateY(120px);
    opacity: 0;
    transition: transform 0.5s cubic-bezier(0.34, 1.56, 0.64, 1), opacity 0.5s ease;
    pointer-events: auto;
  }
  .achievement-toast.show {
    transform: translateY(0);
    opacity: 1;
  }
  .achievement-toast.hide {
    transform: translateY(-30px);
    opacity: 0;
    transition: transform 0.3s ease, opacity 0.3s ease;
  }
  .achievement-toast-icon {
    font-size: 36px;
    flex-shrink: 0;
    animation: achievementBounce 0.6s ease 0.3s both;
  }
  @keyframes achievementBounce {
    0% { transform: scale(0); }
    50% { transform: scale(1.3); }
    100% { transform: scale(1); }
  }
  .achievement-toast-info {
    flex: 1;
  }
  .achievement-toast-label {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    letter-spacing: 0.3em;
    text-transform: uppercase;
    color: var(--neon-yellow);
    opacity: 0.7;
    margin-bottom: 4px;
  }
  .achievement-toast-name {
    font-family: 'Orbitron', monospace;
    font-size: clamp(14px, 1.5vw, 18px);
    font-weight: 700;
    color: var(--neon-yellow);
    text-shadow: 0 0 15px rgba(255,230,0,0.4);
    margin-bottom: 4px;
  }
  .achievement-toast-desc {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(13px, 1.3vw, 16px);
    color: rgba(255,255,255,0.6);
    line-height: 1.3;
  }

  /* ─── ACHIEVEMENTS SCREEN ─── */
  .achievements-grid {
    display: grid;
    grid-template-columns: repeat(auto-fill, minmax(240px, 1fr));
    gap: 20px;
    width: 100%;
    max-width: 1100px;
    max-height: 65vh;
    overflow-y: auto;
    padding: 10px;
    margin-bottom: 30px;
  }
  .achievements-grid::-webkit-scrollbar {
    width: 6px;
  }
  .achievements-grid::-webkit-scrollbar-track {
    background: rgba(255,255,255,0.03);
  }
  .achievements-grid::-webkit-scrollbar-thumb {
    background: rgba(0,240,255,0.2);
    border-radius: 3px;
  }
  .achievement-card {
    background: var(--bg-card);
    border: 1.5px solid rgba(255,255,255,0.08);
    padding: 20px;
    text-align: center;
    transition: all 0.3s ease;
    position: relative;
    overflow: hidden;
  }
  .achievement-card.earned {
    border-color: var(--neon-yellow);
    box-shadow: 0 0 20px rgba(255,230,0,0.15);
  }
  .achievement-card.earned::before {
    content: '';
    position: absolute;
    top: 0; left: 0; right: 0; bottom: 0;
    background: radial-gradient(ellipse at 50% 0%, rgba(255,230,0,0.06) 0%, transparent 70%);
    pointer-events: none;
  }
  .achievement-card.locked {
    opacity: 0.35;
  }
  .achievement-card-icon {
    font-size: 40px;
    margin-bottom: 10px;
    display: block;
  }
  .achievement-card.locked .achievement-card-icon {
    filter: grayscale(1);
  }
  .achievement-card-name {
    font-family: 'Orbitron', monospace;
    font-size: clamp(12px, 1.2vw, 15px);
    font-weight: 700;
    color: var(--neon-yellow);
    margin-bottom: 6px;
    letter-spacing: 0.05em;
  }
  .achievement-card.locked .achievement-card-name {
    color: rgba(255,255,255,0.4);
  }
  .achievement-card-desc {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(12px, 1.2vw, 14px);
    color: rgba(255,255,255,0.5);
    line-height: 1.3;
    margin-bottom: 8px;
  }
  .achievement-card-players {
    display: flex;
    justify-content: center;
    gap: 8px;
    margin-top: 8px;
  }
  .achievement-card-player {
    font-family: 'Orbitron', monospace;
    font-size: 10px;
    padding: 3px 10px;
    letter-spacing: 0.1em;
    text-transform: uppercase;
  }
  .achievement-card-player.burden-badge {
    color: var(--neon-cyan);
    border: 1px solid rgba(0,240,255,0.3);
    background: rgba(0,240,255,0.08);
  }
  .achievement-card-player.stu-badge {
    color: var(--neon-pink);
    border: 1px solid rgba(255,45,120,0.3);
    background: rgba(255,45,120,0.08);
  }

  /* ─── ADMIN PIN ENTRY ─── */
  .admin-gear {
    position: absolute;
    bottom: 20px;
    left: 20px;
    font-size: 28px;
    color: rgba(255,255,255,0.35);
    background: none;
    border: 1.5px solid rgba(255,255,255,0.12);
    border-radius: 50%;
    width: 52px;
    height: 52px;
    display: flex;
    align-items: center;
    justify-content: center;
    cursor: pointer;
    padding: 0;
    transition: color 0.3s ease, border-color 0.3s ease, box-shadow 0.3s ease;
    z-index: 5;
  }
  .admin-gear:hover, .admin-gear:focus {
    color: rgba(255,255,255,0.7);
    border-color: rgba(0,240,255,0.4);
    box-shadow: 0 0 15px rgba(0,240,255,0.2);
    outline: none;
  }
  .pin-entry {
    display: flex;
    flex-direction: column;
    align-items: center;
    gap: 30px;
  }
  .pin-dots {
    display: flex;
    gap: 18px;
  }
  .pin-dot {
    width: 24px;
    height: 24px;
    border: 2px solid rgba(255,255,255,0.3);
    border-radius: 50%;
    transition: all 0.2s ease;
  }
  .pin-dot.filled {
    background: var(--neon-cyan);
    border-color: var(--neon-cyan);
    box-shadow: 0 0 12px rgba(0,240,255,0.5);
  }
  .pin-dot.error {
    background: var(--neon-pink);
    border-color: var(--neon-pink);
    box-shadow: 0 0 12px rgba(255,45,120,0.5);
    animation: pinShake 0.4s ease;
  }
  @keyframes pinShake {
    0%, 100% { transform: translateX(0); }
    25% { transform: translateX(-6px); }
    75% { transform: translateX(6px); }
  }
  .pin-numpad {
    display: grid;
    grid-template-columns: repeat(3, 1fr);
    gap: 12px;
    max-width: 280px;
  }
  .pin-numpad button {
    font-family: 'Orbitron', monospace;
    font-size: 24px;
    font-weight: 700;
    color: #fff;
    background: rgba(255,255,255,0.06);
    border: 1.5px solid rgba(255,255,255,0.15);
    padding: 16px;
    cursor: pointer;
    transition: all 0.2s ease;
  }
  .pin-numpad button:hover, .pin-numpad button:focus {
    background: rgba(0,240,255,0.12);
    border-color: var(--neon-cyan);
    box-shadow: 0 0 15px rgba(0,240,255,0.2);
    outline: none;
  }
  .pin-hint {
    font-family: 'Rajdhani', sans-serif;
    font-size: 16px;
    color: rgba(255,255,255,0.25);
    letter-spacing: 0.05em;
  }

  /* ─── ADMIN PANEL ─── */
  .admin-section {
    background: var(--bg-card);
    border: 1.5px solid rgba(255,255,255,0.08);
    padding: 30px;
    width: 100%;
    max-width: 700px;
    margin-bottom: 20px;
  }
  .admin-section-title {
    font-family: 'Orbitron', monospace;
    font-size: clamp(14px, 1.5vw, 18px);
    font-weight: 700;
    color: var(--neon-cyan);
    letter-spacing: 0.15em;
    text-transform: uppercase;
    margin-bottom: 20px;
    padding-bottom: 10px;
    border-bottom: 1px solid rgba(0,240,255,0.15);
  }
  .admin-stat-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 10px 0;
    border-bottom: 1px solid rgba(255,255,255,0.04);
  }
  .admin-stat-label {
    font-family: 'Rajdhani', sans-serif;
    font-size: clamp(16px, 1.6vw, 20px);
    color: rgba(255,255,255,0.6);
  }
  .admin-stat-value {
    font-family: 'Orbitron', monospace;
    font-size: clamp(16px, 1.6vw, 20px);
    font-weight: 700;
    color: var(--neon-green);
  }
  .admin-stat-value.cost {
    color: var(--neon-yellow);
  }
  .admin-content {
    width: 100%;
    max-width: 750px;
    max-height: 70vh;
    overflow-y: auto;
    padding: 10px;
  }
  .admin-content::-webkit-scrollbar { width: 6px; }
  .admin-content::-webkit-scrollbar-track { background: rgba(255,255,255,0.03); }
  .admin-content::-webkit-scrollbar-thumb { background: rgba(0,240,255,0.2); border-radius: 3px; }
</style>
</head>
<body class="show-cursor">

<div class="bg-grid"></div>
<div class="bg-glow"></div>

<!-- ═══ TITLE SCREEN ═══ -->
<div id="screen-title" class="screen active">
  <div class="title-logo">BRAINBLITZ</div>
  <div class="title-sub">Lekker TV Trivia</div>
  <div class="btn-group" style="flex-direction:row; flex-wrap:wrap; justify-content:center; gap:30px 40px;">
    <button class="btn" onclick="showScreen('settings')" autofocus style="min-width:260px;">Let's Play!</button>
    <button class="btn pink" onclick="showScreen('howto')" style="min-width:220px;">How to Play</button>
    <button class="btn pink" onclick="showScreen('leaderboard')" style="min-width:220px;">Leaderboard</button>
  </div>
  <div id="lifetime-wins" style="margin-top:30px; font-family:'Orbitron',monospace; font-size:clamp(14px,1.5vw,20px); color:rgba(255,255,255,0.3); letter-spacing:0.1em; opacity:0; transition:opacity 0.5s ease;">
    <span id="title-burden-wins">BURDEN: 0</span> &nbsp;|&nbsp; <span id="title-stu-wins">STU: 0</span>
  </div>
  <button class="admin-gear" onclick="showScreen('pin')" title="Admin" style="font-family:'Rajdhani',sans-serif; font-weight:700; font-size:14px; letter-spacing:0.1em;">ADMIN</button>
</div>

<!-- ═══ HOW TO PLAY ═══ -->
<div id="screen-howto" class="screen">
  <div class="screen-title">How to Play</div>
  <div style="max-width:800px; text-align:center; font-size:clamp(18px,2.2vw,28px); line-height:1.7; color:rgba(255,255,255,0.7); margin-bottom:50px;">
    Answer <span style="color:var(--neon-cyan); font-weight:700;">trivia questions</span> before the timer runs out, boet!<br><br>
    <span style="color:var(--neon-green);">Faster answers = more points. Moerse lekker!</span><br>
    Build a <span style="color:var(--neon-yellow); font-weight:700;">streak</span> for bonus multipliers — jy's 'n Boss!<br><br>
    Use your <span style="color:var(--neon-pink);">remote pointer</span> or keyboard (A/B/C/D) to answer.<br>
    Use <span style="color:var(--neon-cyan);">arrow keys</span> + Enter to navigate with your remote.<br>
    <span style="color:rgba(255,255,255,0.4); font-size:0.85em;">Dis maklik, just point and kliek!</span>
  </div>
  <button class="btn" onclick="showScreen('title')">Back</button>
</div>

<!-- ═══ SETTINGS SCREEN ═══ -->
<div id="screen-settings" class="screen">
  <div class="screen-title">Game Setup</div>
  <div class="settings-grid">
    <div class="setting-group">
      <label>Category</label>
      <div class="pill-group" id="cat-pills">
        <button class="pill selected" data-val="" onclick="selectPill(this,'cat')">Any</button>
        <button class="pill" data-val="Frenchies" onclick="selectPill(this,'cat')">Frenchies</button>
        <button class="pill" data-val="Hiking" onclick="selectPill(this,'cat')">Hiking</button>
        <button class="pill" data-val="SA Wines" onclick="selectPill(this,'cat')">SA Wines</button>
        <button class="pill" data-val="Paris" onclick="selectPill(this,'cat')">Paris</button>
        <button class="pill" data-val="Cheeses" onclick="selectPill(this,'cat')">Cheeses</button>
        <button class="pill" data-val="Braai Culture" onclick="selectPill(this,'cat')">Braai Culture</button>
        <button class="pill" data-val="90s Pop Culture" onclick="selectPill(this,'cat')">90s Pop Culture</button>
        <button class="pill" data-val="SA Food & Slang" onclick="selectPill(this,'cat')">SA Food & Slang</button>
        <button class="pill" data-val="True or False" onclick="selectPill(this,'cat')">True or False</button>
      </div>
    </div>
    <div class="setting-group">
      <label>Timer</label>
      <div class="pill-group" id="timer-pills">
        <button class="pill" data-val="10" onclick="selectPill(this,'timer')">10s</button>
        <button class="pill selected" data-val="15" onclick="selectPill(this,'timer')">15s</button>
        <button class="pill" data-val="20" onclick="selectPill(this,'timer')">20s</button>
        <button class="pill" data-val="30" onclick="selectPill(this,'timer')">30s</button>
      </div>
    </div>
    <div class="setting-group">
      <label>Rounds</label>
      <div class="pill-group" id="rounds-pills">
        <button class="pill" data-val="5" onclick="selectPill(this,'rounds')">5</button>
        <button class="pill selected" data-val="10" onclick="selectPill(this,'rounds')">10</button>
        <button class="pill" data-val="15" onclick="selectPill(this,'rounds')">15</button>
        <button class="pill" data-val="20" onclick="selectPill(this,'rounds')">20</button>
      </div>
    </div>
    <div class="setting-group">
      <label>Voice</label>
      <div class="pill-group" id="voice-pills">
        <button class="pill selected" data-val="off" onclick="selectPill(this,'voice')">Off</button>
        <button class="pill" data-val="rachel" onclick="selectPill(this,'voice')">Rachel</button>
        <button class="pill" data-val="custom" onclick="selectPill(this,'voice')">Butcher</button>
      </div>
    </div>
  </div>
  <div class="btn-group" style="flex-direction:row; gap:60px;">
    <button class="btn pink" onclick="showScreen('title')" style="min-width:220px;">Back</button>
    <button class="btn" onclick="startGame()" style="min-width:220px;">Play!</button>
  </div>
</div>

<!-- ═══ GAME SCREEN ═══ -->
<div id="screen-game" class="screen">
  <div class="game-hud">
    <div class="hud-item">
      <div class="hud-label">Question</div>
      <div class="hud-value" id="hud-question">1/10</div>
    </div>
    <div class="hud-item" id="hud-difficulty-section">
      <div class="hud-label">Difficulty</div>
      <div id="hud-difficulty"><span class="difficulty-badge diff-easy">EASY <span class="difficulty-stars">&#9733;</span></span></div>
    </div>
    <div class="hud-item">
      <div class="hud-label">Current Player</div>
      <div class="hud-value" id="hud-player" style="color:var(--neon-green);">Burden<span id="hud-speaker" class="hud-speaker" style="display:none;">&#128264;</span></div>
    </div>
    <div class="hud-item" id="hud-burden-section">
      <div class="hud-label">Burden</div>
      <div class="hud-value score" id="hud-burden-score">0</div>
    </div>
    <div class="hud-item" id="hud-stu-section">
      <div class="hud-label">Stu</div>
      <div class="hud-value score" id="hud-stu-score">0</div>
    </div>
  </div>
  <div class="timer-track">
    <div class="timer-fill" id="timer-fill"></div>
  </div>
  <div class="category-badge" id="q-category"></div>
  <div class="question-text" id="q-text"></div>
  <div class="answers-grid" id="answers-grid"></div>
</div>

<!-- ═══ LOADING ═══ -->
<div id="screen-loading" class="screen">
  <div class="loading-ring"></div>
  <div style="margin-top:30px; font-family:'Orbitron',monospace; font-size:18px; color:rgba(255,255,255,0.4); letter-spacing:0.2em;">LOADING QUESTIONS...</div>
</div>

<!-- ═══ RESULTS SCREEN ═══ -->
<div id="screen-results" class="screen">
  <div class="results-label">Final Score</div>
  <div id="res-trophy" class="trophy-icon">&#127942;</div>
  <div class="rank-text" id="res-winner" style="margin-bottom: 40px;"></div>

  <div style="display: flex; gap: 80px; margin-bottom: 40px;">
    <!-- Burden Stats -->
    <div id="res-burden-col" class="result-column" style="text-align: center;">
      <div style="font-family: 'Orbitron', monospace; font-size: 24px; color: var(--neon-cyan); margin-bottom: 10px;">BURDEN</div>
      <div class="results-score" id="res-burden-score" style="font-size: clamp(40px, 8vw, 80px);">0</div>
      <div class="stats-row" style="flex-direction: column; gap: 15px; margin-bottom: 0;">
        <div class="stat-item">
          <div class="stat-value" id="res-burden-correct" style="font-size: clamp(20px, 3vw, 35px);">0</div>
          <div class="stat-label">Correct</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="res-burden-streak" style="color:var(--neon-yellow); font-size: clamp(20px, 3vw, 35px);">0</div>
          <div class="stat-label">Best Streak</div>
        </div>
      </div>
    </div>

    <!-- Stu Stats -->
    <div id="res-stu-col" class="result-column" style="text-align: center;">
      <div style="font-family: 'Orbitron', monospace; font-size: 24px; color: var(--neon-pink); margin-bottom: 10px;">STU</div>
      <div class="results-score" id="res-stu-score" style="font-size: clamp(40px, 8vw, 80px); background: linear-gradient(135deg, var(--neon-pink), var(--neon-purple)); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;">0</div>
      <div class="stats-row" style="flex-direction: column; gap: 15px; margin-bottom: 0;">
        <div class="stat-item">
          <div class="stat-value" id="res-stu-correct" style="font-size: clamp(20px, 3vw, 35px);">0</div>
          <div class="stat-label">Correct</div>
        </div>
        <div class="stat-item">
          <div class="stat-value" id="res-stu-streak" style="color:var(--neon-yellow); font-size: clamp(20px, 3vw, 35px);">0</div>
          <div class="stat-label">Best Streak</div>
        </div>
      </div>
    </div>
  </div>

  <div class="btn-group" style="flex-direction:row; gap:80px;">
    <button class="btn" onclick="startGame()" style="min-width:220px;">Play Again!</button>
    <button class="btn pink" onclick="showScreen('title')" style="min-width:180px;">Home</button>
  </div>
</div>

<!-- ═══ ERROR SCREEN ═══ -->
<div id="screen-error" class="screen">
  <div class="error-icon">&#128561;</div>
  <div class="screen-title" style="color:var(--neon-pink);">Haibo!</div>
  <div class="error-message" id="error-message">Something went wrong, boet.</div>
  <div class="btn-group" style="flex-direction:row; gap:60px;">
    <button class="btn" onclick="startGame()" style="min-width:220px;">Try Again</button>
    <button class="btn pink" onclick="showScreen('title')" style="min-width:180px;">Home</button>
  </div>
</div>

<!-- ═══ LEADERBOARD SCREEN ═══ -->
<div id="screen-leaderboard" class="screen">
  <div class="screen-title">Leaderboard</div>
  <div id="lb-content" class="lb-columns">
    <div class="lb-column">
      <div class="lb-name" style="color: var(--neon-cyan);">BURDEN</div>
      <div class="lb-stat"><span class="lb-val" id="lb-burden-wins">0</span><span class="lb-label">Wins</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-burden-games">0</span><span class="lb-label">Games</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-burden-draws">0</span><span class="lb-label">Draws</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-burden-total">0</span><span class="lb-label">Total Score</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-burden-correct">0</span><span class="lb-label">Total Correct</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-burden-best">0</span><span class="lb-label">Best Game</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-burden-streak">0</span><span class="lb-label">Best Streak</span></div>
    </div>
    <div class="lb-column">
      <div class="lb-name" style="color: var(--neon-pink);">STU</div>
      <div class="lb-stat"><span class="lb-val" id="lb-stu-wins">0</span><span class="lb-label">Wins</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-stu-games">0</span><span class="lb-label">Games</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-stu-draws">0</span><span class="lb-label">Draws</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-stu-total">0</span><span class="lb-label">Total Score</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-stu-correct">0</span><span class="lb-label">Total Correct</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-stu-best">0</span><span class="lb-label">Best Game</span></div>
      <div class="lb-stat"><span class="lb-val" id="lb-stu-streak">0</span><span class="lb-label">Best Streak</span></div>
    </div>
  </div>
  <div id="lb-no-data" class="lb-no-data" style="display:none;">No games played yet. Let's play!</div>
  <button class="btn" onclick="showScreen('title')">Home</button>
</div>

<!-- ═══ ACHIEVEMENTS SCREEN ═══ -->
<div id="screen-achievements" class="screen">
  <div class="screen-title">Achievements</div>
  <div id="achievements-grid" class="achievements-grid"></div>
  <button class="btn" onclick="showScreen('title')">Home</button>
</div>

<!-- ═══ PIN ENTRY SCREEN ═══ -->
<div id="screen-pin" class="screen">
  <div class="screen-title">Admin Access</div>
  <div class="pin-entry">
    <div class="pin-dots" id="pin-dots">
      <div class="pin-dot" id="pin-dot-0"></div>
      <div class="pin-dot" id="pin-dot-1"></div>
      <div class="pin-dot" id="pin-dot-2"></div>
      <div class="pin-dot" id="pin-dot-3"></div>
    </div>
    <div class="pin-numpad" id="pin-numpad">
      <button onclick="pinDigit(1)">1</button>
      <button onclick="pinDigit(2)">2</button>
      <button onclick="pinDigit(3)">3</button>
      <button onclick="pinDigit(4)">4</button>
      <button onclick="pinDigit(5)">5</button>
      <button onclick="pinDigit(6)">6</button>
      <button onclick="pinDigit(7)">7</button>
      <button onclick="pinDigit(8)">8</button>
      <button onclick="pinDigit(9)">9</button>
      <button style="visibility:hidden;"></button>
      <button onclick="pinDigit(0)">0</button>
      <button onclick="pinClear()" style="font-size:18px;">&#9003;</button>
    </div>
    <div class="pin-hint">Enter 4-digit code</div>
    <button class="btn pink" onclick="showScreen('title')" style="margin-top:10px;">Back</button>
  </div>
</div>

<!-- ═══ ADMIN PANEL SCREEN ═══ -->
<div id="screen-admin" class="screen">
  <div class="screen-title">Admin Panel</div>
  <div class="admin-content">
    <div class="admin-section">
      <div class="admin-section-title">ElevenLabs TTS Usage</div>
      <div id="admin-tts-loading" style="color:rgba(255,255,255,0.3); font-family:'Rajdhani',sans-serif; font-size:18px; text-align:center; padding:20px;">Loading...</div>
      <div id="admin-tts-stats" style="display:none;">
        <div class="admin-stat-row" style="padding:16px 0; border-bottom:2px solid rgba(255,230,0,0.15);">
          <span class="admin-stat-label" style="font-size:clamp(18px,1.8vw,24px); font-weight:700; color:rgba(255,255,255,0.8);">Total Cost to Date</span>
          <span class="admin-stat-value cost" id="admin-tts-cost" style="font-size:clamp(22px,2.2vw,32px);">R0.00</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Total Characters</span>
          <span class="admin-stat-value" id="admin-tts-chars">0</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Total Requests</span>
          <span class="admin-stat-value" id="admin-tts-requests">0</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Avg Cost/Request</span>
          <span class="admin-stat-value cost" id="admin-tts-avg-cost">R0.00</span>
        </div>
        <div class="admin-stat-row">
          <span class="admin-stat-label">Avg Chars/Request</span>
          <span class="admin-stat-value" id="admin-tts-avg">0</span>
        </div>
      </div>
      <div id="admin-tts-error" style="display:none; color:var(--neon-pink); font-family:'Rajdhani',sans-serif; font-size:16px; text-align:center; padding:15px;">Could not load TTS data</div>
    </div>

    <div class="admin-section">
      <div class="admin-section-title">Language</div>
      <div class="pill-group" id="lang-pills">
        <button class="pill selected" data-val="en" onclick="selectPill(this,'lang')">English (SA)</button>
        <button class="pill" data-val="af" onclick="selectPill(this,'lang')">Afrikaans</button>
      </div>
      <div style="margin-top:15px; font-family:'Rajdhani',sans-serif; font-size:clamp(14px,1.4vw,17px); color:rgba(255,255,255,0.35); line-height:1.5;">
        Changes game UI labels and feedback expressions.
      </div>
    </div>

    <div class="admin-section">
      <div class="admin-section-title">Audio Assets (ElevenLabs)</div>
      <div id="admin-audio-loading" style="color:rgba(255,255,255,0.3); font-family:'Rajdhani',sans-serif; font-size:18px; text-align:center; padding:20px;">Loading...</div>
      <div id="admin-audio-content" style="display:none;">
        <div style="margin-bottom:24px;">
          <div class="admin-stat-row" style="border-bottom:2px solid rgba(0,240,255,0.15); padding-bottom:12px; margin-bottom:8px;">
            <span class="admin-stat-label" style="font-size:clamp(16px,1.6vw,20px); font-weight:700; color:rgba(255,255,255,0.8);">Music Tracks</span>
            <button class="btn" onclick="generateAllMusic()" id="btn-gen-all-music" style="font-size:11px; padding:6px 14px; min-width:auto; letter-spacing:0.05em;">Generate All</button>
          </div>
          <div id="admin-music-list"></div>
        </div>
        <div>
          <div class="admin-stat-row" style="border-bottom:2px solid rgba(0,240,255,0.15); padding-bottom:12px; margin-bottom:8px;">
            <span class="admin-stat-label" style="font-size:clamp(16px,1.6vw,20px); font-weight:700; color:rgba(255,255,255,0.8);">Sound Effects</span>
            <button class="btn" onclick="generateAllSfx()" id="btn-gen-all-sfx" style="font-size:11px; padding:6px 14px; min-width:auto; letter-spacing:0.05em;">Generate All</button>
          </div>
          <div id="admin-sfx-list"></div>
        </div>
      </div>
      <div id="admin-audio-progress" style="display:none; text-align:center; padding:20px;">
        <div class="loading-ring" style="margin:0 auto 15px; width:40px; height:40px;"></div>
        <div id="admin-audio-progress-text" style="font-family:'Rajdhani',sans-serif; font-size:16px; color:var(--neon-cyan);">Generating...</div>
      </div>
      <div id="admin-audio-error" style="display:none; color:var(--neon-pink); font-family:'Rajdhani',sans-serif; font-size:16px; text-align:center; padding:15px;"></div>
    </div>
  </div>
  <button class="btn" onclick="showScreen('title')" style="margin-top:20px;">Home</button>
</div>

<!-- Achievement toast container -->
<div id="achievement-toast-container" class="achievement-toast-container"></div>

<!-- Feedback overlay -->
<div class="feedback-overlay" id="feedback-overlay">
  <div class="feedback-text" id="feedback-text"></div>
</div>
<div class="bonus-popup" id="bonus-popup"></div>

<!-- ON FIRE streak overlay -->
<div class="on-fire-overlay" id="on-fire-overlay">
  <div class="on-fire-text">ON FIRE!</div>
</div>

<!-- Turn switch overlay -->
<div class="turn-switch" id="turn-switch">
  <div class="turn-switch-label">GET READY</div>
  <div class="turn-switch-name" id="turn-switch-name">BURDEN</div>
  <div class="turn-switch-countdown" id="turn-switch-countdown">3</div>
</div>

<!-- Round splash -->
<div class="round-splash" id="round-splash">
  <div class="round-label">Question</div>
  <div class="round-number" id="round-number">1</div>
</div>

<!-- Confetti container -->
<div id="confetti-container" class="confetti-container"></div>

<!-- Music mute toggle -->
<button id="music-toggle" class="music-toggle" onclick="toggleMusic()">&#128266;</button>

<script>
  // ═══════════════════════════════════════
  //  POLYFILLS (webOS compatibility)
  // ═══════════════════════════════════════
  if (typeof AbortSignal !== 'undefined' && !AbortSignal.timeout) {
    AbortSignal.timeout = function(ms) {
      const controller = new AbortController();
      setTimeout(() => controller.abort(), ms);
      return controller.signal;
    };
  }

  // ═══════════════════════════════════════
  //  ELEVENLABS AUDIO ASSET LOADER
  // ═══════════════════════════════════════
  var ElevenAudio = {
    sfx: {},     // name -> AudioBuffer
    music: {},   // name -> AudioBuffer
    loaded: false,

    SFX_NAMES: ['correct','wrong','tick','countdown','start','click','whoosh','victory_fanfare','draw_tone','crowd_cheer','achievement','streak_fire'],
    MUSIC_NAMES: ['title','game','victory','draw'],

    loadAll: function() {
      var self = this;
      var promises = [];

      self.SFX_NAMES.forEach(function(name) {
        promises.push(
          self._fetchAudio('/api/sfx?name=' + name).then(function(buf) {
            if (buf) self.sfx[name] = buf;
          })
        );
      });

      self.MUSIC_NAMES.forEach(function(name) {
        promises.push(
          self._fetchAudio('/api/music?name=' + name).then(function(buf) {
            if (buf) self.music[name] = buf;
          })
        );
      });

      return Promise.all(promises).then(function() {
        self.loaded = true;
      }).catch(function() {
        self.loaded = true;
      });
    },

    _fetchAudio: function(url) {
      return fetch(url, { signal: AbortSignal.timeout(10000) })
        .then(function(res) {
          if (!res.ok) return null;
          return res.arrayBuffer();
        })
        .then(function(buf) {
          if (!buf) return null;
          ensureAudio();
          return new Promise(function(resolve) {
            audioCtx.decodeAudioData(buf, function(decoded) {
              resolve(decoded);
            }, function() {
              resolve(null);
            });
          });
        })
        .catch(function() { return null; });
    },

    playSfx: function(name, volume) {
      var buf = this.sfx[name];
      if (!buf) return false;
      try {
        ensureAudio();
        var source = audioCtx.createBufferSource();
        source.buffer = buf;
        var gain = audioCtx.createGain();
        gain.gain.value = volume || 0.5;
        source.connect(gain);
        gain.connect(masterCompressor);
        source.start();
      } catch(e) {}
      return true;
    }
  };

  // ═══════════════════════════════════════
  //  AUDIO ENGINE (Web Audio API)
  // ═══════════════════════════════════════
  const AudioCtx = window.AudioContext || window.webkitAudioContext;
  let audioCtx;
  let masterCompressor;
  function ensureAudio() {
    if (!audioCtx) {
      audioCtx = new AudioCtx();
      // Master compressor to prevent clipping/crackle
      masterCompressor = audioCtx.createDynamicsCompressor();
      masterCompressor.threshold.value = -12;
      masterCompressor.knee.value = 10;
      masterCompressor.ratio.value = 8;
      masterCompressor.attack.value = 0.003;
      masterCompressor.release.value = 0.15;
      masterCompressor.connect(audioCtx.destination);
    }
    if (audioCtx.state === 'suspended') audioCtx.resume();
  }

  function playTone(freq, dur, type = 'sine', vol = 0.15) {
    try {
      ensureAudio();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = type;
      osc.frequency.value = freq;
      gain.gain.setValueAtTime(vol, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + dur);
      osc.connect(gain);
      gain.connect(masterCompressor);
      osc.start();
      osc.stop(audioCtx.currentTime + dur);
    } catch(e) {}
  }

  function sfxCorrect() {
    if (ElevenAudio.playSfx('correct')) return;
    playTone(523, 0.12, 'sine', 0.10);
    setTimeout(() => playTone(659, 0.12, 'sine', 0.10), 80);
    setTimeout(() => playTone(784, 0.25, 'sine', 0.10), 160);
  }
  function sfxWrong() {
    if (ElevenAudio.playSfx('wrong')) return;
    playTone(200, 0.3, 'sawtooth', 0.1);
    setTimeout(() => playTone(150, 0.4, 'sawtooth', 0.08), 150);
  }
  function sfxTick() {
    if (ElevenAudio.playSfx('tick', 0.3)) return;
    playTone(800, 0.05, 'square', 0.04);
  }
  function sfxCountdown() {
    if (ElevenAudio.playSfx('countdown', 0.4)) return;
    playTone(440, 0.15, 'square', 0.08);
  }
  function sfxStart() {
    if (ElevenAudio.playSfx('start')) return;
    [523, 659, 784, 1047].forEach((f, i) => {
      setTimeout(() => playTone(f, 0.2, 'sine', 0.12), i * 100);
    });
  }
  function sfxClick() {
    if (ElevenAudio.playSfx('click', 0.3)) return;
    playTone(1200, 0.05, 'sine', 0.08);
  }
  function sfxWhoosh() {
    if (ElevenAudio.playSfx('whoosh', 0.4)) return;
    try {
      ensureAudio();
      const osc = audioCtx.createOscillator();
      const gain = audioCtx.createGain();
      osc.type = 'sine';
      osc.frequency.setValueAtTime(300, audioCtx.currentTime);
      osc.frequency.exponentialRampToValueAtTime(1200, audioCtx.currentTime + 0.15);
      gain.gain.setValueAtTime(0.06, audioCtx.currentTime);
      gain.gain.exponentialRampToValueAtTime(0.001, audioCtx.currentTime + 0.2);
      osc.connect(gain);
      gain.connect(masterCompressor);
      osc.start();
      osc.stop(audioCtx.currentTime + 0.2);
    } catch(e) {}
  }
  function sfxVictory() {
    if (ElevenAudio.playSfx('victory_fanfare')) return;
    const notes = [523, 659, 784, 1047, 784, 1047, 1319];
    notes.forEach((f, i) => {
      setTimeout(() => playTone(f, 0.3, 'sine', 0.12), i * 150);
    });
  }
  function sfxDraw() {
    if (ElevenAudio.playSfx('draw_tone')) return;
    playTone(440, 0.3, 'sine', 0.1);
    setTimeout(() => playTone(440, 0.3, 'triangle', 0.08), 300);
  }

  // ═══════════════════════════════════════
  //  STREAK CELEBRATION SFX & TENSION ENGINE
  // ═══════════════════════════════════════
  function sfxCrowdCheer() {
    if (ElevenAudio.playSfx('crowd_cheer')) return;
    try {
      ensureAudio();
      var bufSize = Math.floor(audioCtx.sampleRate * 0.8);
      var buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
      var data = buf.getChannelData(0);
      for (var i = 0; i < bufSize; i++) {
        var env = i < bufSize * 0.1 ? (i / (bufSize * 0.1)) : (i < bufSize * 0.6 ? 1 : 1 - ((i - bufSize * 0.6) / (bufSize * 0.4)));
        data[i] = (Math.random() * 2 - 1) * env;
      }
      var noise = audioCtx.createBufferSource();
      noise.buffer = buf;
      var bp = audioCtx.createBiquadFilter();
      bp.type = 'bandpass'; bp.frequency.value = 1200; bp.Q.value = 0.5;
      var g = audioCtx.createGain();
      g.gain.setValueAtTime(0.10, audioCtx.currentTime);
      g.gain.linearRampToValueAtTime(0.06, audioCtx.currentTime + 0.8);
      noise.connect(bp); bp.connect(g); g.connect(masterCompressor);
      noise.start(); noise.stop(audioCtx.currentTime + 0.8);
      var cheerNotes = [523, 659, 784, 1047, 1319];
      cheerNotes.forEach(function(f, idx) {
        setTimeout(function() { playTone(f, 0.25, 'sine', 0.08); }, idx * 80);
      });
    } catch(e) {}
  }

  var isTenseActive = false;

  function triggerStreakCelebration() {
    var gameScreen = document.getElementById('screen-game');
    gameScreen.classList.add('streak-fire-border');
    setTimeout(function() { gameScreen.classList.remove('streak-fire-border'); }, 3000);

    // ON FIRE overlay — force animation re-trigger
    var fireOverlay = document.getElementById('on-fire-overlay');
    var fireText = fireOverlay.querySelector('.on-fire-text');
    fireOverlay.classList.remove('show');
    if (fireText) { fireText.style.animation = 'none'; void fireText.offsetHeight; fireText.style.animation = ''; }
    fireOverlay.classList.add('show');
    setTimeout(function() { fireOverlay.classList.remove('show'); }, 1200);

    // Streak fire SFX (falls back to crowd cheer)
    if (!ElevenAudio.playSfx('streak_fire')) {
      sfxCrowdCheer();
    }

    // Extra emphasis on bonus popup
    var bonusEl = document.getElementById('bonus-popup');
    bonusEl.classList.add('streak-fire');
    setTimeout(function() { bonusEl.classList.remove('streak-fire'); }, 1500);
  }

  function checkTension() {
    if (!document.getElementById('screen-game').classList.contains('active')) return;
    if (currentQ < Math.floor(settings.rounds / 2)) {
      if (isTenseActive) clearTension();
      return;
    }
    var bScore = players.burden.score;
    var sScore = players.stu.score;
    var maxScore = Math.max(bScore, sScore, 1);
    var diff = Math.abs(bScore - sScore);
    var diffPct = diff / maxScore;
    if (diffPct <= 0.15) {
      if (!isTenseActive) {
        isTenseActive = true;
        var bgGlow = document.querySelector('.bg-glow');
        if (bgGlow) bgGlow.classList.add('tense');
        var bScoreEl = document.getElementById('hud-burden-score');
        var sScoreEl = document.getElementById('hud-stu-score');
        if (bScoreEl) bScoreEl.classList.add('score-tense');
        if (sScoreEl) sScoreEl.classList.add('score-tense');
        if (Music.playing && Music.masterGain) {
          try { Music.masterGain.gain.setTargetAtTime(0.28, audioCtx.currentTime, 0.5); } catch(e) {}
        }
      }
    } else {
      if (isTenseActive) clearTension();
    }
  }

  function clearTension() {
    if (!isTenseActive) return;
    isTenseActive = false;
    var bgGlow = document.querySelector('.bg-glow');
    if (bgGlow) bgGlow.classList.remove('tense');
    var bScoreEl = document.getElementById('hud-burden-score');
    var sScoreEl = document.getElementById('hud-stu-score');
    if (bScoreEl) bScoreEl.classList.remove('score-tense');
    if (sScoreEl) sScoreEl.classList.remove('score-tense');
  }

  // ═══════════════════════════════════════
  //  MUSIC ENGINE (Step Sequencer)
  // ═══════════════════════════════════════
  let musicMuted = false;

  const Music = {
    playing: false,
    currentTrack: null,
    masterGain: null,
    _intensity: 0,
    _intervalId: null,
    _step: 0,
    _bpm: 120,
    _nextNoteTime: 0,
    _scheduledNodes: [],
    _elevenSource: null,

    stop(fadeTime = 0.3) {
      if (!this.playing) return;
      this.playing = false;
      this.currentTrack = null;
      if (this._intervalId) { clearInterval(this._intervalId); this._intervalId = null; }
      if (this.masterGain) {
        try { this.masterGain.gain.linearRampToValueAtTime(0, audioCtx.currentTime + fadeTime); } catch(e) {}
      }
      // Stop ElevenAudio source if active
      if (this._elevenSource) {
        var elSrc = this._elevenSource;
        this._elevenSource = null;
        setTimeout(function() { try { elSrc.stop(); elSrc.disconnect(); } catch(e) {} }, fadeTime * 1000 + 100);
      }
      const old = this._scheduledNodes;
      this._scheduledNodes = [];
      setTimeout(() => { old.forEach(n => { try { n.stop(); n.disconnect(); } catch(e) {} }); }, fadeTime * 1000 + 100);
      this.masterGain = null;
    },

    // Play ElevenLabs cached music track (returns true if available)
    _playEleven(trackName, loop, vol) {
      var buf = ElevenAudio.music[trackName];
      if (!buf) return false;
      ensureAudio();
      var source = audioCtx.createBufferSource();
      source.buffer = buf;
      source.loop = loop !== false;
      var gain = audioCtx.createGain();
      gain.gain.value = musicMuted ? 0 : vol;
      source.connect(gain);
      gain.connect(masterCompressor);
      source.start();
      this._elevenSource = source;
      this.masterGain = gain;
      this.playing = true;
      return true;
    },

    _init(vol) {
      ensureAudio();
      this.masterGain = audioCtx.createGain();
      this.masterGain.gain.value = musicMuted ? 0 : vol;
      this.masterGain.connect(masterCompressor);
      this.playing = true;
      this._step = 0;
      this._nextNoteTime = audioCtx.currentTime + 0.05;
      return this.masterGain;
    },

    _startScheduler(callback) {
      if (this._intervalId) clearInterval(this._intervalId);
      let cleanupCounter = 0;
      this._intervalId = setInterval(() => {
        if (!this.playing) return;
        while (this._nextNoteTime < audioCtx.currentTime + 0.1) {
          callback(this._nextNoteTime, this._step);
          this._step++;
          this._nextNoteTime += 60 / this._bpm / 4; // 16th notes
        }
        // Periodic cleanup of ended nodes to prevent memory buildup
        if (++cleanupCounter % 40 === 0) {
          this._scheduledNodes = this._scheduledNodes.filter(n => {
            try {
              if (n.playbackState === 3 || (n.context && n.context.currentTime > (n._endTime || Infinity))) {
                n.disconnect();
                return false;
              }
            } catch(e) { return false; }
            return true;
          });
        }
      }, 25);
    },

    _note(freq, type, dest, time, dur, vol) {
      try {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.type = type; o.frequency.value = freq;
        g.gain.setValueAtTime(vol, time);
        g.gain.exponentialRampToValueAtTime(0.001, time + dur);
        o.connect(g); g.connect(dest);
        o.start(time); o.stop(time + dur + 0.05);
        o._endTime = time + dur + 0.1;
        if (this._scheduledNodes.length > 100) this._scheduledNodes.splice(0, 20);
        this._scheduledNodes.push(o);
      } catch(e) {}
    },

    _kick(dest, time) {
      try {
        const o = audioCtx.createOscillator();
        const g = audioCtx.createGain();
        o.frequency.setValueAtTime(150, time);
        o.frequency.exponentialRampToValueAtTime(30, time + 0.12);
        g.gain.setValueAtTime(0.20, time);
        g.gain.exponentialRampToValueAtTime(0.001, time + 0.2);
        o.connect(g); g.connect(dest);
        o.start(time); o.stop(time + 0.25);
        o._endTime = time + 0.3;
        if (this._scheduledNodes.length > 100) this._scheduledNodes.splice(0, 20);
        this._scheduledNodes.push(o);
      } catch(e) {}
    },

    _hihat(dest, time, vol) {
      try {
        const bufSize = audioCtx.sampleRate * 0.03;
        const buf = audioCtx.createBuffer(1, bufSize, audioCtx.sampleRate);
        const d = buf.getChannelData(0);
        for (let i = 0; i < bufSize; i++) d[i] = (Math.random() * 2 - 1);
        const n = audioCtx.createBufferSource();
        n.buffer = buf;
        const hp = audioCtx.createBiquadFilter();
        hp.type = 'highpass'; hp.frequency.value = 7000;
        const g = audioCtx.createGain();
        g.gain.setValueAtTime(vol || 0.08, time);
        g.gain.exponentialRampToValueAtTime(0.001, time + 0.06);
        n.connect(hp); hp.connect(g); g.connect(dest);
        n.start(time);
        this._scheduledNodes.push(n);
      } catch(e) {}
    },

    // ── Title: chill lo-fi game show theme ──
    title() {
      if (this.currentTrack === 'title') return;
      this.stop(0.2);
      // Try ElevenLabs cached music first
      var self = this;
      setTimeout(() => {
        if (self._playEleven('title', true, 0.18)) {
          self.currentTrack = 'title';
          return;
        }
        const master = this._init(0.18);
        this.currentTrack = 'title';
        this._bpm = 82;

        // Warm pad layer
        const padFilter = audioCtx.createBiquadFilter();
        padFilter.type = 'lowpass'; padFilter.frequency.value = 800;
        padFilter.connect(master);
        const padGain = audioCtx.createGain();
        padGain.gain.value = 0.06;
        padGain.connect(padFilter);

        const padNotes = [130.81, 164.81, 196, 246.94]; // Cmaj7
        padNotes.forEach(f => {
          const o = audioCtx.createOscillator();
          o.type = 'sine'; o.frequency.value = f;
          const o2 = audioCtx.createOscillator();
          o2.type = 'sine'; o2.frequency.value = f * 1.003; // slight detune
          o.connect(padGain); o2.connect(padGain);
          o.start(); o2.start();
          this._scheduledNodes.push(o, o2);
        });

        // LFO on pad filter
        const lfo = audioCtx.createOscillator();
        const lfoG = audioCtx.createGain();
        lfo.frequency.value = 0.15; lfoG.gain.value = 300;
        lfo.connect(lfoG); lfoG.connect(padFilter.frequency);
        lfo.start(); this._scheduledNodes.push(lfo);

        // Chord progression: Cmaj7 → Am7 → Fmaj7 → G
        const chords = [
          [261.63, 329.63, 392, 493.88],   // Cmaj7
          [220, 261.63, 329.63, 440],       // Am7
          [174.61, 261.63, 329.63, 415.30], // Fmaj7
          [196, 246.94, 293.66, 392]        // G
        ];

        // Sequencer: arpeggio + light rhythm
        this._startScheduler((time, step) => {
          const bar = Math.floor(step / 16) % 4;
          const beat = step % 16;
          const chord = chords[bar];

          // Soft kick on 1 and 9
          if (beat === 0 || beat === 8) {
            this._kick(master, time);
          }

          // Hi-hat on every 4th
          if (beat % 4 === 0) {
            this._hihat(master, time, 0.04);
          }
          // Ghost hi-hat
          if (beat % 4 === 2) {
            this._hihat(master, time, 0.015);
          }

          // Arpeggio pluck pattern
          if (beat % 2 === 0) {
            const noteIdx = (beat / 2) % chord.length;
            const freq = chord[noteIdx] * (beat >= 8 ? 2 : 1);
            this._note(freq, 'triangle', master, time, 0.25, 0.035);
          }

          // Bass on beat 1
          if (beat === 0) {
            this._note(chord[0] / 2, 'sine', master, time, 0.4, 0.06);
          }
        });
      }, 250);
    },

    // ── Game: tense electronic, builds with intensity ──
    game() {
      this.stop(0.15);
      var self = this;
      setTimeout(() => {
        if (self._playEleven('game', true, 0.15)) {
          self.currentTrack = 'game';
          return;
        }
        const master = this._init(0.15);
        this.currentTrack = 'game';
        this._bpm = 115;
        this._intensity = 0;

        // Chords: Am → Dm → Em → Am
        const chords = [
          [220, 261.63, 329.63],   // Am
          [146.83, 174.61, 220],   // Dm
          [164.81, 196, 246.94],   // Em
          [220, 261.63, 329.63]    // Am
        ];

        this._startScheduler((time, step) => {
          const bar = Math.floor(step / 16) % 4;
          const beat = step % 16;
          const chord = chords[bar];
          const inten = this._intensity;

          // Kick: beats 0, 8, and at high intensity also 4, 12
          if (beat === 0 || beat === 8 || (inten > 0.5 && (beat === 4 || beat === 12))) {
            this._kick(master, time);
          }

          // Hi-hat gets denser with intensity
          if (beat % 4 === 0) {
            this._hihat(master, time, 0.06);
          }
          if (beat % 4 === 2) {
            this._hihat(master, time, 0.025 + inten * 0.03);
          }
          if (inten > 0.4 && beat % 2 === 1) {
            this._hihat(master, time, 0.012);
          }

          // Bass pulse
          if (beat === 0 || beat === 8) {
            this._note(chord[0] / 2, 'sawtooth', master, time, 0.15, 0.04 + inten * 0.03);
          }

          // Staccato arp
          if (beat % 4 === 0) {
            const f = chord[Math.floor(step / 4) % chord.length];
            this._note(f, 'square', master, time, 0.08, 0.02 + inten * 0.015);
          }

          // Tension stabs at high intensity
          if (inten > 0.6 && beat === 12) {
            chord.forEach(f => this._note(f * 2, 'sawtooth', master, time, 0.06, 0.015));
          }

          // Urgent tick at very high intensity
          if (inten > 0.8 && beat % 2 === 0) {
            this._note(880, 'sine', master, time, 0.02, 0.02);
          }
        });
      }, 200);
    },

    setIntensity(level) {
      this._intensity = Math.max(0, Math.min(1, level));
      if (this.masterGain && this.playing) {
        const vol = 0.15 + level * 0.10;
        try { this.masterGain.gain.setTargetAtTime(vol, audioCtx.currentTime, 0.3); } catch(e) {}
      }
    },

    // ── Victory: triumphant celebration ──
    victory() {
      this.stop(0.15);
      var self = this;
      setTimeout(() => {
        if (self._playEleven('victory', true, 0.18)) {
          self.currentTrack = 'victory';
          return;
        }
        const master = this._init(0.18);
        this.currentTrack = 'victory';
        this._bpm = 135;

        const chords = [
          [261.63, 329.63, 392],     // C
          [349.23, 440, 523.25],     // F
          [392, 493.88, 587.33],     // G
          [261.63, 329.63, 392]      // C
        ];

        this._startScheduler((time, step) => {
          const bar = Math.floor(step / 16) % 4;
          const beat = step % 16;
          const chord = chords[bar];

          // Energetic kick
          if (beat % 4 === 0) {
            this._kick(master, time);
          }

          // Hi-hats on every 8th
          if (beat % 2 === 0) {
            this._hihat(master, time, 0.07);
          }

          // Ascending celebration arpeggios
          if (beat % 2 === 0) {
            const idx = (beat / 2) % chord.length;
            const octave = beat >= 8 ? 2 : 1;
            this._note(chord[idx] * octave, 'triangle', master, time, 0.2, 0.04);
          }

          // Bass
          if (beat === 0) {
            this._note(chord[0] / 2, 'sine', master, time, 0.3, 0.06);
          }

          // Sparkle hits
          if (beat === 0 || beat === 12) {
            this._note(chord[2] * 4, 'sine', master, time, 0.5, 0.015);
          }
        });
      }, 200);
    },

    // ── Draw: mellow ambient pad ──
    draw() {
      this.stop(0.2);
      var self = this;
      setTimeout(() => {
        if (self._playEleven('draw', true, 0.10)) {
          self.currentTrack = 'draw';
          return;
        }
        const master = this._init(0.10);
        this.currentTrack = 'draw';

        const padFilter = audioCtx.createBiquadFilter();
        padFilter.type = 'lowpass'; padFilter.frequency.value = 600;
        padFilter.connect(master);

        [220, 261.63, 329.63].forEach(f => {
          const o = audioCtx.createOscillator();
          o.type = 'sine'; o.frequency.value = f;
          o.connect(padFilter); o.start();
          this._scheduledNodes.push(o);
        });

        const lfo = audioCtx.createOscillator();
        const lfoG = audioCtx.createGain();
        lfo.frequency.value = 0.1; lfoG.gain.value = 150;
        lfo.connect(lfoG); lfoG.connect(padFilter.frequency);
        lfo.start(); this._scheduledNodes.push(lfo);
      }, 250);
    }
  };

  function toggleMusic() {
    musicMuted = !musicMuted;
    const btn = document.getElementById('music-toggle');
    if (musicMuted) {
      btn.classList.add('muted');
      btn.innerHTML = '&#128264;'; // muted speaker
      if (Music.masterGain) {
        try { Music.masterGain.gain.setTargetAtTime(0, audioCtx.currentTime, 0.05); } catch(e) {}
      }
    } else {
      btn.classList.remove('muted');
      btn.innerHTML = '&#128266;'; // speaker with sound
      if (Music.masterGain && Music.playing) {
        try { Music.masterGain.gain.setTargetAtTime(0.15, audioCtx.currentTime, 0.05); } catch(e) {}
      }
    }
  }

  // ═══════════════════════════════════════
  //  QUESTION BANK
  // ═══════════════════════════════════════
  const QUESTION_BANK = [
    // ── FRENCHIES (French Bulldogs) ──
    {category:"Frenchies",question:"What country did French Bulldogs originally come from before becoming popular in France?",correct_answer:"England",incorrect_answers:["Germany","Spain","Belgium"]},
    {category:"Frenchies",question:"What is the average weight range of an adult French Bulldog?",correct_answer:"16-28 pounds",incorrect_answers:["30-45 pounds","8-12 pounds","50-65 pounds"]},
    {category:"Frenchies",question:"French Bulldogs are known for their distinctive ears. What shape are they?",correct_answer:"Bat-shaped",incorrect_answers:["Floppy","Pointed","Rose-shaped"]},
    {category:"Frenchies",question:"What is a common health concern specific to French Bulldogs due to their flat face?",correct_answer:"Brachycephalic airway syndrome",incorrect_answers:["Hip dysplasia","Bloat","Cataracts"]},
    {category:"Frenchies",question:"What is the average lifespan of a French Bulldog?",correct_answer:"10-12 years",incorrect_answers:["7-9 years","14-16 years","13-15 years"]},
    {category:"Frenchies",question:"Which of these coat colors is NOT standard for French Bulldogs?",correct_answer:"Merle",incorrect_answers:["Brindle","Fawn","White"]},
    {category:"Frenchies",question:"French Bulldogs were originally bred as companions for which group of workers in England?",correct_answer:"Lace makers",incorrect_answers:["Coal miners","Fishermen","Blacksmiths"]},
    {category:"Frenchies",question:"Why are French Bulldogs unable to swim well?",correct_answer:"Their heavy front body and short legs",incorrect_answers:["They are afraid of water","Their fur is too thick","They have no webbed feet"]},
    {category:"Frenchies",question:"What is the French Bulldog's rank among the most popular dog breeds in the USA (as of 2024)?",correct_answer:"#1",incorrect_answers:["#5","#10","#3"]},
    {category:"Frenchies",question:"How many puppies does a French Bulldog typically have in a litter?",correct_answer:"2-4",incorrect_answers:["5-7","7-10","1-2"]},
    {category:"Frenchies",question:"Why do most French Bulldogs require cesarean sections for birth?",correct_answer:"Their puppies' heads are too large for the birth canal",incorrect_answers:["They are too small","Their hips are weak","It is a breed regulation"]},
    {category:"Frenchies",question:"What position do French Bulldogs prefer to sleep in?",correct_answer:"On their back with legs in the air (frog pose)",incorrect_answers:["Curled in a tight ball","Standing up like a horse","Hanging upside down"]},
    {category:"Frenchies",question:"What group does the AKC classify French Bulldogs in?",correct_answer:"Non-Sporting Group",incorrect_answers:["Toy Group","Terrier Group","Working Group"]},
    {category:"Frenchies",question:"Which celebrity is NOT known for owning a French Bulldog?",correct_answer:"Oprah Winfrey",incorrect_answers:["Lady Gaga","Dwayne 'The Rock' Johnson","Hugh Jackman"]},
    {category:"Frenchies",question:"What is the typical personality trait most associated with French Bulldogs?",correct_answer:"Clownish and affectionate",incorrect_answers:["Aggressive and territorial","Independent and aloof","Hyperactive and restless"]},
    {category:"Frenchies",question:"What sound do French Bulldogs commonly make that other breeds don't?",correct_answer:"A unique 'talking' or yodeling sound",incorrect_answers:["A high-pitched whistle","A deep howl","A clicking noise"]},
    {category:"Frenchies",question:"What sound are French Bulldogs famously known for making besides barking?",correct_answer:"Snoring and snorting",incorrect_answers:["Howling","Chirping","Growling"]},
    {category:"Frenchies",question:"In what decade did French Bulldogs first arrive in America?",correct_answer:"1880s",incorrect_answers:["1920s","1950s","1770s"]},
    {category:"Frenchies",question:"What is the correct way to clean a French Bulldog's facial wrinkles?",correct_answer:"Gently wipe with a damp cloth and dry thoroughly",incorrect_answers:["Use rubbing alcohol","Leave them alone","Apply baby powder daily"]},
    {category:"Frenchies",question:"Which of these activities is LEAST suitable for a French Bulldog?",correct_answer:"Long-distance running",incorrect_answers:["Short walks","Indoor play","Trick training"]},
    {category:"Frenchies",question:"What distinctive feature besides bat ears makes Frenchies easy to identify?",correct_answer:"A short, stumpy corkscrew tail",incorrect_answers:["A long fluffy tail","Blue eyes","Extra-long legs"]},
    {category:"Frenchies",question:"What is the most expensive French Bulldog color?",correct_answer:"Blue",incorrect_answers:["Black","White","Brindle"]},
    {category:"Frenchies",question:"French Bulldogs are known to be particularly good at which of these?",correct_answer:"Being apartment dogs",incorrect_answers:["Guarding livestock","Hunting rabbits","Pulling sleds"]},
    {category:"Frenchies",question:"What is a French Bulldog's typical attitude towards strangers?",correct_answer:"Friendly and sociable",incorrect_answers:["Aggressive and territorial","Fearful and shy","Completely indifferent"]},
    {category:"Frenchies",question:"What was the original English ancestor breed of the French Bulldog?",correct_answer:"Toy Bulldog",incorrect_answers:["Pug","Boston Terrier","English Mastiff"]},

    // ── HIKING ──
    {category:"Hiking",question:"What does 'Leave No Trace' mean in hiking?",correct_answer:"Minimize your impact on the natural environment",incorrect_answers:["Don't leave your hiking group","Never stop on the trail","Always hike in the dark"]},
    {category:"Hiking",question:"What is the highest peak in the Drakensberg Mountains of South Africa?",correct_answer:"Thabana Ntlenyana",incorrect_answers:["Cathedral Peak","Giant's Castle","Champagne Castle"]},
    {category:"Hiking",question:"What is the '10 Essentials' in hiking terminology?",correct_answer:"A list of essential survival items for any hike",incorrect_answers:["10 rules for trail etiquette","The 10 hardest hikes in the world","A 10-mile training plan"]},
    {category:"Hiking",question:"Which type of footwear is generally recommended for rocky mountain trails?",correct_answer:"Ankle-supporting hiking boots",incorrect_answers:["Running shoes","Sandals","Wellington boots"]},
    {category:"Hiking",question:"What does 'cairn' mean on a hiking trail?",correct_answer:"A stack of rocks used as a trail marker",incorrect_answers:["A type of shelter","A water source","A resting bench"]},
    {category:"Hiking",question:"What is the approximate length of the Appalachian Trail in the USA?",correct_answer:"2,190 miles",incorrect_answers:["500 miles","5,000 miles","800 miles"]},
    {category:"Hiking",question:"What is altitude sickness typically caused by?",correct_answer:"Reduced oxygen at high elevations",incorrect_answers:["Dehydration","Eating too much","Cold temperatures"]},
    {category:"Hiking",question:"What is the most important item to bring on any hike?",correct_answer:"Water",incorrect_answers:["A camera","Snacks","A compass"]},
    {category:"Hiking",question:"What does 'switchback' mean on a trail?",correct_answer:"A zigzag path used to climb steep terrain",incorrect_answers:["Hiking backward","Returning to the trailhead","A type of bridge"]},
    {category:"Hiking",question:"What is the famous Table Mountain hiking trail in Cape Town called?",correct_answer:"Platteklip Gorge",incorrect_answers:["Lion's Head Loop","Devil's Peak Path","Kirstenbosch Trail"]},
    {category:"Hiking",question:"What is the rule of thumb for water consumption while hiking?",correct_answer:"About half a liter per hour of moderate hiking",incorrect_answers:["1 cup per day","5 liters per hour","Only drink when thirsty"]},
    {category:"Hiking",question:"What is 'thru-hiking'?",correct_answer:"Completing an entire long-distance trail in one continuous journey",incorrect_answers:["Hiking through water","Hiking at night","Hiking without breaks"]},
    {category:"Hiking",question:"What are trekking poles primarily used for?",correct_answer:"Balance and reducing strain on knees",incorrect_answers:["Measuring distance","Fighting off animals","Testing water depth"]},
    {category:"Hiking",question:"What is the Otter Trail in South Africa known for?",correct_answer:"A famous multi-day coastal hike in Tsitsikamma",incorrect_answers:["A trail through the Kalahari Desert","A mountain bike route","A river rafting experience"]},
    {category:"Hiking",question:"What does it mean when a trail is marked as 'Class 3'?",correct_answer:"Scrambling with hands needed, exposure to falls",incorrect_answers:["Easy flat walking","Wheelchair accessible","Technical rock climbing with ropes"]},
    {category:"Hiking",question:"What time of day is generally best to start a mountain hike?",correct_answer:"Early morning",incorrect_answers:["Midday","Late afternoon","Midnight"]},
    {category:"Hiking",question:"What is a 'blaze' in trail terminology?",correct_answer:"A painted mark on a tree or rock indicating the trail",incorrect_answers:["A fast hiking pace","A clearing caused by wildfire","A type of hiking boot"]},
    {category:"Hiking",question:"Which famous trail runs along the rim of the Grand Canyon?",correct_answer:"Bright Angel Trail",incorrect_answers:["Pacific Crest Trail","John Muir Trail","Continental Divide Trail"]},
    {category:"Hiking",question:"What is the recommended action if you encounter a bear on a trail?",correct_answer:"Stay calm, make yourself look big, and back away slowly",incorrect_answers:["Run as fast as possible","Climb the nearest tree","Play dead immediately"]},
    {category:"Hiking",question:"What material are the best hiking socks made from?",correct_answer:"Merino wool",incorrect_answers:["Cotton","Silk","Nylon only"]},
    {category:"Hiking",question:"What is 'bushwhacking' in hiking?",correct_answer:"Hiking through dense vegetation without a trail",incorrect_answers:["Cutting down bushes","A type of machete","Camping in the bush"]},
    {category:"Hiking",question:"How do you estimate remaining daylight using your hand?",correct_answer:"Each finger width between the sun and horizon equals about 15 minutes",incorrect_answers:["Count your fingers and multiply by one hour","Hold your palm over the sun","Measure your shadow length"]},
    {category:"Hiking",question:"What is the longest hiking trail in the world?",correct_answer:"The Great Trail (Trans Canada Trail)",incorrect_answers:["The Appalachian Trail","The Pacific Crest Trail","The Camino de Santiago"]},
    {category:"Hiking",question:"What is a 'saddle' in mountain hiking terminology?",correct_answer:"A low point between two peaks",incorrect_answers:["A type of backpack","A resting spot","Equipment for horseback riding"]},
    {category:"Hiking",question:"What is the primary danger of cotton clothing while hiking?",correct_answer:"It retains moisture and loses insulation when wet",incorrect_answers:["It attracts insects","It is too heavy","It tears easily"]},

    // ── SOUTH AFRICAN WINES ──
    {category:"SA Wines",question:"What is the most widely planted red grape variety in South Africa?",correct_answer:"Cabernet Sauvignon",incorrect_answers:["Merlot","Pinot Noir","Shiraz"]},
    {category:"SA Wines",question:"Which South African wine region is considered the oldest in the country?",correct_answer:"Constantia",incorrect_answers:["Stellenbosch","Franschhoek","Paarl"]},
    {category:"SA Wines",question:"What unique South African grape is a cross between Pinot Noir and Cinsault?",correct_answer:"Pinotage",incorrect_answers:["Chenin Noir","Cape Blend","Steen"]},
    {category:"SA Wines",question:"What is Chenin Blanc also traditionally known as in South Africa?",correct_answer:"Steen",incorrect_answers:["Colombar","Hanepoot","Muscat"]},
    {category:"SA Wines",question:"Which South African wine estate is the oldest, established in 1685?",correct_answer:"Groot Constantia",incorrect_answers:["Vergelegen","Boschendal","Spier"]},
    {category:"SA Wines",question:"What is the name of South Africa's wine classification system?",correct_answer:"Wine of Origin (WO)",incorrect_answers:["Appellation d'Origine","Denominazione","Grand Cru"]},
    {category:"SA Wines",question:"Which town is known as the 'French Corner' of the Cape Winelands?",correct_answer:"Franschhoek",incorrect_answers:["Stellenbosch","Paarl","Robertson"]},
    {category:"SA Wines",question:"What famous dessert wine from Constantia was favored by Napoleon?",correct_answer:"Vin de Constance",incorrect_answers:["Cape Ruby","Muscadel","Jerepigo"]},
    {category:"SA Wines",question:"Which South African wine region is known for its exceptional Sauvignon Blanc?",correct_answer:"Elgin",incorrect_answers:["Swartland","Klein Karoo","Olifants River"]},
    {category:"SA Wines",question:"What is a 'Cape Blend'?",correct_answer:"A red blend that must contain 30-70% Pinotage",incorrect_answers:["Any wine from the Cape","A white wine blend","A rosé style"]},
    {category:"SA Wines",question:"Which wine route is the oldest in South Africa, established in 1971?",correct_answer:"Stellenbosch Wine Route",incorrect_answers:["Franschhoek Wine Route","Paarl Wine Route","Robertson Wine Route"]},
    {category:"SA Wines",question:"What is the Swartland region increasingly known for?",correct_answer:"Old-vine Chenin Blanc and Rhône-style blends",incorrect_answers:["Sparkling wine","Dessert wine","Pinot Noir"]},
    {category:"SA Wines",question:"What is 'Méthode Cap Classique' (MCC)?",correct_answer:"South African traditional method sparkling wine",incorrect_answers:["A wine scoring system","A type of fortified wine","A vineyard pruning technique"]},
    {category:"SA Wines",question:"Which ocean current has a significant cooling effect on South African coastal vineyards?",correct_answer:"The Benguela Current",incorrect_answers:["The Gulf Stream","The Agulhas Current","The Humboldt Current"]},
    {category:"SA Wines",question:"What is the Hemel-en-Aarde Valley near Hermanus famous for producing?",correct_answer:"Pinot Noir and Chardonnay",incorrect_answers:["Pinotage","Cabernet Sauvignon","Chenin Blanc"]},
    {category:"SA Wines",question:"What is the most planted white grape variety in South Africa?",correct_answer:"Chenin Blanc",incorrect_answers:["Sauvignon Blanc","Chardonnay","Colombard"]},
    {category:"SA Wines",question:"Which South African wine region is the largest by area?",correct_answer:"The Breede River Valley",incorrect_answers:["Stellenbosch","Constantia","Walker Bay"]},
    {category:"SA Wines",question:"What does BWI stand for in South African wine?",correct_answer:"Biodiversity and Wine Initiative",incorrect_answers:["Best Wine Institute","Blended Wine International","Bureau of Wine Inspection"]},
    {category:"SA Wines",question:"In what century did wine production first begin in South Africa?",correct_answer:"17th century (1659)",incorrect_answers:["15th century","19th century","18th century"]},
    {category:"SA Wines",question:"What is 'Hanepoot' in South African wine terminology?",correct_answer:"Muscat d'Alexandrie grape",incorrect_answers:["A type of wine press","A vineyard pest","A wine storage container"]},
    {category:"SA Wines",question:"Which South African wine often has a distinctive smoke/braai character?",correct_answer:"Pinotage",incorrect_answers:["Merlot","Sauvignon Blanc","Riesling"]},
    {category:"SA Wines",question:"What is the Robertson Valley particularly well-suited for due to its lime-rich soils?",correct_answer:"Chardonnay",incorrect_answers:["Pinotage","Malbec","Shiraz"]},
    {category:"SA Wines",question:"Which award is considered the most prestigious for South African wines?",correct_answer:"Platter's Wine Guide 5 Stars",incorrect_answers:["The Cape Gold Medal","The Winemaker's Choice","The Stellenbosch Trophy"]},
    {category:"SA Wines",question:"What percentage of South Africa's wine production is white wine?",correct_answer:"About 55%",incorrect_answers:["About 20%","About 80%","About 35%"]},
    {category:"SA Wines",question:"Approximately how many wine producers are there in South Africa?",correct_answer:"Around 560",incorrect_answers:["Around 50","Around 2,000","Around 100"]},

    // ── PARIS ──
    {category:"Paris",question:"In what year was the Eiffel Tower completed?",correct_answer:"1889",incorrect_answers:["1900","1875","1920"]},
    {category:"Paris",question:"What river runs through the center of Paris?",correct_answer:"The Seine",incorrect_answers:["The Loire","The Rhône","The Thames"]},
    {category:"Paris",question:"How many arrondissements (districts) does Paris have?",correct_answer:"20",incorrect_answers:["12","16","25"]},
    {category:"Paris",question:"What is the most visited museum in the world, located in Paris?",correct_answer:"The Louvre",incorrect_answers:["Musée d'Orsay","Centre Pompidou","Musée Rodin"]},
    {category:"Paris",question:"What was the original purpose of the Eiffel Tower?",correct_answer:"Temporary entrance arch for the 1889 World's Fair",incorrect_answers:["A military watchtower","A radio tower","A monument to Napoleon"]},
    {category:"Paris",question:"Which Parisian landmark was originally a medieval fortress before becoming a museum?",correct_answer:"The Louvre",incorrect_answers:["Notre-Dame","Sacré-Cœur","The Panthéon"]},
    {category:"Paris",question:"What is the famous Parisian boulevard known for luxury shopping and the Arc de Triomphe?",correct_answer:"Champs-Élysées",incorrect_answers:["Boulevard Haussmann","Rue de Rivoli","Boulevard Saint-Germain"]},
    {category:"Paris",question:"What is the famous cabaret venue in the Montmartre district of Paris?",correct_answer:"Moulin Rouge",incorrect_answers:["Lido","Folies Bergère","Crazy Horse"]},
    {category:"Paris",question:"What Parisian cathedral suffered a devastating fire in 2019?",correct_answer:"Notre-Dame de Paris",incorrect_answers:["Sacré-Cœur","Saint-Sulpice","La Madeleine"]},
    {category:"Paris",question:"What is the Parisian underground ossuary that holds the remains of over 6 million people?",correct_answer:"The Catacombs",incorrect_answers:["The Panthéon","Père Lachaise","The Sewer Museum"]},
    {category:"Paris",question:"Which Parisian train station serves as the Eurostar terminal to London?",correct_answer:"Gare du Nord",incorrect_answers:["Gare de Lyon","Gare Montparnasse","Gare de l'Est"]},
    {category:"Paris",question:"Who redesigned much of Paris's boulevards in the 1850s-1870s?",correct_answer:"Baron Haussmann",incorrect_answers:["Napoleon Bonaparte","Gustave Eiffel","Le Corbusier"]},
    {category:"Paris",question:"What is the name of Paris's famous flea market, one of the largest in the world?",correct_answer:"Marché aux Puces de Saint-Ouen",incorrect_answers:["Marché Bastille","Les Halles","Marché d'Aligre"]},
    {category:"Paris",question:"Which Paris landmark sits at the highest natural point in the city?",correct_answer:"Sacré-Cœur Basilica (Montmartre)",incorrect_answers:["The Eiffel Tower","Arc de Triomphe","Tour Montparnasse"]},
    {category:"Paris",question:"What famous cemetery in Paris is the final resting place of Jim Morrison and Oscar Wilde?",correct_answer:"Père Lachaise",incorrect_answers:["Montmartre Cemetery","Montparnasse Cemetery","Passy Cemetery"]},
    {category:"Paris",question:"What is the name of the famous Parisian cabaret known for the can-can dance?",correct_answer:"Moulin Rouge",incorrect_answers:["Lido","Crazy Horse","Folies Bergère"]},
    {category:"Paris",question:"How many bridges cross the Seine in Paris?",correct_answer:"37",incorrect_answers:["12","50","25"]},
    {category:"Paris",question:"What is the oldest bridge in Paris, despite its name meaning 'New Bridge'?",correct_answer:"Pont Neuf",incorrect_answers:["Pont des Arts","Pont Alexandre III","Pont Royal"]},
    {category:"Paris",question:"Which Parisian park was originally a royal hunting ground?",correct_answer:"Bois de Boulogne",incorrect_answers:["Jardin du Luxembourg","Tuileries Garden","Parc des Buttes-Chaumont"]},
    {category:"Paris",question:"What is the French name for the Paris subway system?",correct_answer:"Le Métro",incorrect_answers:["Le RER","Le TGV","Le Tramway"]},
    {category:"Paris",question:"In which arrondissement is the Eiffel Tower located?",correct_answer:"7th",incorrect_answers:["1st","16th","15th"]},
    {category:"Paris",question:"What famous art museum is housed in a converted railway station?",correct_answer:"Musée d'Orsay",incorrect_answers:["Centre Pompidou","Musée de l'Orangerie","Palais de Tokyo"]},
    {category:"Paris",question:"What is the Latin Quarter in Paris named after?",correct_answer:"Latin was the language spoken at the medieval university there",incorrect_answers:["A large Latin American community","A Roman temple discovered there","A famous Latin inscription on a building"]},
    {category:"Paris",question:"What year did Paris host the Summer Olympics for the third time?",correct_answer:"2024",incorrect_answers:["2012","2028","2020"]},
    {category:"Paris",question:"What is the Marais district in Paris known for?",correct_answer:"Historic architecture, art galleries, and LGBTQ+ culture",incorrect_answers:["The financial district","Industrial warehouses","The airport area"]},

    // ── CHEESES ──
    {category:"Cheeses",question:"What country produces the most cheese in the world?",correct_answer:"United States",incorrect_answers:["France","Italy","Netherlands"]},
    {category:"Cheeses",question:"What cheese is the most popular pizza topping worldwide?",correct_answer:"Mozzarella",incorrect_answers:["Cheddar","Gouda","Parmesan"]},
    {category:"Cheeses",question:"What type of milk is traditionally used to make Roquefort?",correct_answer:"Sheep's milk",incorrect_answers:["Cow's milk","Goat's milk","Buffalo milk"]},
    {category:"Cheeses",question:"What gives blue cheese its distinctive blue-green veins?",correct_answer:"Penicillium mold",incorrect_answers:["Food coloring","Blue algae","Copper minerals"]},
    {category:"Cheeses",question:"Which Italian cheese is traditionally aged for at least 12 months?",correct_answer:"Parmigiano-Reggiano",incorrect_answers:["Mozzarella","Ricotta","Mascarpone"]},
    {category:"Cheeses",question:"What is the rind of Brie cheese made from?",correct_answer:"Edible white mold (Penicillium camemberti)",incorrect_answers:["Wax","Cloth wrapping","Dried herbs"]},
    {category:"Cheeses",question:"What country is Gouda cheese originally from?",correct_answer:"Netherlands",incorrect_answers:["Germany","Belgium","Switzerland"]},
    {category:"Cheeses",question:"What is the main difference between Brie and Camembert?",correct_answer:"Brie is larger and milder; Camembert is smaller and more intense",incorrect_answers:["They are made from different milks","One is blue and one is white","Brie is hard and Camembert is soft"]},
    {category:"Cheeses",question:"Which Swiss cheese is famous for its large holes?",correct_answer:"Emmental",incorrect_answers:["Gruyère","Raclette","Appenzeller"]},
    {category:"Cheeses",question:"What causes the holes in Swiss cheese?",correct_answer:"Carbon dioxide gas produced by bacteria during aging",incorrect_answers:["Air bubbles from stirring","Worms that are later removed","Mechanical pressing"]},
    {category:"Cheeses",question:"What is fresh mozzarella traditionally made from?",correct_answer:"Water buffalo milk",incorrect_answers:["Cow's milk","Goat's milk","Sheep's milk"]},
    {category:"Cheeses",question:"Which French cheese is legally required to be aged in the caves of Combalou?",correct_answer:"Roquefort",incorrect_answers:["Brie de Meaux","Comté","Reblochon"]},
    {category:"Cheeses",question:"What does 'affinage' mean in cheese-making?",correct_answer:"The process of aging and maturing cheese",incorrect_answers:["Adding salt","Cutting the curds","Pasteurizing the milk"]},
    {category:"Cheeses",question:"What is the world's most expensive cheese?",correct_answer:"Pule (made from donkey milk)",incorrect_answers:["White Stilton Gold","Bitto Storico","Epoisses"]},
    {category:"Cheeses",question:"Which cheese is traditionally used in a classic Italian tiramisu?",correct_answer:"Mascarpone",incorrect_answers:["Ricotta","Cream cheese","Brie"]},
    {category:"Cheeses",question:"What is 'rennet' used for in cheese-making?",correct_answer:"Coagulating milk to separate curds from whey",incorrect_answers:["Adding flavor","Coloring the cheese","Preserving the cheese"]},
    {category:"Cheeses",question:"Which English cheese is traditionally eaten with port wine?",correct_answer:"Stilton",incorrect_answers:["Cheddar","Red Leicester","Wensleydale"]},
    {category:"Cheeses",question:"What is Halloumi cheese known for?",correct_answer:"Its high melting point — it can be grilled or fried",incorrect_answers:["Its extremely strong smell","Its blue color","Its liquid center"]},
    {category:"Cheeses",question:"Where does Feta cheese originate from?",correct_answer:"Greece",incorrect_answers:["Turkey","Italy","Bulgaria"]},
    {category:"Cheeses",question:"What type of cheese is Gruyère?",correct_answer:"A hard Swiss cheese with a slightly sweet, nutty flavor",incorrect_answers:["A soft French cheese","A blue Italian cheese","A smoked Dutch cheese"]},
    {category:"Cheeses",question:"What is the traditional cheese used in a French onion soup?",correct_answer:"Gruyère",incorrect_answers:["Brie","Camembert","Roquefort"]},
    {category:"Cheeses",question:"What does PDO (Protected Designation of Origin) mean for cheese?",correct_answer:"It can only be made in a specific region using traditional methods",incorrect_answers:["It is pasteurized","It is organic","It is dairy-free"]},
    {category:"Cheeses",question:"What cheese is made by stretching and pulling the curds in hot water?",correct_answer:"Mozzarella (pasta filata method)",incorrect_answers:["Cheddar","Brie","Gouda"]},
    {category:"Cheeses",question:"Which country consumes the most cheese per capita?",correct_answer:"France",incorrect_answers:["United States","Italy","Switzerland"]},
    {category:"Cheeses",question:"What is the 'king of cheeses' as designated by tradition?",correct_answer:"Parmigiano-Reggiano",incorrect_answers:["Gruyère","Stilton","Brie"]},

    // ── BRAAI CULTURE ──
    {category:"Braai Culture",question:"What date is National Braai Day (Heritage Day) celebrated in South Africa?",correct_answer:"24 September",incorrect_answers:["16 June","27 April","1 May"],difficulty:1},
    {category:"Braai Culture",question:"What is the most popular type of meat to braai in South Africa?",correct_answer:"Boerewors",incorrect_answers:["Chicken wings","Pork chops","Lamb shanks"],difficulty:1},
    {category:"Braai Culture",question:"What is boerewors?",correct_answer:"A traditional South African spiced sausage",incorrect_answers:["A braai sauce","A side dish of corn","A type of bread roll"],difficulty:1},
    {category:"Braai Culture",question:"What does the word 'braai' literally mean in Afrikaans?",correct_answer:"Roast or grill",incorrect_answers:["Fire","Meat","Party"],difficulty:1},
    {category:"Braai Culture",question:"What is the most common fuel used for a traditional South African braai?",correct_answer:"Wood or charcoal",incorrect_answers:["Gas","Electric coils","Paraffin"],difficulty:1},
    {category:"Braai Culture",question:"What is 'pap' that is commonly served with braai meat?",correct_answer:"A stiff maize meal porridge",incorrect_answers:["A bread roll","A potato dish","A type of rice"],difficulty:1},
    {category:"Braai Culture",question:"What is a 'braaibroodjie'?",correct_answer:"A toasted sandwich made on the braai",incorrect_answers:["A bread roll for boerewors","A type of flatbread","A dessert grilled on coals"],difficulty:1},
    {category:"Braai Culture",question:"What filling typically goes inside a braaibroodjie?",correct_answer:"Cheese, tomato, and onion",incorrect_answers:["Ham and mustard","Peanut butter and jam","Egg and bacon"],difficulty:1},
    {category:"Braai Culture",question:"What is a 'potjie' in South African braai culture?",correct_answer:"A cast-iron pot used to slow-cook stew over coals",incorrect_answers:["A braai grid","A meat thermometer","A type of marinade"],difficulty:1},
    {category:"Braai Culture",question:"In traditional braai etiquette, who typically manages the fire?",correct_answer:"The braai master (usually the host or a designated person)",incorrect_answers:["Everyone takes turns","Only women manage the fire","The youngest guest"],difficulty:1},
    {category:"Braai Culture",question:"Who is credited with starting the campaign to rename Heritage Day as National Braai Day?",correct_answer:"Jan Scannell (Jan Braai)",incorrect_answers:["Desmond Tutu","Nelson Mandela","Ernie Els"],difficulty:2},
    {category:"Braai Culture",question:"What type of South African wood is considered premium for braaing due to its long-lasting coals?",correct_answer:"Kameeldoring (camel thorn)",incorrect_answers:["Pine","Eucalyptus","Jacaranda"],difficulty:2},
    {category:"Braai Culture",question:"What is 'sosatie' in South African braai culture?",correct_answer:"Marinated meat kebabs on skewers",incorrect_answers:["A type of braai sauce","Grilled corn on the cob","A dessert served at braais"],difficulty:2},
    {category:"Braai Culture",question:"What spice blend is traditionally used in boerewors?",correct_answer:"Coriander, cloves, nutmeg, and allspice",incorrect_answers:["Cumin, turmeric, and chili","Paprika, garlic, and oregano","Cinnamon, cardamom, and ginger"],difficulty:2},
    {category:"Braai Culture",question:"What is 'shisa nyama'?",correct_answer:"A Zulu term meaning 'burn the meat' — a communal braai gathering",incorrect_answers:["A braai marinade","A type of braai grid","A beer brand"],difficulty:2},
    {category:"Braai Culture",question:"What is 'rooikrans' wood often used for in the Western Cape?",correct_answer:"Braai fuel — it is an invasive species cleared for firewood",incorrect_answers:["Building furniture","Making wine barrels","Roofing material"],difficulty:2},
    {category:"Braai Culture",question:"What cut of lamb is a popular braai choice in South Africa?",correct_answer:"Lamb chops (rib or loin)",incorrect_answers:["Lamb shank","Lamb neck","Leg of lamb"],difficulty:2},
    {category:"Braai Culture",question:"What is the main difference between a braai and a barbecue in South African culture?",correct_answer:"A braai uses wood coals; a barbecue often uses gas or charcoal briquettes",incorrect_answers:["There is no difference","A braai is indoors","A barbecue is bigger"],difficulty:2},
    {category:"Braai Culture",question:"What is 'mielies' on the braai?",correct_answer:"Corn on the cob grilled over coals",incorrect_answers:["Grilled pumpkin","Roasted potatoes","Toasted bread"],difficulty:2},
    {category:"Braai Culture",question:"What does 'wors' mean in Afrikaans?",correct_answer:"Sausage",incorrect_answers:["Fire","Meat","Smoke"],difficulty:2},
    {category:"Braai Culture",question:"What type of salad is most traditionally served alongside braai meat?",correct_answer:"A braaislaai (coleslaw-style salad)",incorrect_answers:["Caesar salad","Greek salad","Waldorf salad"],difficulty:2},
    {category:"Braai Culture",question:"What South African beer brand uses a braai theme heavily in its marketing?",correct_answer:"Castle Lager",incorrect_answers:["Heineken","Windhoek","Amstel"],difficulty:2},
    {category:"Braai Culture",question:"What is the minimum percentage of meat required in boerewors by South African law?",correct_answer:"90%",incorrect_answers:["70%","50%","80%"],difficulty:3},
    {category:"Braai Culture",question:"Which wood should you NEVER use for a braai because it produces toxic smoke?",correct_answer:"Oleander",incorrect_answers:["Rooikrans","Sekelbos","Kameeldoring"],difficulty:3},
    {category:"Braai Culture",question:"What is 'skilpadjies' or 'vlermuise' — a traditional braai delicacy?",correct_answer:"Lamb liver wrapped in caul fat (netvet)",incorrect_answers:["Chicken hearts on skewers","Grilled tortoise meat","Deep-fried bat wings"],difficulty:3},
    {category:"Braai Culture",question:"According to boerewors regulations, which type of meat is NOT allowed in traditional boerewors?",correct_answer:"Mechanically recovered meat",incorrect_answers:["Beef","Pork","Lamb"],difficulty:3},
    {category:"Braai Culture",question:"What is the traditional Afrikaans term for the braai grid?",correct_answer:"Rooster",incorrect_answers:["Vuurherd","Kole","Griller"],difficulty:3},
    {category:"Braai Culture",question:"What is 'sekelbos' in braai terminology?",correct_answer:"A type of hardwood favored for braais in the Northern Cape and Free State",incorrect_answers:["A braai tong","A fire starter gel","A braai seasoning"],difficulty:3},
    {category:"Braai Culture",question:"What is 'stywepap' commonly served at a braai?",correct_answer:"A firm, sliceable version of maize porridge",incorrect_answers:["A spicy relish","A potato bake","A cream-based sauce"],difficulty:3},
    {category:"Braai Culture",question:"What is the Cape Malay influence on sosaties?",correct_answer:"A sweet-and-sour marinade with apricot jam, curry, and vinegar",incorrect_answers:["Using fish instead of meat","Wrapping in banana leaves","Adding coconut milk"],difficulty:3},

    // ── 90s POP CULTURE ──
    {category:"90s Pop Culture",question:"What toy was the must-have craze of Christmas 1996?",correct_answer:"Tickle Me Elmo",incorrect_answers:["Tamagotchi","Furby","Beanie Babies"],difficulty:1},
    {category:"90s Pop Culture",question:"Which band performed the hit song 'Wannabe' in 1996?",correct_answer:"Spice Girls",incorrect_answers:["Destiny's Child","TLC","All Saints"],difficulty:1},
    {category:"90s Pop Culture",question:"What was the name of the virtual pet keychain toy that became a worldwide craze in 1997?",correct_answer:"Tamagotchi",incorrect_answers:["Digimon","Giga Pet","Nano Baby"],difficulty:1},
    {category:"90s Pop Culture",question:"Which 1997 film became the highest-grossing movie of the decade?",correct_answer:"Titanic",incorrect_answers:["Jurassic Park","The Lion King","Forrest Gump"],difficulty:1},
    {category:"90s Pop Culture",question:"What was the name of the Fresh Prince's cousin in 'The Fresh Prince of Bel-Air'?",correct_answer:"Carlton Banks",incorrect_answers:["Geoffrey Butler","Jazz","Philip Banks"],difficulty:1},
    {category:"90s Pop Culture",question:"Which video game console did Sony launch in 1994?",correct_answer:"PlayStation",incorrect_answers:["Nintendo 64","Sega Saturn","Dreamcast"],difficulty:1},
    {category:"90s Pop Culture",question:"What sitcom featured six friends hanging out at Central Perk coffee shop?",correct_answer:"Friends",incorrect_answers:["Seinfeld","Frasier","Will & Grace"],difficulty:1},
    {category:"90s Pop Culture",question:"Which boy band released the album 'Millennium' in 1999?",correct_answer:"Backstreet Boys",incorrect_answers:["NSYNC","98 Degrees","Westlife"],difficulty:1},
    {category:"90s Pop Culture",question:"What was the name of the cloned sheep announced in 1997?",correct_answer:"Dolly",incorrect_answers:["Molly","Polly","Holly"],difficulty:1},
    {category:"90s Pop Culture",question:"Which 1993 movie featured dinosaurs brought back to life from DNA in amber?",correct_answer:"Jurassic Park",incorrect_answers:["The Lost World","Congo","Godzilla"],difficulty:1},
    {category:"90s Pop Culture",question:"Which 1999 sci-fi movie features the line 'There is no spoon'?",correct_answer:"The Matrix",incorrect_answers:["The Sixth Sense","Fight Club","Dark City"],difficulty:2},
    {category:"90s Pop Culture",question:"What was the name of the search engine that dominated the early internet before Google?",correct_answer:"AltaVista",incorrect_answers:["Bing","Yahoo","Ask Jeeves"],difficulty:2},
    {category:"90s Pop Culture",question:"What was the highest-selling video game console of the 1990s?",correct_answer:"PlayStation (PS1)",incorrect_answers:["Super Nintendo","Nintendo 64","Sega Genesis"],difficulty:2},
    {category:"90s Pop Culture",question:"What handheld electronic device did Palm release in 1997 that became a must-have gadget?",correct_answer:"PalmPilot",incorrect_answers:["Blackberry","Newton","iPod"],difficulty:2},
    {category:"90s Pop Culture",question:"Which South African kwaito artist released the massive hit 'Nkalakatha' in 1999?",correct_answer:"Mandoza",incorrect_answers:["Arthur Mafokate","Zola","Doc Shebeleza"],difficulty:2},
    {category:"90s Pop Culture",question:"What was the name of the operating system Microsoft launched on August 24, 1995?",correct_answer:"Windows 95",incorrect_answers:["Windows 98","Windows NT","Windows 3.1"],difficulty:2},
    {category:"90s Pop Culture",question:"What 1990s collectible card game was created by Richard Garfield and published by Wizards of the Coast?",correct_answer:"Magic: The Gathering",incorrect_answers:["Yu-Gi-Oh!","Pokemon TCG","Dungeons & Dragons"],difficulty:2},
    {category:"90s Pop Culture",question:"Which rap artist released the album 'All Eyez on Me' in 1996?",correct_answer:"2Pac (Tupac Shakur)",incorrect_answers:["The Notorious B.I.G.","Snoop Dogg","Nas"],difficulty:2},
    {category:"90s Pop Culture",question:"What was the popular 90s fashion trend of wearing jeans extremely wide at the bottom called?",correct_answer:"JNCO jeans (wide-leg/baggy jeans)",incorrect_answers:["Bell-bottoms","Skinny jeans","Cargo pants"],difficulty:2},
    {category:"90s Pop Culture",question:"What was the name of the software used by millions to play MP3 files, launched in 1997?",correct_answer:"Winamp",incorrect_answers:["iTunes","RealPlayer","Napster"],difficulty:2},
    {category:"90s Pop Culture",question:"Which South African TV show, launched in 1994, became the country's most-watched soap opera?",correct_answer:"Generations",incorrect_answers:["Isidingo","Egoli","7de Laan"],difficulty:2},
    {category:"90s Pop Culture",question:"What was the Y2K bug that caused worldwide panic at the end of the 90s?",correct_answer:"Fear that computers would malfunction when the date changed to 2000",incorrect_answers:["A deadly computer virus","A millennium-themed video game","A new species of insect discovered in 1999"],difficulty:2},
    {category:"90s Pop Culture",question:"What Nokia phone model, released in 1998, was one of the first to feature the game Snake?",correct_answer:"Nokia 6110",incorrect_answers:["Nokia 3310","Nokia 5110","Nokia 8210"],difficulty:3},
    {category:"90s Pop Culture",question:"Which South African kwaito group released 'It's About Time' and helped popularize the genre?",correct_answer:"Boom Shaka",incorrect_answers:["TKZee","Bongo Maffin","Trompies"],difficulty:3},
    {category:"90s Pop Culture",question:"What was the name of the Sega console released in 1999 that was the first to include a built-in modem?",correct_answer:"Dreamcast",incorrect_answers:["Saturn","Genesis","Game Gear"],difficulty:3},
    {category:"90s Pop Culture",question:"Which 1994 Quentin Tarantino film revived John Travolta's career?",correct_answer:"Pulp Fiction",incorrect_answers:["Reservoir Dogs","Kill Bill","Jackie Brown"],difficulty:3},
    {category:"90s Pop Culture",question:"What was the original name of the instant messaging service launched by Mirabilis in 1996?",correct_answer:"ICQ",incorrect_answers:["AIM","MSN Messenger","mIRC"],difficulty:3},
    {category:"90s Pop Culture",question:"Which band released the 90s hit 'Creep' and the album 'OK Computer'?",correct_answer:"Radiohead",incorrect_answers:["Oasis","Blur","Coldplay"],difficulty:3},
    {category:"90s Pop Culture",question:"What was the first commercially successful web browser, released in 1994?",correct_answer:"Netscape Navigator",incorrect_answers:["Internet Explorer","Mosaic","Opera"],difficulty:3},
    {category:"90s Pop Culture",question:"Which South African TV channel launched on October 1, 1998, bringing multi-channel digital satellite television to the country?",correct_answer:"DStv (Digital Satellite Television)",incorrect_answers:["e.tv","M-Net Series","SABC 3"],difficulty:3},

    // ── SA FOOD & SLANG ──
    {category:"SA Food & Slang",question:"What is bobotie?",correct_answer:"A spiced minced meat dish with an egg custard topping",incorrect_answers:["A type of sausage","A vegetable stew","A deep-fried pastry"],difficulty:1},
    {category:"SA Food & Slang",question:"What does the South African slang word 'lekker' mean?",correct_answer:"Nice, good, or great",incorrect_answers:["Ugly","Expensive","Tired"],difficulty:1},
    {category:"SA Food & Slang",question:"What is biltong?",correct_answer:"Dried, cured meat — a South African snack",incorrect_answers:["A type of bread","A spicy relish","A fermented drink"],difficulty:1},
    {category:"SA Food & Slang",question:"What does 'howzit' mean in South African slang?",correct_answer:"Hello / How are you?",incorrect_answers:["Goodbye","Thank you","I'm sorry"],difficulty:1},
    {category:"SA Food & Slang",question:"What is a 'bunny chow'?",correct_answer:"A hollowed-out loaf of bread filled with curry",incorrect_answers:["A rabbit stew","A vegetarian salad","A type of sandwich"],difficulty:1},
    {category:"SA Food & Slang",question:"What does 'ja' mean in South African English/Afrikaans?",correct_answer:"Yes",incorrect_answers:["No","Maybe","Hello"],difficulty:1},
    {category:"SA Food & Slang",question:"What is a koeksister?",correct_answer:"A syrup-coated twisted doughnut",incorrect_answers:["A chocolate cake","A meat pie","A biscuit"],difficulty:1},
    {category:"SA Food & Slang",question:"What does the slang word 'eish' express?",correct_answer:"Surprise, frustration, or disbelief",incorrect_answers:["Happiness","Agreement","Hunger"],difficulty:1},
    {category:"SA Food & Slang",question:"What is 'potjiekos'?",correct_answer:"A slow-cooked stew made in a cast-iron pot over coals",incorrect_answers:["A fried potato dish","A type of porridge","A baked pudding"],difficulty:1},
    {category:"SA Food & Slang",question:"What does 'braai' mean?",correct_answer:"To grill or barbecue meat over an open flame",incorrect_answers:["To bake bread","To fry in oil","To boil soup"],difficulty:1},
    {category:"SA Food & Slang",question:"What is 'melktert'?",correct_answer:"A traditional South African milk tart with cinnamon",incorrect_answers:["A cheese pie","A cream soda drink","A yoghurt dessert"],difficulty:2},
    {category:"SA Food & Slang",question:"What does the Afrikaans expression 'mooi' mean?",correct_answer:"Beautiful or pretty",incorrect_answers:["Ugly","Tall","Fast"],difficulty:2},
    {category:"SA Food & Slang",question:"What is 'chakalaka'?",correct_answer:"A spicy vegetable relish often served with pap and braai",incorrect_answers:["A type of dance","A brand of hot sauce","A grilled chicken dish"],difficulty:2},
    {category:"SA Food & Slang",question:"What does 'now now' mean in South African English?",correct_answer:"Soon, but not immediately",incorrect_answers:["Right this instant","Never","Yesterday"],difficulty:2},
    {category:"SA Food & Slang",question:"What is 'vetkoek'?",correct_answer:"Deep-fried dough bread, often filled with mince or jam",incorrect_answers:["A type of biscuit","A grilled sandwich","A dried fruit snack"],difficulty:2},
    {category:"SA Food & Slang",question:"What does 'sarmie' mean in South African slang?",correct_answer:"A sandwich",incorrect_answers:["A friend","A warm jacket","A small car"],difficulty:2},
    {category:"SA Food & Slang",question:"What is the origin city of the bunny chow?",correct_answer:"Durban",incorrect_answers:["Cape Town","Johannesburg","Pretoria"],difficulty:2},
    {category:"SA Food & Slang",question:"What does 'jol' mean in South African slang?",correct_answer:"To have a good time or party",incorrect_answers:["To run fast","To cook food","To sleep late"],difficulty:2},
    {category:"SA Food & Slang",question:"What is 'beskuit'?",correct_answer:"South African rusks — hard, dried biscuits for dipping in coffee or tea",incorrect_answers:["A type of cheese","A braai side dish","A breakfast cereal"],difficulty:2},
    {category:"SA Food & Slang",question:"What does the expression 'shame' often mean in South African English?",correct_answer:"An expression of sympathy or endearment (like 'oh, how sweet')",incorrect_answers:["Embarrassment only","An insult","Disappointment"],difficulty:2},
    {category:"SA Food & Slang",question:"What does 'dof' mean in Afrikaans slang?",correct_answer:"Stupid or dim-witted",incorrect_answers:["Clever","Angry","Hungry"],difficulty:2},
    {category:"SA Food & Slang",question:"What does 'voetsek' mean?",correct_answer:"Go away (a rude dismissal)",incorrect_answers:["Come here","Sit down","Eat up"],difficulty:2},
    {category:"SA Food & Slang",question:"What is 'umqombothi'?",correct_answer:"A traditional African beer made from maize and sorghum",incorrect_answers:["A type of bread","A spicy meat stew","A dried fruit snack"],difficulty:3},
    {category:"SA Food & Slang",question:"What is the Cape Malay origin dish 'denningvleis'?",correct_answer:"A sweet-and-sour lamb stew with tamarind",incorrect_answers:["A fish curry","A chicken stir-fry","A beef biltong recipe"],difficulty:3},
    {category:"SA Food & Slang",question:"What is the difference between a koeksister and a Cape Malay koesister?",correct_answer:"The Cape Malay version is spiced, coated in coconut, and not twisted",incorrect_answers:["There is no difference","One uses chocolate","The Cape Malay version is savoury"],difficulty:3},
    {category:"SA Food & Slang",question:"What does 'babbelas' mean in South African slang?",correct_answer:"A hangover",incorrect_answers:["A party","A nap","A headache medicine"],difficulty:3},
    {category:"SA Food & Slang",question:"What is 'waterblommetjiebredie'?",correct_answer:"A Cape stew made with water lily flowers and lamb",incorrect_answers:["A flower salad","A type of soup with seaweed","A vegetarian pasta dish"],difficulty:3},
    {category:"SA Food & Slang",question:"What does 'bakgat' mean in Afrikaans slang?",correct_answer:"Awesome or fantastic",incorrect_answers:["Terrible","Expensive","Boring"],difficulty:3},
    {category:"SA Food & Slang",question:"What is a 'gatsby' in Cape Town food culture?",correct_answer:"A massive sandwich filled with chips, meat, and sauce",incorrect_answers:["A fine-dining steak","A type of sushi roll","A cocktail"],difficulty:3},
    {category:"SA Food & Slang",question:"What does 'kif' or 'kief' mean in South African slang?",correct_answer:"Cool, great, or awesome",incorrect_answers:["Ugly","Broken","Slow"],difficulty:3},

    // ── FRENCHIES (Additional) ──
    {category:"Frenchies",question:"What is the term for the rare French Bulldog coat pattern with tan markings above the eyes, on cheeks, and legs?",correct_answer:"Black and tan",incorrect_answers:["Sable","Tuxedo","Harlequin"],difficulty:3},
    {category:"Frenchies",question:"At what age is a French Bulldog typically considered fully grown?",correct_answer:"Around 12-14 months",incorrect_answers:["6 months","3 years","2 years"],difficulty:2},
    {category:"Frenchies",question:"What is a common skin condition in French Bulldogs caused by their wrinkles?",correct_answer:"Skin fold dermatitis",incorrect_answers:["Mange","Ringworm","Eczema"],difficulty:2},
    {category:"Frenchies",question:"Which famous fashion designer was known for always having French Bulldogs as companions?",correct_answer:"Yves Saint Laurent",incorrect_answers:["Karl Lagerfeld","Coco Chanel","Giorgio Armani"],difficulty:3},
    {category:"Frenchies",question:"What is the ideal daily exercise duration for a French Bulldog?",correct_answer:"About 30-60 minutes of moderate activity",incorrect_answers:["2-3 hours of intense exercise","No exercise needed","4-5 short walks totaling 3 hours"],difficulty:2},
    {category:"Frenchies",question:"Why are French Bulldogs particularly sensitive to heat?",correct_answer:"Their short snouts make it hard to pant efficiently to cool down",incorrect_answers:["Their fur is too thick","They have no sweat glands at all","Their skin absorbs sunlight"],difficulty:1},
    {category:"Frenchies",question:"What is 'cherry eye' that commonly affects French Bulldogs?",correct_answer:"A prolapsed tear gland that appears as a red mass in the corner of the eye",incorrect_answers:["Red-colored eyes","An allergy to cherries","A type of eye infection"],difficulty:2},
    {category:"Frenchies",question:"What genetic test is recommended for French Bulldog breeders to check for a common spinal condition?",correct_answer:"Hemivertebrae screening",incorrect_answers:["Hip scoring","Elbow grading","Cardiac ultrasound"],difficulty:3},
    {category:"Frenchies",question:"How much does a French Bulldog puppy typically cost from a reputable breeder?",correct_answer:"$2,000 - $5,000 or more",incorrect_answers:["$100 - $300","$500 - $800","$10,000 - $20,000"],difficulty:2},
    {category:"Frenchies",question:"What is the French word for French Bulldog?",correct_answer:"Bouledogue Français",incorrect_answers:["Chien Français","Petit Taureau","Dogue de France"],difficulty:3},

    // ── HIKING (Additional) ──
    {category:"Hiking",question:"What is the name of the famous five-day hike through the Tsitsikamma forest to Storms River?",correct_answer:"The Otter Trail",incorrect_answers:["The Dolphin Trail","The Whale Trail","The Garden Route Trail"],difficulty:1},
    {category:"Hiking",question:"What is 'bonking' or 'hitting the wall' in hiking terminology?",correct_answer:"Sudden fatigue from depleted glycogen (energy) stores",incorrect_answers:["Bumping into a tree","Reaching the summit","Getting lost on the trail"],difficulty:2},
    {category:"Hiking",question:"Which South African hiking trail runs along the coast from Kalk Bay to Cape Point?",correct_answer:"The Hoerikwaggo Trail",incorrect_answers:["The Rim of Africa","The Otter Trail","The Whale Trail"],difficulty:3},
    {category:"Hiking",question:"What is the 'golden rule' of river crossings while hiking?",correct_answer:"Unbuckle your pack's hip belt so you can ditch it if you fall",incorrect_answers:["Always cross at the widest point","Only cross at night","Run across as fast as possible"],difficulty:2},
    {category:"Hiking",question:"What does HYOH stand for in long-distance hiking culture?",correct_answer:"Hike Your Own Hike",incorrect_answers:["Help Yourself On Hills","Have Your Own Headlamp","Hydrate Yourself On Hikes"],difficulty:3},
    {category:"Hiking",question:"What is the Rim of Africa trail?",correct_answer:"A 650 km trail along the mountain rim of the Western Cape",incorrect_answers:["A trail around the rim of a volcano in Tanzania","A coastal walk in Mozambique","A trail along Victoria Falls"],difficulty:3},
    {category:"Hiking",question:"What does a white blaze on a tree indicate on the Appalachian Trail?",correct_answer:"You are on the main trail",incorrect_answers:["Water source nearby","Campsite ahead","Trail closed"],difficulty:2},
    {category:"Hiking",question:"What is the name of the popular day hike to the top of Lion's Head in Cape Town?",correct_answer:"Lion's Head Trail",incorrect_answers:["Signal Hill Path","Devil's Peak Route","Kloof Corner Trail"],difficulty:1},
    {category:"Hiking",question:"What is a 'false summit' in mountaineering?",correct_answer:"A point that appears to be the peak but reveals more climbing beyond it",incorrect_answers:["A man-made platform","A summit that has been incorrectly measured","A hallucination at altitude"],difficulty:2},
    {category:"Hiking",question:"What is the highest point on the Drakensberg Grand Traverse?",correct_answer:"Thabana Ntlenyana at 3,482 metres",incorrect_answers:["Cathedral Peak at 3,004 metres","Giant's Castle at 3,315 metres","Champagne Castle at 3,377 metres"],difficulty:3},

    // ── SA WINES (Additional) ──
    {category:"SA Wines",question:"What is the Walker Bay wine region particularly renowned for?",correct_answer:"Cool-climate Pinot Noir and Chardonnay",incorrect_answers:["Fortified dessert wines","Pinotage only","Sparkling Chenin Blanc"],difficulty:2},
    {category:"SA Wines",question:"Which South African wine estate is famous for its red blend called 'Rubicon'?",correct_answer:"Meerlust",incorrect_answers:["Kanonkop","Rust en Vrede","Vergelegen"],difficulty:3},
    {category:"SA Wines",question:"What grape variety is Kanonkop estate most celebrated for?",correct_answer:"Pinotage",incorrect_answers:["Cabernet Sauvignon","Merlot","Shiraz"],difficulty:2},
    {category:"SA Wines",question:"What is the Tulbagh wine region known for apart from wine?",correct_answer:"Its historic Cape Dutch architecture and MCC sparkling wines",incorrect_answers:["Diamond mining","Ostrich farming","Surfing competitions"],difficulty:3},
    {category:"SA Wines",question:"Which South African wine estate produces the famous 'FMC' Chenin Blanc?",correct_answer:"Ken Forrester Wines",incorrect_answers:["Mullineux","DeMorgenzon","Raats Family"],difficulty:3},
    {category:"SA Wines",question:"What percentage Pinotage must a Cape Blend contain?",correct_answer:"30% to 70%",incorrect_answers:["At least 85%","10% to 20%","Exactly 50%"],difficulty:2},
    {category:"SA Wines",question:"What is the Durbanville wine region in Cape Town known for producing?",correct_answer:"Sauvignon Blanc and Merlot cooled by sea breezes",incorrect_answers:["Only dessert wines","Exclusively red wines","Brandy and port"],difficulty:2},
    {category:"SA Wines",question:"Which South African wine producer pioneered the natural wine movement in Swartland?",correct_answer:"Eben Sadie (Sadie Family Wines)",incorrect_answers:["Johan Reyneke","Charles Back","Adi Badenhorst"],difficulty:3},
    {category:"SA Wines",question:"What does 'old vine' (ou wingerd) typically mean for South African Chenin Blanc?",correct_answer:"Vines that are at least 35-40 years old, producing more concentrated wine",incorrect_answers:["Vines older than 5 years","Vines that produce white wine only","Vines planted by the Dutch settlers"],difficulty:2},
    {category:"SA Wines",question:"What is the Klein Karoo region most famous for in South African wine?",correct_answer:"Fortified wines, Muscadel, and port-style wines",incorrect_answers:["Sparkling MCC wine","Pinot Noir","Riesling"],difficulty:2},

    // ── PARIS (Additional) ──
    {category:"Paris",question:"What is the name of the large park on the eastern edge of Paris that contains a zoo and a lake?",correct_answer:"Bois de Vincennes",incorrect_answers:["Bois de Boulogne","Jardin des Tuileries","Parc Monceau"],difficulty:2},
    {category:"Paris",question:"What famous Parisian department store has a spectacular stained-glass dome and rooftop terrace?",correct_answer:"Galeries Lafayette",incorrect_answers:["Le Bon Marché","Printemps","Samaritaine"],difficulty:1},
    {category:"Paris",question:"How many steps does it take to climb to the second floor of the Eiffel Tower?",correct_answer:"674 steps",incorrect_answers:["300 steps","1,200 steps","450 steps"],difficulty:3},
    {category:"Paris",question:"Which Parisian neighborhood is known as the city's Chinatown?",correct_answer:"The 13th arrondissement (Quartier Asiatique)",incorrect_answers:["The 5th arrondissement","Montmartre","Belleville"],difficulty:2},
    {category:"Paris",question:"What painting is the most famous work housed in the Louvre?",correct_answer:"The Mona Lisa by Leonardo da Vinci",incorrect_answers:["The Winged Victory of Samothrace","Liberty Leading the People","The Wedding at Cana"],difficulty:1},
    {category:"Paris",question:"What is the name of the Parisian covered passages built in the 19th century for upscale shopping?",correct_answer:"Les Passages Couverts",incorrect_answers:["Les Grands Boulevards","Les Arcades","Les Halles"],difficulty:3},
    {category:"Paris",question:"Which French king built the Palace of Versailles outside Paris?",correct_answer:"Louis XIV",incorrect_answers:["Louis XVI","Napoleon Bonaparte","Louis XV"],difficulty:2},
    {category:"Paris",question:"What is the Place de la Concorde known for historically?",correct_answer:"It was the site of many guillotine executions during the French Revolution",incorrect_answers:["It was Napoleon's military headquarters","It was a Roman amphitheatre","It was a medieval marketplace"],difficulty:2},
    {category:"Paris",question:"What is the tallest skyscraper in Paris proper as of 2024?",correct_answer:"Tour Montparnasse",incorrect_answers:["The Eiffel Tower","Tour First","The Louvre Pyramid"],difficulty:3},
    {category:"Paris",question:"What is the famous Parisian literary café on Boulevard Saint-Germain frequented by Sartre and de Beauvoir?",correct_answer:"Café de Flore",incorrect_answers:["Le Procope","Les Deux Magots","La Coupole"],difficulty:3},

    // ── CHEESES (Additional) ──
    {category:"Cheeses",question:"What South African cheese brand is well-known for its range of Gouda and Cheddar?",correct_answer:"Lancewood",incorrect_answers:["Clover","Parmalat","Woolworths"],difficulty:1},
    {category:"Cheeses",question:"What is 'queso' simply the Spanish word for?",correct_answer:"Cheese",incorrect_answers:["Milk","Cream","Butter"],difficulty:1},
    {category:"Cheeses",question:"What type of cheese is Manchego, and which country does it come from?",correct_answer:"A firm sheep's milk cheese from Spain",incorrect_answers:["A soft cow's milk cheese from Mexico","A blue cheese from Portugal","A goat cheese from Italy"],difficulty:2},
    {category:"Cheeses",question:"What is the Danish cheese with a mild, creamy taste often used in sandwiches?",correct_answer:"Havarti",incorrect_answers:["Danbo","Esrom","Maribo"],difficulty:2},
    {category:"Cheeses",question:"What cheese is traditionally used in a Greek spanakopita?",correct_answer:"Feta",incorrect_answers:["Halloumi","Kasseri","Mozzarella"],difficulty:2},
    {category:"Cheeses",question:"How is ricotta cheese traditionally made?",correct_answer:"From the whey left over from making other cheeses",incorrect_answers:["From buffalo milk only","By aging fresh mozzarella","By smoking cheddar curds"],difficulty:2},
    {category:"Cheeses",question:"What is Epoisses de Bourgogne famous for?",correct_answer:"Being one of the smelliest cheeses in the world, washed in brandy",incorrect_answers:["Being the hardest cheese ever made","Having a bright blue rind","Being made from reindeer milk"],difficulty:3},
    {category:"Cheeses",question:"What cheese is produced on the Italian island of Sardinia and is known for containing live insect larvae?",correct_answer:"Casu marzu",incorrect_answers:["Pecorino Sardo","Fiore Sardo","Canestrato"],difficulty:3},
    {category:"Cheeses",question:"What is the Italian term for a cheese shop or cheese seller?",correct_answer:"Formaggeria",incorrect_answers:["Salumeria","Panetteria","Gelateria"],difficulty:3},
    {category:"Cheeses",question:"Which Japanese cheese variety is made with sake lees and won international awards?",correct_answer:"Sakura cheese",incorrect_answers:["Tofu cheese","Miso cheese","Wasabi Gouda"],difficulty:3},

    // ── TRUE OR FALSE ──
    {category:"True or False",question:"An octopus has three hearts -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:1},
    {category:"True or False",question:"The Great Wall of China is visible from space with the naked eye -- true or false?",correct_answer:"False",incorrect_answers:["True"],difficulty:1},
    {category:"True or False",question:"Honey never spoils and has been found edible in ancient Egyptian tombs -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:1},
    {category:"True or False",question:"Lightning never strikes the same place twice -- true or false?",correct_answer:"False",incorrect_answers:["True"],difficulty:1},
    {category:"True or False",question:"South Africa has three capital cities -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:1},
    {category:"True or False",question:"Table Mountain in Cape Town is one of the New7Wonders of Nature -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:1},
    {category:"True or False",question:"A group of flamingos is called a 'flamboyance' -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:2},
    {category:"True or False",question:"Goldfish have a memory span of only three seconds -- true or false?",correct_answer:"False",incorrect_answers:["True"],difficulty:2},
    {category:"True or False",question:"Bananas are technically berries -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:2},
    {category:"True or False",question:"Mount Everest is the tallest mountain in the solar system -- true or false?",correct_answer:"False",incorrect_answers:["True"],difficulty:2},
    {category:"True or False",question:"Venus is the hottest planet in our solar system -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:2},
    {category:"True or False",question:"The Amazon River is the longest river in the world -- true or false?",correct_answer:"False",incorrect_answers:["True"],difficulty:2},
    {category:"True or False",question:"Coca-Cola was originally green in color -- true or false?",correct_answer:"False",incorrect_answers:["True"],difficulty:2},
    {category:"True or False",question:"Biltong and jerky are made using the same process -- true or false?",correct_answer:"False",incorrect_answers:["True"],difficulty:2},
    {category:"True or False",question:"A crocodile cannot stick its tongue out -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:2},
    {category:"True or False",question:"Humans share about 60% of their DNA with bananas -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:3},
    {category:"True or False",question:"Sharks are older than trees in evolutionary terms -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:3},
    {category:"True or False",question:"The human body contains enough iron to make a small nail -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:3},
    {category:"True or False",question:"Australia is wider than the Moon's diameter -- true or false?",correct_answer:"True",incorrect_answers:["False"],difficulty:3},
    {category:"True or False",question:"Ostriches bury their heads in the sand when scared -- true or false?",correct_answer:"False",incorrect_answers:["True"],difficulty:1},
  ];

  // ═══════════════════════════════════════
  //  STATE
  // ═══════════════════════════════════════
  let settings = { timer: 15, category: '', rounds: 10 };
  let questions = [];
  let currentQ = 0;

  // Two-player state
  let players = {
    burden: { name: 'Burden', score: 0, streak: 0, bestStreak: 0, correctCount: 0, totalTime: 0 },
    stu: { name: 'Stu', score: 0, streak: 0, bestStreak: 0, correctCount: 0, totalTime: 0 }
  };
  let currentPlayer = 'burden';

  let timerInterval = null;
  let timeLeft = 0;
  let prevTimeLeft = 0;
  let answered = false;
  let gameLoading = false;
  let ttsPlaying = false;

  // ── Cascade state (to track ongoing cascade animations) ──
  let cascadeInProgress = false;
  let voiceEnabled = false;
  let voiceId = '21m00Tcm4TlvDq8ikWAM';
  let lifetimeStats = null;
  // ── Achievement tracking state ──
  var gameTracker = {
    answerTimes: { burden: [], stu: [] },
    scoreDiffs: [],
    secondAnswerers: [],
    fastAnswers: { burden: 0, stu: 0 },
    blitzAnswers: { burden: false, stu: false },
    previousScores: { burden: null, stu: null }
  };
  var achievementCache = { burden: null, stu: null };

  // ═══════════════════════════════════════
  //  NAVIGATION
  // ═══════════════════════════════════════
  function showScreen(id) {
    sfxWhoosh();
    var current = document.querySelector('.screen.active');
    var next = document.getElementById('screen-' + id);

    // Animate the leaving screen with scale-down + fade
    if (current && current !== next) {
      current.classList.remove('active');
      current.classList.add('screen-leaving');
      setTimeout(function() { current.classList.remove('screen-leaving'); }, 200);
    } else {
      document.querySelectorAll('.screen').forEach(function(s) { s.classList.remove('active'); });
    }

    // Slight delay so leaving animation starts, then entering overlaps
    setTimeout(function() {
      document.querySelectorAll('.screen').forEach(function(s) {
        if (s !== next) s.classList.remove('active');
      });
      next.classList.add('active');
    }, 50);
    // Clear confetti when leaving results
    if (id !== 'results') {
      var confetti = document.getElementById('confetti-container');
      if (confetti) confetti.innerHTML = '';
    }
    // Music transitions — title music for menu screens
    if (['title', 'settings', 'howto', 'leaderboard', 'achievements', 'pin', 'admin'].indexOf(id) !== -1) {
      Music.title();
    }
    // Refresh stats when entering leaderboard or title
    if (id === 'leaderboard' || id === 'title') {
      loadLifetimeStats();
    }
    // Render achievements screen when entering it
    if (id === 'achievements') {
      renderAchievementsScreen();
    }
    // Clear tension state when leaving game
    if (id !== 'game') {
      clearTension();
    }
    // Reset PIN entry when entering pin screen
    if (id === 'pin') {
      pinBuffer = '';
      updatePinDots();
    }
    // Focus first button
    setTimeout(function() {
      var btn = document.querySelector('#screen-' + id + ' .btn, #screen-' + id + ' .pill, #screen-' + id + ' .answer-btn');
      if (btn) btn.focus();
    }, 150);
  }

  function selectPill(el, group) {
    el.parentElement.querySelectorAll('.pill').forEach(p => p.classList.remove('selected'));
    el.classList.add('selected');
    sfxTick();
    // Persist settings to localStorage
    try {
      const saved = JSON.parse(localStorage.getItem('brainblitz_settings') || '{}');
      saved[group] = el.dataset.val;
      localStorage.setItem('brainblitz_settings', JSON.stringify(saved));
    } catch(e) {}
    // Language change — apply immediately
    if (group === 'lang') {
      gameLang = el.dataset.val;
      applyLanguage();
    }
  }

  function getSelected(groupId) {
    const pill = document.querySelector('#' + groupId + '-pills .pill.selected');
    return pill ? pill.dataset.val : '';
  }

  // Restore saved settings from localStorage
  function restoreSettings() {
    try {
      const saved = JSON.parse(localStorage.getItem('brainblitz_settings') || '{}');
      Object.entries(saved).forEach(([group, val]) => {
        const pills = document.querySelectorAll('#' + group + '-pills .pill');
        pills.forEach(p => {
          if (p.dataset.val === val) {
            p.parentElement.querySelectorAll('.pill').forEach(pp => pp.classList.remove('selected'));
            p.classList.add('selected');
          }
        });
      });
    } catch(e) {}
  }

  function showError(msg) {
    document.getElementById('error-message').textContent = msg;
    showScreen('error');
  }

  // ═══════════════════════════════════════
  //  CONFETTI
  // ═══════════════════════════════════════
  function createConfetti() {
    const container = document.getElementById('confetti-container');
    container.innerHTML = '';
    const colors = ['#00f0ff', '#ff2d78', '#ffe600', '#00ff88', '#b44dff', '#ffd700'];
    for (let i = 0; i < 60; i++) {
      const piece = document.createElement('div');
      piece.className = 'confetti-piece';
      piece.style.left = Math.random() * 100 + '%';
      piece.style.backgroundColor = colors[Math.floor(Math.random() * colors.length)];
      piece.style.animationDelay = (Math.random() * 3) + 's';
      piece.style.animationDuration = (2 + Math.random() * 3) + 's';
      piece.style.width = (6 + Math.random() * 8) + 'px';
      piece.style.height = (6 + Math.random() * 8) + 'px';
      piece.style.borderRadius = Math.random() > 0.5 ? '50%' : '0';
      container.appendChild(piece);
    }
  }

  // ═══════════════════════════════════════
  //  GAME LOGIC
  // ═══════════════════════════════════════
  async function startGame() {
    if (gameLoading) return;
    gameLoading = true;

    try {
      settings.timer = parseInt(getSelected('timer')) || 15;
      settings.category = getSelected('cat');
      settings.rounds = parseInt(getSelected('rounds')) || 10;
      const voiceSetting = getSelected('voice');
      voiceEnabled = voiceSetting !== 'off';
      voiceId = voiceSetting === 'custom' ? '5W1ijlUigww8GacnRjZV' : '21m00Tcm4TlvDq8ikWAM';

      // Reset both players
      players.burden = { name: 'Burden', score: 0, streak: 0, bestStreak: 0, correctCount: 0, totalTime: 0 };
      players.stu = { name: 'Stu', score: 0, streak: 0, bestStreak: 0, correctCount: 0, totalTime: 0 };
      currentPlayer = 'burden';
      currentQ = 0;
      // Reset cascade state
      cascadeInProgress = false;

      // Reset achievement tracker for this game
      gameTracker.answerTimes = { burden: [], stu: [] };
      gameTracker.scoreDiffs = [0];
      gameTracker.secondAnswerers = [];
      gameTracker.fastAnswers = { burden: 0, stu: 0 };
      gameTracker.blitzAnswers = { burden: false, stu: false };
      // Load previous scores for "Consistent" achievement
      try {
        var prevScores = JSON.parse(localStorage.getItem('brainblitz_prev_scores') || '{}');
        gameTracker.previousScores.burden = (prevScores.burden !== undefined) ? prevScores.burden : null;
        gameTracker.previousScores.stu = (prevScores.stu !== undefined) ? prevScores.stu : null;
      } catch(e) {
        gameTracker.previousScores = { burden: null, stu: null };
      }

      selectQuestions();

      if (questions.length === 0) {
        showError('Not enough questions for that category. Try fewer rounds or "Any" category.');
        return;
      }
      if (questions.length < settings.rounds) {
        // Silently adjust — play with what we have
        settings.rounds = questions.length;
      }

      sfxStart();
      Music.game();
      showScreen('game');
      showTurnSwitch(currentPlayer, () => {
        showRoundSplash(1, () => loadQuestion());
      });
    } finally {
      gameLoading = false;
    }
  }

  // === DIFFICULTY-AWARE QUESTION SELECTION ===
  function selectQuestions() {
    var pool = [], i;
    for (i = 0; i < QUESTION_BANK.length; i++) pool.push(Object.assign({}, QUESTION_BANK[i]));
    if (settings.category) {
      pool = pool.filter(function(q) {
        return q.category === settings.category || q.category.toLowerCase() === settings.category.toLowerCase();
      });
    }
    shuffleArray(pool);
    // Auto-assign difficulty to questions that lack it
    var third = Math.ceil(pool.length / 3);
    for (i = 0; i < pool.length; i++) {
      if (!(pool[i].difficulty >= 1 && pool[i].difficulty <= 3)) {
        pool[i].difficulty = i < third ? 1 : (i < third * 2 ? 2 : 3);
      }
    }
    // Bucket by difficulty
    var easy = [], medium = [], hard = [];
    for (i = 0; i < pool.length; i++) {
      if (pool[i].difficulty === 1) easy.push(pool[i]);
      else if (pool[i].difficulty === 2) medium.push(pool[i]);
      else hard.push(pool[i]);
    }
    shuffleArray(easy); shuffleArray(medium); shuffleArray(hard);
    // First third easy, middle third medium, final third hard
    var total = Math.min(settings.rounds, pool.length);
    var ec = Math.round(total / 3), mc = Math.round(total / 3), hc = total - ec - mc;
    if (ec > easy.length) { mc += ec - easy.length; ec = easy.length; }
    if (mc > medium.length) { hc += mc - medium.length; mc = medium.length; }
    if (hc > hard.length) {
      var ov = hc - hard.length; hc = hard.length;
      var em = Math.min(ov, medium.length - mc); mc += em; ov -= em;
      ec += Math.min(ov, easy.length - ec);
    }
    questions = easy.slice(0, ec).concat(medium.slice(0, mc)).concat(hard.slice(0, hc));
  }

  // Get difficulty multiplier for base scoring
  function getDifficultyMultiplier(q) {
    var d = (q && q.difficulty) || 1;
    return d === 2 ? 1.5 : (d === 3 ? 2 : 1);
  }

  // Update difficulty badge in HUD
  function updateDifficultyHUD(q) {
    var d = (q && q.difficulty) || 1;
    var el = document.getElementById('hud-difficulty');
    if (!el) return;
    var label = d === 1 ? 'EASY' : (d === 2 ? 'MEDIUM' : 'HARD');
    var cls = d === 1 ? 'diff-easy' : (d === 2 ? 'diff-medium' : 'diff-hard');
    var stars = d === 1 ? '★' : (d === 2 ? '★★' : '★★★');
    el.innerHTML = '<span class="difficulty-badge ' + cls + '">' + label +
      ' <span class="difficulty-stars">' + stars + '</span></span>';
  }

  function decodeHTML(html) {
    const txt = document.createElement('textarea');
    txt.innerHTML = html;
    return txt.value;
  }

  function shuffleArray(arr) {
    for (let i = arr.length - 1; i > 0; i--) {
      const j = Math.floor(Math.random() * (i + 1));
      [arr[i], arr[j]] = [arr[j], arr[i]];
    }
    return arr;
  }

  let turnSwitchInterval = null;

  function showTurnSwitch(playerKey, cb) {
    if (turnSwitchInterval) { clearInterval(turnSwitchInterval); turnSwitchInterval = null; }
    const overlay = document.getElementById('turn-switch');
    const nameEl = document.getElementById('turn-switch-name');
    const countEl = document.getElementById('turn-switch-countdown');
    const name = players[playerKey].name.toUpperCase();
    const color = playerKey === 'burden' ? 'var(--neon-cyan)' : 'var(--neon-pink)';

    nameEl.textContent = name;
    nameEl.style.color = color;
    nameEl.style.textShadow = `0 0 40px ${playerKey === 'burden' ? 'rgba(0,240,255,0.5)' : 'rgba(255,45,120,0.5)'}`;

    let count = 2;
    countEl.textContent = count;
    overlay.classList.add('show');
    sfxTick();

    turnSwitchInterval = setInterval(() => {
      count--;
      if (count > 0) {
        countEl.textContent = count;
        sfxTick();
      } else {
        clearInterval(turnSwitchInterval);
        turnSwitchInterval = null;
        overlay.classList.remove('show');
        if (cb) cb();
      }
    }, 400);
  }

  function showRoundSplash(num, cb) {
    const splash = document.getElementById('round-splash');
    document.getElementById('round-number').textContent = num;
    splash.classList.add('show');
    sfxTick();
    setTimeout(() => {
      splash.classList.remove('show');
      if (cb) cb();
    }, 500);
  }

  async function loadQuestion() {
    if (currentQ >= questions.length) {
      endGame();
      return;
    }

    answered = false;
    ttsPlaying = false;
    const q = questions[currentQ];
    const answers = shuffleArray([
      ...q.incorrect_answers.map(a => ({ text: decodeHTML(a), correct: false })),
      { text: decodeHTML(q.correct_answer), correct: true }
    ]);

    document.getElementById('hud-question').textContent = `${currentQ + 1}/${questions.length}`;

    // Update current player display
    const playerEl = document.getElementById('hud-player');
    playerEl.innerHTML = players[currentPlayer].name +
      (voiceEnabled ? '<span id="hud-speaker" class="hud-speaker">&#128264;</span>' : '');
    playerEl.style.color = currentPlayer === 'burden' ? 'var(--neon-cyan)' : 'var(--neon-pink)';

    document.getElementById('hud-burden-score').textContent = formatScore(players.burden.score);
    document.getElementById('hud-stu-score').textContent = formatScore(players.stu.score);
    document.getElementById('q-category').textContent = decodeHTML(q.category);
    document.getElementById('q-text').textContent = decodeHTML(q.question);

    // Update difficulty badge in HUD
    updateDifficultyHUD(q);

    // Update turn indicator
    document.getElementById('hud-burden-section').classList.remove('active-turn', 'stu-turn');
    document.getElementById('hud-stu-section').classList.remove('active-turn', 'stu-turn');
    if (currentPlayer === 'burden') {
      document.getElementById('hud-burden-section').classList.add('active-turn');
    } else {
      document.getElementById('hud-stu-section').classList.add('active-turn', 'stu-turn');
    }

    const grid = document.getElementById('answers-grid');
    const letters = ['A', 'B', 'C', 'D'];
    grid.innerHTML = answers.map((a, i) => `
      <button class="answer-btn" data-correct="${a.correct}" data-index="${i}" onclick="selectAnswer(this)">
        <span class="letter">${letters[i]}</span>
        <span>${a.text}</span>
      </button>
    `).join('');

    // TTS: read question aloud if enabled
    if (voiceEnabled) {
      ttsPlaying = true;
      const speaker = document.getElementById('hud-speaker');
      if (speaker) speaker.classList.add('loading');
      const questionText = decodeHTML(q.question);
      await playQuestionTTS(questionText);
      if (speaker) speaker.classList.remove('loading');
      ttsPlaying = false;
    }

    // Start timer AFTER TTS finishes
    startQuestionTimer();

    // Focus first answer for keyboard nav
    setTimeout(() => {
      const first = grid.querySelector('.answer-btn');
      if (first) first.focus();
    }, 100);
  }

  var timerRAF = null;

  function startQuestionTimer() {
    timeLeft = settings.timer;
    prevTimeLeft = settings.timer;
    var fill = document.getElementById('timer-fill');

    // Reset: remove all animation classes and force reflow
    fill.classList.remove('timer-running', 'timer-pulse', 'timer-pulse-tense', 'danger');
    fill.style.animation = 'none';
    fill.style.transform = 'scaleX(1)';
    void fill.offsetHeight; // force reflow

    // Set CSS custom property for duration and start CSS animation
    fill.style.setProperty('--timer-duration', settings.timer + 's');
    fill.style.animation = '';
    fill.classList.add('timer-running');

    // Cancel any previous rAF loop
    if (timerRAF) { cancelAnimationFrame(timerRAF); timerRAF = null; }

    // rAF loop only handles: countdown beeps, danger class, music intensity, timeout
    // The actual bar animation is driven purely by CSS for GPU-accelerated smoothness
    var startTime = Date.now();
    var dangerTriggered = false;

    function timerTick() {
      var elapsed = (Date.now() - startTime) / 1000;
      timeLeft = Math.max(0, settings.timer - elapsed);
      var pct = (timeLeft / settings.timer) * 100;

      // Add danger styling at 30%
      if (pct < 30 && !dangerTriggered) {
        dangerTriggered = true;
        fill.classList.add('danger');
        // Switch to pulsing animation (keeps shrink + adds pulse)
        var isTense = document.querySelector('.bg-glow.tense');
        fill.classList.remove('timer-running');
        fill.classList.add(isTense ? 'timer-pulse-tense' : 'timer-pulse');
      }

      // Countdown beeps at 3, 2, 1
      if (timeLeft <= 3 && timeLeft > 0 && Math.floor(prevTimeLeft) !== Math.floor(timeLeft)) {
        sfxCountdown();
      }
      prevTimeLeft = timeLeft;

      // Ramp up music intensity as timer runs down
      Music.setIntensity(1 - (timeLeft / settings.timer));

      // Check close game tension each frame
      checkTension();

      if (timeLeft <= 0) {
        timerRAF = null;
        fill.classList.remove('timer-running', 'timer-pulse', 'timer-pulse-tense');
        if (!answered) timeUp();
        return;
      }

      timerRAF = requestAnimationFrame(timerTick);
    }

    timerRAF = requestAnimationFrame(timerTick);
  }

  function stopQuestionTimer() {
    if (timerRAF) { cancelAnimationFrame(timerRAF); timerRAF = null; }
    var fill = document.getElementById('timer-fill');
    // Freeze the CSS animation at current position
    var computed = window.getComputedStyle(fill);
    var currentTransform = computed.transform || computed.webkitTransform || 'scaleX(1)';
    fill.classList.remove('timer-running', 'timer-pulse', 'timer-pulse-tense');
    fill.style.animation = 'none';
    fill.style.transform = currentTransform;
  }

  // =======================================
  //  ANSWER CASCADE ANIMATION
  // =======================================
  // Reveals answers one-by-one for dramatic effect.
  // selectedBtn: the button the player clicked (or null for timeout)
  // callback: called when cascade is complete
  function runCascade(selectedBtn, callback) {
    cascadeInProgress = true;
    var allBtns = [].slice.call(document.querySelectorAll('#answers-grid .answer-btn'));
    var isCorrect = selectedBtn && selectedBtn.dataset.correct === 'true';

    // Step 1: Disable all buttons immediately, light up selected (300ms)
    allBtns.forEach(function(b) { b.classList.add('disabled'); });

    if (selectedBtn) {
      if (isCorrect) {
        selectedBtn.classList.add('correct');
      } else {
        selectedBtn.classList.add('wrong', 'shake-wrong');
      }
    }

    // Collect wrong answers that were NOT the selected button
    var wrongBtns = [];
    var correctBtn = null;
    allBtns.forEach(function(b) {
      if (b.dataset.correct === 'true') { correctBtn = b; }
      else if (b !== selectedBtn) { wrongBtns.push(b); }
    });
    // Shuffle the wrong buttons for variety
    shuffleArray(wrongBtns);

    // Step 2: After 150ms, start dimming wrong answers one by one (120ms each)
    setTimeout(function() {
      var delay = 0;
      wrongBtns.forEach(function(wb) {
        setTimeout(function() {
          wb.classList.add('cascade-dim');
        }, delay);
        delay += 120;
      });

      // Step 3: After all wrongs dimmed, give correct answer its full glow (100ms)
      setTimeout(function() {
        if (correctBtn && correctBtn !== selectedBtn) {
          correctBtn.classList.add('cascade-correct', 'pulse-correct');
        } else if (correctBtn && isCorrect) {
          correctBtn.classList.add('pulse-correct');
        }
        cascadeInProgress = false;
        if (callback) callback();
      }, delay + 100);
    }, 150);
  }

  // =======================================
  //  ADVANCE TO NEXT QUESTION (shared)
  // =======================================
  function advanceAfterAnswer() {
    currentQ++;
    if (currentQ < questions.length) {
      showTurnSwitch(currentPlayer, function() {
        showRoundSplash(currentQ + 1, function() { loadQuestion(); });
      });
    } else {
      endGame();
    }
  }

  // =======================================
  //  SELECT ANSWER (cascade + difficulty)
  // =======================================
  function selectAnswer(btn) {
    if (answered || ttsPlaying) return;
    answered = true;
    stopQuestionTimer();
    ensureAudio();

    var isCorrect = btn.dataset.correct === 'true';
    var elapsed = settings.timer - timeLeft;
    var player = players[currentPlayer];
    player.totalTime += elapsed;

    // Get current question's difficulty multiplier
    var q = questions[currentQ];
    var diffMult = getDifficultyMultiplier(q);

    // Run the cascade reveal animation
    runCascade(btn, null);

    if (isCorrect) {
      sfxCorrect();
      player.streak++;
      if (player.streak > player.bestStreak) player.bestStreak = player.streak;
      player.correctCount++;

      // Score: (base * difficulty multiplier) + speed bonus + streak bonus
      var basePoints = Math.round(100 * diffMult);
      var speedBonus = Math.round((timeLeft / settings.timer) * 100);
      var streakBonus = Math.min(player.streak, 5) * 20;
      var points = basePoints + speedBonus + streakBonus;
      player.score += points;

      spawnParticles(btn, 12);
      showFeedback('correct');
      if (player.streak >= 3) {
        var streakMsgs = [
          '\ud83d\udd25 ' + player.streak + "x STREAK! Jy's op Vuur! +" + streakBonus,
          '\ud83d\udd25 ' + player.streak + 'x STREAK! Moerse Lekker! +' + streakBonus,
          '\ud83d\udd25 ' + player.streak + 'x STREAK! Nou Gaan Ons Braai! +' + streakBonus,
          '\ud83d\udd25 ' + player.streak + 'x STREAK! Hou So! +' + streakBonus
        ];
        showBonus(streakMsgs[Math.floor(Math.random() * streakMsgs.length)]);
        // 5+ streak: full celebration with border glow, ON FIRE overlay, crowd cheer
        if (player.streak >= 5) {
          triggerStreakCelebration();
        }
      }
    } else {
      sfxWrong();
      player.streak = 0;
      showFeedback('wrong');
    }

    // Update HUD scores
    updateScoreDisplay('hud-burden-score', players.burden.score);
    updateScoreDisplay('hud-stu-score', players.stu.score);

    // Track data for achievements
    gameTracker.answerTimes[currentPlayer].push(elapsed);
    if (isCorrect && elapsed < 3) gameTracker.fastAnswers[currentPlayer]++;
    if (isCorrect && elapsed < 1) gameTracker.blitzAnswers[currentPlayer] = true;
    gameTracker.scoreDiffs.push(players.burden.score - players.stu.score);
    if (currentQ % 2 === 1) gameTracker.secondAnswerers.push(currentPlayer);

    // Alternate turn for the NEXT question
    currentPlayer = currentPlayer === 'burden' ? 'stu' : 'burden';

    // After feedback delay: advance to next question
    setTimeout(function() {
      advanceAfterAnswer();
    }, 800);
  }

  // =======================================
  //  TIME UP (cascade)
  // =======================================
  function timeUp() {
    answered = true;
    var player = players[currentPlayer];
    player.streak = 0;
    player.totalTime += settings.timer;

    // Run cascade animation (no selected button — just reveals correct)
    runCascade(null, null);

    sfxWrong();
    showFeedback('timeout');

    // Track timeout for achievements
    gameTracker.answerTimes[currentPlayer].push(settings.timer);
    gameTracker.scoreDiffs.push(players.burden.score - players.stu.score);
    if (currentQ % 2 === 1) gameTracker.secondAnswerers.push(currentPlayer);

    // Alternate players
    currentPlayer = currentPlayer === 'burden' ? 'stu' : 'burden';

    setTimeout(function() {
      advanceAfterAnswer();
    }, 800);
  }


  // Format number with commas
  function formatScore(n) {
    return n.toString().replace(/\B(?=(\d{3})+(?!\d))/g, ',');
  }

  // Update score display with pop animation
  function updateScoreDisplay(id, score) {
    const el = document.getElementById(id);
    const oldText = el.textContent;
    const newText = formatScore(score);
    if (oldText !== newText) {
      el.textContent = newText;
      el.classList.remove('score-pop');
      void el.offsetHeight; // force reflow
      el.classList.add('score-pop');
    }
  }

  // Spawn particles at element position
  function spawnParticles(sourceEl, count) {
    const rect = sourceEl.getBoundingClientRect();
    const cx = rect.left + rect.width / 2;
    const cy = rect.top + rect.height / 2;
    const colors = ['var(--neon-cyan)', 'var(--neon-green)', 'var(--neon-yellow)', '#fff'];
    for (let i = 0; i < count; i++) {
      const p = document.createElement('div');
      p.className = 'particle';
      p.style.left = cx + 'px';
      p.style.top = cy + 'px';
      p.style.background = colors[Math.floor(Math.random() * colors.length)];
      p.style.opacity = '1';
      document.body.appendChild(p);
      const angle = (Math.PI * 2 * i) / count;
      const dist = 40 + Math.random() * 60;
      const dx = Math.cos(angle) * dist;
      const dy = Math.sin(angle) * dist;
      p.animate([
        { transform: 'translate(0,0) scale(1)', opacity: 1 },
        { transform: `translate(${dx}px,${dy}px) scale(0)`, opacity: 0 }
      ], { duration: 500, easing: 'ease-out' });
      setTimeout(() => p.remove(), 550);
    }
  }

  // Animate number counting up from 0
  function animateCounter(el, target, duration) {
    const start = performance.now();
    const end = start + duration;
    function tick(now) {
      const progress = Math.min((now - start) / duration, 1);
      el.textContent = formatScore(Math.round(target * progress));
      if (progress < 1) requestAnimationFrame(tick);
    }
    requestAnimationFrame(tick);
  }

  function showFeedback(type) {
    const overlay = document.getElementById('feedback-overlay');
    const text = document.getElementById('feedback-text');
    text.className = 'feedback-text';

    if (type === 'correct') {
      var msgs = t('correctFb');
      text.textContent = msgs[Math.floor(Math.random() * msgs.length)];
      text.classList.add('correct-fb');
    } else if (type === 'wrong') {
      var msgs = t('wrongFb');
      text.textContent = msgs[Math.floor(Math.random() * msgs.length)];
      text.classList.add('wrong-fb');
    } else {
      text.textContent = t('timeoutFb');
      text.classList.add('timeout-fb');
    }

    overlay.classList.add('show');
    // Force re-trigger animation
    text.style.animation = 'none';
    text.offsetHeight;
    text.style.animation = '';

    setTimeout(() => overlay.classList.remove('show'), 700);
  }

  function showBonus(msg) {
    const el = document.getElementById('bonus-popup');
    el.textContent = msg;
    el.classList.add('show');
    setTimeout(() => el.classList.remove('show'), 900);
  }

  function endGame() {
    stopQuestionTimer();

    // Display Burden's stats
    document.getElementById('res-burden-score').textContent = players.burden.score;
    document.getElementById('res-burden-correct').textContent = players.burden.correctCount;
    document.getElementById('res-burden-streak').textContent = players.burden.bestStreak;

    // Display Stu's stats
    document.getElementById('res-stu-score').textContent = players.stu.score;
    document.getElementById('res-stu-correct').textContent = players.stu.correctCount;
    document.getElementById('res-stu-streak').textContent = players.stu.bestStreak;

    // Reset column classes
    const burdenCol = document.getElementById('res-burden-col');
    const stuCol = document.getElementById('res-stu-col');
    burdenCol.className = 'result-column';
    stuCol.className = 'result-column';
    burdenCol.style.textAlign = 'center';
    stuCol.style.textAlign = 'center';

    const trophy = document.getElementById('res-trophy');

    // Determine winner
    let winnerText = '';
    if (players.burden.score > players.stu.score) {
      winnerText = t('burdenWins');
      burdenCol.classList.add('winner-column');
      stuCol.classList.add('loser-column');
      trophy.style.display = 'block';
      sfxVictory();
      Music.victory();
      createConfetti();
    } else if (players.stu.score > players.burden.score) {
      winnerText = t('stuWins');
      stuCol.classList.add('winner-column');
      burdenCol.classList.add('loser-column');
      trophy.style.display = 'block';
      sfxVictory();
      Music.victory();
      createConfetti();
    } else {
      winnerText = t('draw');
      trophy.style.display = 'none';
      sfxDraw();
      Music.draw();
    }
    document.getElementById('res-winner').textContent = winnerText;

    // Save result (fire-and-forget)
    saveGameResult();

    // Save scores for "Consistent" achievement in next game
    try {
      localStorage.setItem('brainblitz_prev_scores', JSON.stringify({
        burden: players.burden.score,
        stu: players.stu.score
      }));
    } catch(e) {}

    // Check and display achievements (fire-and-forget)
    checkAndShowAchievements();

    showScreen('results');
  }

  // ═══════════════════════════════════════
  //  PERSISTENCE (Cloudflare KV)
  // ═══════════════════════════════════════
  async function loadLifetimeStats() {
    try {
      const res = await fetch('/api/scores', { signal: AbortSignal.timeout(5000) });
      if (res.ok) {
        lifetimeStats = await res.json();
        updateTitleWins();
        updateLeaderboard();
      }
    } catch(e) {
      // Game works without persistence
    }
  }

  function updateTitleWins() {
    if (!lifetimeStats) return;
    const bWins = (lifetimeStats.burden && lifetimeStats.burden.wins) || 0;
    const sWins = (lifetimeStats.stu && lifetimeStats.stu.wins) || 0;
    document.getElementById('title-burden-wins').textContent = `BURDEN: ${bWins}`;
    document.getElementById('title-stu-wins').textContent = `STU: ${sWins}`;
    document.getElementById('lifetime-wins').style.opacity = '1';
  }

  function updateLeaderboard() {
    if (!lifetimeStats) {
      document.getElementById('lb-content').style.display = 'none';
      document.getElementById('lb-no-data').style.display = 'block';
      return;
    }

    const b = lifetimeStats.burden || {};
    const s = lifetimeStats.stu || {};

    const hasData = (b.gamesPlayed || 0) > 0 || (s.gamesPlayed || 0) > 0;
    document.getElementById('lb-content').style.display = hasData ? 'flex' : 'none';
    document.getElementById('lb-no-data').style.display = hasData ? 'none' : 'block';

    // Check if leaderboard is currently visible for counter animation
    const isVisible = document.getElementById('screen-leaderboard').classList.contains('active');
    const dur = isVisible ? 600 : 0;

    const setLB = (id, val) => {
      const el = document.getElementById(id);
      if (dur > 0 && val > 0) { animateCounter(el, val, dur); }
      else { el.textContent = formatScore(val); }
    };

    setLB('lb-burden-wins', b.wins || 0);
    setLB('lb-burden-games', b.gamesPlayed || 0);
    setLB('lb-burden-draws', b.draws || 0);
    setLB('lb-burden-total', b.totalScore || 0);
    setLB('lb-burden-correct', b.totalCorrect || 0);
    setLB('lb-burden-best', b.bestGameScore || 0);
    setLB('lb-burden-streak', b.bestStreak || 0);

    setLB('lb-stu-wins', s.wins || 0);
    setLB('lb-stu-games', s.gamesPlayed || 0);
    setLB('lb-stu-draws', s.draws || 0);
    setLB('lb-stu-total', s.totalScore || 0);
    setLB('lb-stu-correct', s.totalCorrect || 0);
    setLB('lb-stu-best', s.bestGameScore || 0);
    setLB('lb-stu-streak', s.bestStreak || 0);
  }

  async function saveGameResult() {
    const isDraw = players.burden.score === players.stu.score;
    const burdenWon = players.burden.score > players.stu.score;

    try {
      await fetch('/api/scores', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          player: 'burden',
          won: burdenWon && !isDraw,
          draw: isDraw,
          score: players.burden.score,
          correct: players.burden.correctCount,
          bestStreak: players.burden.bestStreak
        }),
        signal: AbortSignal.timeout(5000)
      });

      await fetch('/api/scores', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({
          player: 'stu',
          won: !burdenWon && !isDraw,
          draw: isDraw,
          score: players.stu.score,
          correct: players.stu.correctCount,
          bestStreak: players.stu.bestStreak
        }),
        signal: AbortSignal.timeout(5000)
      });

      // Refresh stats after saving
      await loadLifetimeStats();
    } catch(e) {
      // Silently fail — game works without persistence
    }
  }

  // ═══════════════════════════════════════
  //  TTS (ElevenLabs via Cloudflare proxy)
  // ═══════════════════════════════════════
  async function playQuestionTTS(text) {
    if (!voiceEnabled) return false;
    try {
      const res = await fetch('/api/tts', {
        method: 'POST',
        headers: { 'Content-Type': 'application/json' },
        body: JSON.stringify({ text, voice_id: voiceId }),
        signal: AbortSignal.timeout(6000)
      });
      if (!res.ok) return false;
      const blob = await res.blob();
      const url = URL.createObjectURL(blob);
      const audio = new Audio(url);
      audio.volume = 0.5;
      return new Promise(resolve => {
        audio.onended = () => { URL.revokeObjectURL(url); resolve(true); };
        audio.onerror = () => { URL.revokeObjectURL(url); resolve(false); };
        audio.play().catch(() => { URL.revokeObjectURL(url); resolve(false); });
      });
    } catch(e) {
      return false;
    }
  }

  // ═══════════════════════════════════════
  //  ACHIEVEMENTS SYSTEM
  // ═══════════════════════════════════════
  var ACHIEVEMENTS = [
    {
      id: 'perfect_game',
      name: 'Perfect Game',
      icon: '\u2B50',
      description: 'Answer all questions correctly in one game',
      check: function(player, opponent, sett, stats, playerKey) {
        var totalPlayerQs = Math.ceil(sett.rounds / 2);
        if (playerKey === 'stu') totalPlayerQs = Math.floor(sett.rounds / 2);
        return player.correctCount === totalPlayerQs && totalPlayerQs > 0;
      }
    },
    {
      id: 'comeback_kid',
      name: 'Comeback Kid',
      icon: '\uD83D\uDD25',
      description: 'Win after being behind by 200+ points',
      check: function(player, opponent, sett, stats, playerKey) {
        var won = player.score > opponent.score;
        if (!won) return false;
        var isBurden = playerKey === 'burden';
        for (var i = 0; i < gameTracker.scoreDiffs.length; i++) {
          var diff = gameTracker.scoreDiffs[i];
          if (isBurden && diff <= -200) return true;
          if (!isBurden && diff >= 200) return true;
        }
        return false;
      }
    },
    {
      id: 'speed_demon',
      name: 'Speed Demon',
      icon: '\u26A1',
      description: 'Answer 5+ questions correctly in under 3 seconds each',
      check: function(player, opponent, sett, stats, playerKey) {
        return gameTracker.fastAnswers[playerKey] >= 5;
      }
    },
    {
      id: 'streak_master',
      name: 'Streak Master',
      icon: '\uD83D\uDD25',
      description: 'Get a streak of 7 or more in a single game',
      check: function(player, opponent, sett, stats) {
        return player.bestStreak >= 7;
      }
    },
    {
      id: 'shut_out',
      name: 'Shut Out',
      icon: '\uD83D\uDEAB',
      description: 'Win with your opponent scoring 0 points',
      check: function(player, opponent, sett, stats) {
        return player.score > 0 && opponent.score === 0;
      }
    },
    {
      id: 'sharp_shooter',
      name: 'Sharp Shooter',
      icon: '\uD83C\uDFAF',
      description: 'Win with 90%+ accuracy',
      check: function(player, opponent, sett, stats, playerKey) {
        var totalPlayerQs = Math.ceil(sett.rounds / 2);
        if (playerKey === 'stu') totalPlayerQs = Math.floor(sett.rounds / 2);
        if (totalPlayerQs < 3) return false;
        var accuracy = player.correctCount / totalPlayerQs;
        return accuracy >= 0.9 && player.score > opponent.score;
      }
    },
    {
      id: 'century',
      name: 'Century',
      icon: '\uD83D\uDCAF',
      description: 'Score 1000+ points in a single game',
      check: function(player, opponent, sett, stats) {
        return player.score >= 1000;
      }
    },
    {
      id: 'veteran',
      name: 'Veteran',
      icon: '\uD83C\uDF96\uFE0F',
      description: 'Play 10 games total',
      check: function(player, opponent, sett, stats) {
        return stats && stats.gamesPlayed >= 10;
      }
    },
    {
      id: 'braai_master',
      name: 'Braai Master',
      icon: '\uD83E\uDD69',
      description: 'Win 5 games total',
      check: function(player, opponent, sett, stats) {
        return stats && stats.wins >= 5;
      }
    },
    {
      id: 'underdog',
      name: 'Underdog',
      icon: '\uD83D\uDC15',
      description: 'Win as the player who answered second more often',
      check: function(player, opponent, sett, stats, playerKey) {
        var won = player.score > opponent.score;
        if (!won) return false;
        var secondCount = 0;
        for (var i = 0; i < gameTracker.secondAnswerers.length; i++) {
          if (gameTracker.secondAnswerers[i] === playerKey) secondCount++;
        }
        return secondCount > (gameTracker.secondAnswerers.length / 2);
      }
    },
    {
      id: 'blitz',
      name: 'Blitz',
      icon: '\uD83D\uDCA8',
      description: 'Answer a question correctly in under 1 second',
      check: function(player, opponent, sett, stats, playerKey) {
        return gameTracker.blitzAnswers[playerKey] === true;
      }
    },
    {
      id: 'consistent',
      name: 'Consistent',
      icon: '\uD83D\uDD01',
      description: 'Get the same score in two consecutive games',
      check: function(player, opponent, sett, stats, playerKey) {
        var prevScore = gameTracker.previousScores[playerKey];
        return prevScore !== null && prevScore === player.score && player.score > 0;
      }
    },
    {
      id: 'marathon',
      name: 'Marathon',
      icon: '\uD83C\uDFC3',
      description: 'Play a 20-round game',
      check: function(player, opponent, sett, stats) {
        return sett.rounds >= 20;
      }
    },
    {
      id: 'nail_biter',
      name: 'Nail Biter',
      icon: '\uD83D\uDE2C',
      description: 'Win a game by less than 50 points',
      check: function(player, opponent, sett, stats) {
        var diff = player.score - opponent.score;
        return diff > 0 && diff < 50;
      }
    },
    {
      id: 'domination',
      name: 'Domination',
      icon: '\uD83D\uDC51',
      description: 'Win by 500+ points',
      check: function(player, opponent, sett, stats) {
        return (player.score - opponent.score) >= 500;
      }
    }
  ];

  // Sound effect for achievement unlock
  function sfxAchievement() {
    if (ElevenAudio.playSfx('achievement')) return;
    playTone(880, 0.15, 'sine', 0.10);
    setTimeout(function() { playTone(1109, 0.15, 'sine', 0.10); }, 100);
    setTimeout(function() { playTone(1319, 0.25, 'sine', 0.12); }, 200);
    setTimeout(function() { playTone(1760, 0.4, 'sine', 0.10); }, 350);
  }

  // Load achievements from KV for both players
  function loadAchievements(callback) {
    fetch('/api/achievements', { signal: AbortSignal.timeout(5000) })
      .then(function(res) {
        if (res.ok) return res.json();
        throw new Error('Failed');
      })
      .then(function(data) {
        achievementCache.burden = data.burden || { earned: [], history: [] };
        achievementCache.stu = data.stu || { earned: [], history: [] };
        if (callback) callback();
      })
      .catch(function() {
        if (!achievementCache.burden) achievementCache.burden = { earned: [], history: [] };
        if (!achievementCache.stu) achievementCache.stu = { earned: [], history: [] };
        if (callback) callback();
      });
  }

  // Check achievements for one player, return array of newly earned achievement objects
  function checkPlayerAchievements(playerKey) {
    var player = players[playerKey];
    var opponentKey = playerKey === 'burden' ? 'stu' : 'burden';
    var opponent = players[opponentKey];
    var cached = achievementCache[playerKey];
    var earned = (cached && cached.earned) ? cached.earned : [];
    var stats = lifetimeStats ? lifetimeStats[playerKey] : null;
    var newlyEarned = [];

    for (var i = 0; i < ACHIEVEMENTS.length; i++) {
      var ach = ACHIEVEMENTS[i];
      if (earned.indexOf(ach.id) !== -1) continue;
      try {
        if (ach.check(player, opponent, settings, stats, playerKey)) {
          newlyEarned.push(ach);
        }
      } catch(e) {
        // Skip check errors
      }
    }

    return newlyEarned;
  }

  // Save newly earned achievements to KV
  function saveAchievements(playerKey, achievementIds) {
    if (achievementIds.length === 0) return;
    fetch('/api/achievements', {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ player: playerKey, achievements: achievementIds }),
      signal: AbortSignal.timeout(5000)
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.achievements) {
        achievementCache[playerKey] = data.achievements;
      }
    })
    .catch(function() {
      // Silently fail
    });
  }

  // Master function: check both players and show toasts
  function checkAndShowAchievements() {
    setTimeout(function() {
      var allNew = [];

      var burdenNew = checkPlayerAchievements('burden');
      var burdenIds = [];
      for (var i = 0; i < burdenNew.length; i++) {
        burdenIds.push(burdenNew[i].id);
        allNew.push({ achievement: burdenNew[i], playerKey: 'burden' });
        if (achievementCache.burden) achievementCache.burden.earned.push(burdenNew[i].id);
      }
      saveAchievements('burden', burdenIds);

      var stuNew = checkPlayerAchievements('stu');
      var stuIds = [];
      for (var j = 0; j < stuNew.length; j++) {
        stuIds.push(stuNew[j].id);
        allNew.push({ achievement: stuNew[j], playerKey: 'stu' });
        if (achievementCache.stu) achievementCache.stu.earned.push(stuNew[j].id);
      }
      saveAchievements('stu', stuIds);

      for (var k = 0; k < allNew.length; k++) {
        (function(item, delay) {
          setTimeout(function() {
            showAchievementToast(item.achievement, item.playerKey);
          }, delay);
        })(allNew[k], k * 800);
      }
    }, 1500);
  }

  // Show a single achievement toast notification
  function showAchievementToast(achievement, playerKey) {
    sfxAchievement();

    var container = document.getElementById('achievement-toast-container');
    var toast = document.createElement('div');
    toast.className = 'achievement-toast';

    var playerName = playerKey === 'burden' ? 'Burden' : 'Stu';
    var playerColor = playerKey === 'burden' ? 'var(--neon-cyan)' : 'var(--neon-pink)';

    toast.innerHTML =
      '<div class="achievement-toast-icon">' + achievement.icon + '</div>' +
      '<div class="achievement-toast-info">' +
        '<div class="achievement-toast-label">Achievement Unlocked \u2022 <span style="color:' + playerColor + ';">' + playerName + '</span></div>' +
        '<div class="achievement-toast-name">' + achievement.name + '</div>' +
        '<div class="achievement-toast-desc">' + achievement.description + '</div>' +
      '</div>';

    container.appendChild(toast);

    setTimeout(function() { toast.classList.add('show'); }, 50);

    setTimeout(function() {
      toast.classList.remove('show');
      toast.classList.add('hide');
      setTimeout(function() {
        if (toast.parentNode) toast.parentNode.removeChild(toast);
      }, 400);
    }, 4000);
  }

  // Render the achievements gallery screen
  function renderAchievementsScreen() {
    var grid = document.getElementById('achievements-grid');
    grid.innerHTML = '';

    var burdenEarned = (achievementCache.burden && achievementCache.burden.earned) ? achievementCache.burden.earned : [];
    var stuEarned = (achievementCache.stu && achievementCache.stu.earned) ? achievementCache.stu.earned : [];

    for (var i = 0; i < ACHIEVEMENTS.length; i++) {
      var ach = ACHIEVEMENTS[i];
      var bHas = burdenEarned.indexOf(ach.id) !== -1;
      var sHas = stuEarned.indexOf(ach.id) !== -1;
      var isEarned = bHas || sHas;

      var card = document.createElement('div');
      card.className = 'achievement-card ' + (isEarned ? 'earned' : 'locked');

      var playersHtml = '';
      if (bHas) playersHtml += '<span class="achievement-card-player burden-badge">Burden</span>';
      if (sHas) playersHtml += '<span class="achievement-card-player stu-badge">Stu</span>';
      if (!isEarned) playersHtml = '<span style="font-family:Orbitron,monospace;font-size:10px;color:rgba(255,255,255,0.2);letter-spacing:0.1em;">\uD83D\uDD12 LOCKED</span>';

      card.innerHTML =
        '<span class="achievement-card-icon">' + (isEarned ? ach.icon : '\uD83D\uDD12') + '</span>' +
        '<div class="achievement-card-name">' + ach.name + '</div>' +
        '<div class="achievement-card-desc">' + ach.description + '</div>' +
        '<div class="achievement-card-players">' + playersHtml + '</div>';

      grid.appendChild(card);
    }

    if (!achievementCache.burden && !achievementCache.stu) {
      grid.innerHTML = '<div style="grid-column:1/-1;text-align:center;color:rgba(255,255,255,0.3);font-family:Rajdhani,sans-serif;font-size:20px;">Loading achievements...</div>';
      loadAchievements(function() { renderAchievementsScreen(); });
    }
  }


  // ═══════════════════════════════════════
  //  ADMIN PIN & PANEL
  // ═══════════════════════════════════════
  var PIN_CODE = '1945';
  var pinBuffer = '';

  function pinDigit(d) {
    if (pinBuffer.length >= 4) return;
    pinBuffer += String(d);
    updatePinDots();
    sfxClick();

    if (pinBuffer.length === 4) {
      if (pinBuffer === PIN_CODE) {
        // Correct PIN — go to admin
        setTimeout(function() {
          pinBuffer = '';
          updatePinDots();
          showScreen('admin');
          loadAdminTTS();
          loadAdminAudio();
        }, 250);
      } else {
        // Wrong PIN — shake and reset
        var dots = [].slice.call(document.querySelectorAll('.pin-dot'));
        dots.forEach(function(d) { d.classList.add('error'); });
        sfxWrong();
        setTimeout(function() {
          pinBuffer = '';
          dots.forEach(function(d) {
            d.classList.remove('error');
            d.classList.remove('filled');
          });
        }, 600);
      }
    }
  }

  function pinClear() {
    pinBuffer = pinBuffer.slice(0, -1);
    updatePinDots();
  }

  function updatePinDots() {
    for (var i = 0; i < 4; i++) {
      var dot = document.getElementById('pin-dot-' + i);
      if (i < pinBuffer.length) {
        dot.classList.add('filled');
      } else {
        dot.classList.remove('filled');
      }
    }
  }

  function loadAdminTTS() {
    var loadingEl = document.getElementById('admin-tts-loading');
    var statsEl = document.getElementById('admin-tts-stats');
    var errorEl = document.getElementById('admin-tts-error');

    loadingEl.style.display = 'block';
    statsEl.style.display = 'none';
    errorEl.style.display = 'none';

    fetch('/api/tts-usage', { signal: AbortSignal.timeout(5000) })
      .then(function(res) { return res.ok ? res.json() : Promise.reject('bad response'); })
      .then(function(data) {
        loadingEl.style.display = 'none';
        statsEl.style.display = 'block';

        var totalChars = data.totalChars || 0;
        var totalReqs = data.totalRequests || 0;
        // ElevenLabs pricing: ~$0.18 per 1000 chars (Turbo v2.5)
        var estCostUSD = (totalChars / 1000) * 0.18;
        // Convert to ZAR (~18.50 ZAR per USD)
        var USD_TO_ZAR = 18.50;
        var estCostZAR = estCostUSD * USD_TO_ZAR;
        var avgChars = totalReqs > 0 ? Math.round(totalChars / totalReqs) : 0;
        var avgCostZAR = totalReqs > 0 ? (estCostZAR / totalReqs) : 0;

        document.getElementById('admin-tts-chars').textContent = formatScore(totalChars);
        document.getElementById('admin-tts-requests').textContent = formatScore(totalReqs);
        document.getElementById('admin-tts-cost').textContent = 'R' + estCostZAR.toFixed(2);
        document.getElementById('admin-tts-avg-cost').textContent = 'R' + avgCostZAR.toFixed(2);
        document.getElementById('admin-tts-avg').textContent = formatScore(avgChars);
      })
      .catch(function() {
        loadingEl.style.display = 'none';
        errorEl.style.display = 'block';
      });
  }

  // ═══════════════════════════════════════
  //  ADMIN: AUDIO ASSETS (ElevenLabs Music + SFX)
  // ═══════════════════════════════════════
  var audioGenerating = false;

  function loadAdminAudio() {
    var loadingEl = document.getElementById('admin-audio-loading');
    var contentEl = document.getElementById('admin-audio-content');
    var errorEl = document.getElementById('admin-audio-error');

    loadingEl.style.display = 'block';
    contentEl.style.display = 'none';
    errorEl.style.display = 'none';

    Promise.all([
      fetch('/api/music?status=true', { signal: AbortSignal.timeout(8000) }).then(function(r) { return r.ok ? r.json() : {}; }).catch(function() { return {}; }),
      fetch('/api/sfx?status=true', { signal: AbortSignal.timeout(8000) }).then(function(r) { return r.ok ? r.json() : {}; }).catch(function() { return {}; })
    ]).then(function(results) {
      loadingEl.style.display = 'none';
      contentEl.style.display = 'block';
      renderAudioAssetList('admin-music-list', results[0], 'music');
      renderAudioAssetList('admin-sfx-list', results[1], 'sfx');
    }).catch(function() {
      loadingEl.style.display = 'none';
      errorEl.style.display = 'block';
      errorEl.textContent = 'Could not load audio asset status';
    });
  }

  function formatFileSize(bytes) {
    if (!bytes) return '0 B';
    if (bytes < 1024) return bytes + ' B';
    if (bytes < 1048576) return (bytes / 1024).toFixed(1) + ' KB';
    return (bytes / 1048576).toFixed(1) + ' MB';
  }

  function renderAudioAssetList(containerId, statusMap, type) {
    var container = document.getElementById(containerId);
    var names = Object.keys(statusMap);
    if (names.length === 0) {
      container.innerHTML = '<div style="color:rgba(255,255,255,0.25); font-family:Rajdhani,sans-serif; font-size:14px; padding:8px 0;">API not available</div>';
      return;
    }
    var html = '';
    names.forEach(function(name) {
      var meta = statusMap[name];
      var statusColor = meta ? 'var(--neon-green)' : 'rgba(255,255,255,0.35)';
      var statusText = meta ? formatFileSize(meta.size_bytes) : 'Not generated';
      var label = meta ? (meta.label || name) : name;
      var btnLabel = meta ? 'Regen' : 'Generate';

      html += '<div class="admin-stat-row" id="audio-row-' + type + '-' + name + '">' +
        '<span class="admin-stat-label" style="flex:1;">' + label + ' <span style="opacity:0.4;">(' + name + ')</span></span>' +
        '<span id="audio-status-' + type + '-' + name + '" style="font-family:Orbitron,monospace; font-size:clamp(11px,1.1vw,13px); color:' + statusColor + '; margin-right:12px;">' + statusText + '</span>' +
        '<button class="btn" onclick="generateSingleAudio(\'' + type + '\',\'' + name + '\')" id="btn-gen-' + type + '-' + name + '" style="font-size:10px; padding:5px 12px; min-width:auto; letter-spacing:0.05em;">' + btnLabel + '</button>' +
      '</div>';
    });
    container.innerHTML = html;
  }

  function generateSingleAudio(type, name) {
    if (audioGenerating) return;
    audioGenerating = true;
    var btn = document.getElementById('btn-gen-' + type + '-' + name);
    var statusEl = document.getElementById('audio-status-' + type + '-' + name);
    if (btn) { btn.textContent = '...'; btn.style.pointerEvents = 'none'; btn.style.opacity = '0.4'; }
    if (statusEl) { statusEl.textContent = 'Generating...'; statusEl.style.color = 'var(--neon-yellow)'; }

    var url = type === 'music' ? '/api/music' : '/api/sfx';
    fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name }),
      signal: AbortSignal.timeout(300000) // 5 min timeout for music generation
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      audioGenerating = false;
      if (data.ok) {
        if (statusEl) { statusEl.textContent = formatFileSize(data.meta.size_bytes); statusEl.style.color = 'var(--neon-green)'; }
        if (btn) { btn.textContent = 'Regen'; btn.style.pointerEvents = ''; btn.style.opacity = ''; }
        // Reload the audio into ElevenAudio cache
        ElevenAudio._fetchAudio('/api/' + type + '?name=' + name).then(function(buf) {
          if (buf) {
            if (type === 'music') ElevenAudio.music[name] = buf;
            else ElevenAudio.sfx[name] = buf;
          }
        });
      } else {
        var errMsg = data.error || 'Failed';
        if (data.detail) errMsg += ': ' + (typeof data.detail === 'string' ? data.detail.substring(0, 120) : JSON.stringify(data.detail).substring(0, 120));
        if (statusEl) { statusEl.textContent = errMsg; statusEl.style.color = 'var(--neon-pink)'; }
        if (btn) { btn.textContent = 'Retry'; btn.style.pointerEvents = ''; btn.style.opacity = ''; }
      }
    })
    .catch(function(e) {
      audioGenerating = false;
      if (statusEl) { statusEl.textContent = 'Error: ' + (e.message || 'Unknown'); statusEl.style.color = 'var(--neon-pink)'; }
      if (btn) { btn.textContent = 'Retry'; btn.style.pointerEvents = ''; btn.style.opacity = ''; }
    });
  }

  async function generateAllMusic() {
    if (audioGenerating) return;
    audioGenerating = true;
    var progressEl = document.getElementById('admin-audio-progress');
    var progressText = document.getElementById('admin-audio-progress-text');
    progressEl.style.display = 'block';

    var names = ['title', 'game', 'victory', 'draw'];
    for (var i = 0; i < names.length; i++) {
      progressText.textContent = 'Generating music: ' + names[i] + ' (' + (i + 1) + '/' + names.length + ')...';
      await generateSingleAudioAsync('music', names[i]);
    }
    progressEl.style.display = 'none';
    audioGenerating = false;
  }

  async function generateAllSfx() {
    if (audioGenerating) return;
    audioGenerating = true;
    var progressEl = document.getElementById('admin-audio-progress');
    var progressText = document.getElementById('admin-audio-progress-text');
    progressEl.style.display = 'block';

    var names = ElevenAudio.SFX_NAMES;
    for (var i = 0; i < names.length; i++) {
      progressText.textContent = 'Generating SFX: ' + names[i] + ' (' + (i + 1) + '/' + names.length + ')...';
      await generateSingleAudioAsync('sfx', names[i]);
    }
    progressEl.style.display = 'none';
    audioGenerating = false;
  }

  function generateSingleAudioAsync(type, name) {
    var btn = document.getElementById('btn-gen-' + type + '-' + name);
    var statusEl = document.getElementById('audio-status-' + type + '-' + name);
    if (btn) { btn.textContent = '...'; btn.style.pointerEvents = 'none'; btn.style.opacity = '0.4'; }
    if (statusEl) { statusEl.textContent = 'Generating...'; statusEl.style.color = 'var(--neon-yellow)'; }

    var url = type === 'music' ? '/api/music' : '/api/sfx';
    return fetch(url, {
      method: 'POST',
      headers: { 'Content-Type': 'application/json' },
      body: JSON.stringify({ name: name }),
      signal: AbortSignal.timeout(300000)
    })
    .then(function(res) { return res.json(); })
    .then(function(data) {
      if (data.ok) {
        if (statusEl) { statusEl.textContent = formatFileSize(data.meta.size_bytes); statusEl.style.color = 'var(--neon-green)'; }
        if (btn) { btn.textContent = 'Regen'; btn.style.pointerEvents = ''; btn.style.opacity = ''; }
        return ElevenAudio._fetchAudio('/api/' + type + '?name=' + name).then(function(buf) {
          if (buf) {
            if (type === 'music') ElevenAudio.music[name] = buf;
            else ElevenAudio.sfx[name] = buf;
          }
        });
      } else {
        var errMsg2 = data.error || 'Failed';
        if (data.detail) errMsg2 += ': ' + (typeof data.detail === 'string' ? data.detail.substring(0, 120) : JSON.stringify(data.detail).substring(0, 120));
        if (statusEl) { statusEl.textContent = errMsg2; statusEl.style.color = 'var(--neon-pink)'; }
        if (btn) { btn.textContent = 'Retry'; btn.style.pointerEvents = ''; btn.style.opacity = ''; }
      }
    })
    .catch(function(e2) {
      if (statusEl) { statusEl.textContent = 'Error: ' + (e2.message || 'Unknown'); statusEl.style.color = 'var(--neon-pink)'; }
      if (btn) { btn.textContent = 'Retry'; btn.style.pointerEvents = ''; btn.style.opacity = ''; }
    });
  }

  // ═══════════════════════════════════════
  //  LANGUAGE SYSTEM
  // ═══════════════════════════════════════
  var gameLang = 'en';
  var LANG = {
    en: {
      titleSub: 'Lekker TV Trivia',
      letsPlay: "Let's Play!",
      howToPlay: 'How to Play',
      leaderboard: 'Leaderboard',
      achievements: 'Achievements',
      gameSetup: 'Game Setup',
      category: 'Category',
      timer: 'Timer',
      rounds: 'Rounds',
      voice: 'Voice',
      play: 'Play!',
      back: 'Back',
      home: 'Home',
      question: 'Question',
      difficulty: 'Difficulty',
      currentPlayer: 'Current Player',
      correct: 'Correct',
      bestStreak: 'Best Streak',
      finalScore: 'Final Score',
      playAgain: 'Play Again!',
      loadingQuestions: 'LOADING QUESTIONS...',
      correctFb: ['Lekker!', 'Ja Boet!', 'Kwaai!', 'Sjoe!', 'Yoh Nailed It!', 'Eish, Too Easy!', 'Baie Mooi!', "Jy's 'n Bees!", 'Sharp Sharp!'],
      wrongFb: ['Eina!', 'Ag Nee!', 'Haibo!', 'Shame Man!', 'Dis Verkeerd!', 'Yoh!', 'Aikona!'],
      timeoutFb: 'Tyd Op, Bru!',
      burdenWins: 'BURDEN WINS! Lekker Gespeel!',
      stuWins: "STU WINS! Jy's die Boss!",
      draw: "IT'S A DRAW! Sharp Sharp!",
      gamesPlayed: 'Games Played',
      wins: 'Wins',
      draws: 'Draws',
      totalScore: 'Total Score',
      bestGame: 'Best Game',
      onFire: 'ON FIRE!'
    },
    af: {
      titleSub: 'Lekker TV-Vasvra',
      letsPlay: 'Kom Ons Speel!',
      howToPlay: 'Hoe Om Te Speel',
      leaderboard: 'Puntestand',
      achievements: 'Prestasies',
      gameSetup: 'Spel-Instellings',
      category: 'Kategorie',
      timer: 'Tydhouer',
      rounds: 'Rondtes',
      voice: 'Stem',
      play: 'Speel!',
      back: 'Terug',
      home: 'Huis Toe',
      question: 'Vraag',
      difficulty: 'Moeilikheid',
      currentPlayer: 'Huidige Speler',
      correct: 'Korrek',
      bestStreak: 'Beste Reeks',
      finalScore: 'Finale Telling',
      playAgain: 'Speel Weer!',
      loadingQuestions: 'LAAI VRAE...',
      correctFb: ['Lekker!', 'Ja Boet!', 'Kwaai!', 'Sjoe!', 'Mooi Man!', 'Te Maklik!', 'Baie Mooi!', "Jy's 'n Bees!", 'Sharp Sharp!', "Nou Gaan Ons Braai!"],
      wrongFb: ['Eina!', 'Ag Nee!', 'Haibo!', 'Skande!', 'Dis Verkeerd!', 'Yoh!', 'Aikona!', 'Sies Man!'],
      timeoutFb: 'Tyd Op, Bru!',
      burdenWins: 'BURDEN WEN! Lekker Gespeel!',
      stuWins: "STU WEN! Jy's die Baas!",
      draw: "GELYKOP! Sharp Sharp!",
      gamesPlayed: 'Spelle Gespeel',
      wins: 'Oorwinnings',
      draws: 'Gelykop',
      totalScore: 'Totale Punte',
      bestGame: 'Beste Spel',
      onFire: 'OP VUUR!'
    }
  };

  function t(key) {
    return LANG[gameLang][key] || LANG.en[key] || key;
  }

  function applyLanguage() {
    // Title screen
    document.querySelector('.title-sub').textContent = t('titleSub');
    var titleBtns = document.querySelectorAll('#screen-title .btn-group .btn');
    if (titleBtns[0]) titleBtns[0].textContent = t('letsPlay');
    if (titleBtns[1]) titleBtns[1].textContent = t('howToPlay');
    if (titleBtns[2]) titleBtns[2].textContent = t('leaderboard');

    // Settings screen
    var settingsTitle = document.querySelector('#screen-settings .screen-title');
    if (settingsTitle) settingsTitle.textContent = t('gameSetup');
    var settingLabels = document.querySelectorAll('#screen-settings .setting-group > label');
    var labelKeys = ['category', 'timer', 'rounds', 'voice'];
    for (var i = 0; i < settingLabels.length && i < labelKeys.length; i++) {
      settingLabels[i].textContent = t(labelKeys[i]);
    }
    var settingsBtns = document.querySelectorAll('#screen-settings .btn-group .btn');
    if (settingsBtns[0]) settingsBtns[0].textContent = t('back');
    if (settingsBtns[1]) settingsBtns[1].textContent = t('play');

    // How to play
    var howtoTitle = document.querySelector('#screen-howto .screen-title');
    if (howtoTitle) howtoTitle.textContent = t('howToPlay');

    // Leaderboard
    var lbTitle = document.querySelector('#screen-leaderboard .screen-title');
    if (lbTitle) lbTitle.textContent = t('leaderboard');

    // Achievements
    var achTitle = document.querySelector('#screen-achievements .screen-title');
    if (achTitle) achTitle.textContent = t('achievements');

    // Results labels
    var resLabel = document.querySelector('.results-label');
    if (resLabel) resLabel.textContent = t('finalScore');
    var playAgainBtn = document.querySelector('#screen-results .btn:not(.pink)');
    if (playAgainBtn) playAgainBtn.textContent = t('playAgain');

    // HUD labels
    var hudLabels = document.querySelectorAll('.game-hud .hud-label');
    var hudKeys = ['question', 'difficulty', 'currentPlayer'];
    for (var j = 0; j < hudLabels.length && j < hudKeys.length; j++) {
      hudLabels[j].textContent = t(hudKeys[j]);
    }

    // ON FIRE overlay text
    var fireText = document.querySelector('#on-fire-overlay .fire-text');
    if (fireText) fireText.textContent = t('onFire');

    // Loading screen
    var loadingText = document.querySelector('#screen-loading div');
    if (loadingText) loadingText.textContent = t('loadingQuestions');

    // Leaderboard labels
    var lbLabels = document.querySelectorAll('#screen-leaderboard .lb-label');
    var lbKeys = ['wins', 'gamesPlayed', 'draws', 'totalScore', 'correct', 'bestGame', 'bestStreak'];
    // Each column has 7 labels, pattern repeats for both columns
    for (var k = 0; k < lbLabels.length; k++) {
      var keyIdx = k % 7;
      if (keyIdx < lbKeys.length) lbLabels[k].textContent = t(lbKeys[keyIdx]);
    }

    // Results stat labels
    var resCorrectLabels = document.querySelectorAll('#screen-results .stat-label');
    if (resCorrectLabels[0]) resCorrectLabels[0].textContent = t('correct');
    if (resCorrectLabels[1]) resCorrectLabels[1].textContent = t('bestStreak');
    if (resCorrectLabels[2]) resCorrectLabels[2].textContent = t('correct');
    if (resCorrectLabels[3]) resCorrectLabels[3].textContent = t('bestStreak');

    // Home buttons throughout
    var homeButtons = document.querySelectorAll('#screen-leaderboard > .btn, #screen-achievements > .btn, #screen-admin > .btn');
    homeButtons.forEach(function(b) { b.textContent = t('home'); });

    // Save preference
    try { localStorage.setItem('brainblitz_lang', gameLang); } catch(e) {}
  }

  function restoreLang() {
    try {
      var saved = localStorage.getItem('brainblitz_lang');
      if (saved && LANG[saved]) {
        gameLang = saved;
        // Update admin lang pill selection
        var pills = [].slice.call(document.querySelectorAll('#lang-pills .pill'));
        pills.forEach(function(p) {
          p.classList.toggle('selected', p.dataset.val === gameLang);
        });
        applyLanguage();
      }
    } catch(e) {}
  }

  // ═══════════════════════════════════════
  //  KEYBOARD & REMOTE SUPPORT
  // ═══════════════════════════════════════
  document.addEventListener('keydown', (e) => {
    const key = e.key;

    // LG Back button (keyCode 461) or Escape
    if (e.keyCode === 461 || key === 'GoBack' || key === 'Escape') {
      e.preventDefault();
      handleBack();
      return;
    }

    // PIN screen digit entry via keyboard/remote
    if (document.getElementById('screen-pin').classList.contains('active')) {
      if (key >= '0' && key <= '9') {
        pinDigit(parseInt(key, 10));
        return;
      }
      if (key === 'Backspace' || key === 'Delete') {
        pinClear();
        return;
      }
    }

    // Arrow navigation
    if (['ArrowUp', 'ArrowDown', 'ArrowLeft', 'ArrowRight'].includes(key)) {
      e.preventDefault();
      handleArrowNav(key);
      return;
    }

    // Enter/OK triggers focused element
    if (key === 'Enter') {
      const focused = document.activeElement;
      if (focused && (focused.classList.contains('answer-btn') || focused.classList.contains('btn') || focused.classList.contains('pill'))) {
        focused.click();
      }
      return;
    }

    // A/B/C/D to select answers during game
    const upperKey = key.toUpperCase();
    if (['A','B','C','D'].includes(upperKey) && document.getElementById('screen-game').classList.contains('active')) {
      const idx = upperKey.charCodeAt(0) - 65;
      if (!answered && !ttsPlaying) {
        const btn = document.querySelector('.answer-btn[data-index="' + idx + '"]');
        if (btn) selectAnswer(btn);
      }
    }
  });

  function handleBack() {
    const active = document.querySelector('.screen.active');
    if (!active) return;
    switch(active.id) {
      case 'screen-howto':
      case 'screen-settings':
      case 'screen-leaderboard':
      case 'screen-achievements':
      case 'screen-results':
      case 'screen-error':
      case 'screen-pin':
      case 'screen-admin':
        showScreen('title');
        break;
      // During game — don't navigate back (prevent accidental exit)
    }
  }

  function handleArrowNav(key) {
    const active = document.activeElement;
    const gameActive = document.getElementById('screen-game').classList.contains('active');

    // Navigate 2x2 answer grid during game
    if (gameActive && !answered && !ttsPlaying) {
      const btns = [].slice.call(document.querySelectorAll('#answers-grid .answer-btn'));
      const idx = btns.indexOf(active);
      if (idx === -1) { if (btns[0]) btns[0].focus(); return; }

      let newIdx = idx;
      switch(key) {
        case 'ArrowRight': newIdx = idx % 2 === 0 && idx + 1 < btns.length ? idx + 1 : idx; break;
        case 'ArrowLeft': newIdx = idx % 2 === 1 ? idx - 1 : idx; break;
        case 'ArrowDown': newIdx = idx + 2 < btns.length ? idx + 2 : idx; break;
        case 'ArrowUp': newIdx = idx - 2 >= 0 ? idx - 2 : idx; break;
      }
      if (btns[newIdx]) btns[newIdx].focus();
      return;
    }

    // For other screens: navigate between focusable elements
    const activeScreen = document.querySelector('.screen.active');
    if (!activeScreen) return;
    const focusables = [].slice.call(activeScreen.querySelectorAll('.btn, .pill, .answer-btn'));
    const curIdx = focusables.indexOf(active);
    if (curIdx === -1) { if (focusables[0]) focusables[0].focus(); return; }

    let next = curIdx;
    if (key === 'ArrowDown' || key === 'ArrowRight') next = Math.min(curIdx + 1, focusables.length - 1);
    if (key === 'ArrowUp' || key === 'ArrowLeft') next = Math.max(curIdx - 1, 0);
    if (focusables[next]) focusables[next].focus();
  }

  // Wire click sound to all menu buttons
  document.addEventListener('click', (e) => {
    if (e.target.closest('.btn')) sfxClick();
  });

  // Init: show cursor on mouse move
  document.addEventListener('mousemove', () => document.body.classList.add('show-cursor'));

  // Restore saved settings and load stats/achievements on page load
  restoreSettings();
  restoreLang();
  loadLifetimeStats();
  loadAchievements();
  // Load cached ElevenLabs audio assets (non-blocking)
  ElevenAudio.loadAll();
</script>

</body>
</html>
